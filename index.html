<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Atom Registry — Interchain Explorer</title>
<meta name="description" content="Production-grade frontend-only Cosmos blockchain explorer supporting 28+ chains.">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'><rect width='40' height='40' rx='8' fill='%23040d1a'/><circle cx='20' cy='20' r='15' stroke='%2300e5ff' stroke-width='1.5' fill='none'/><circle cx='20' cy='20' r='9' stroke='%2300e5ff' stroke-width='1' fill='none' opacity='.6'/><circle cx='20' cy='20' r='3.5' fill='%2300e5ff'/><ellipse cx='20' cy='20' rx='15' ry='5.5' stroke='%236c63ff' stroke-width='1' fill='none' opacity='.7' transform='rotate(-25 20 20)'/></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Syne:wght@400;600;700;800&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
:root{--bg0:#020810;--bg1:#040d1a;--bg2:#071525;--bg3:#0a1d33;--bg4:#0f2540;--border:rgba(0,229,255,0.12);--border2:rgba(0,229,255,0.06);--c:#00e5ff;--c2:#6c63ff;--c3:#ff6b6b;--c4:#ffd93d;--c5:#6bcb77;--c6:#ff9f1c;--dim:#2a4a6a;--txt:#8ab4c8;--txt2:#c8dde8;--txt3:#e8f4fc;--glow:0 0 24px rgba(0,229,255,0.35);--glow2:0 0 16px rgba(108,99,255,0.4);--mono:'JetBrains Mono',monospace;--ui:'Syne',sans-serif;--display:'Bebas Neue',sans-serif;--r:6px}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{background:var(--bg0);color:var(--txt2);font-family:var(--ui);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,229,255,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,255,0.025) 1px,transparent 1px);background-size:48px 48px;pointer-events:none;z-index:0}
body::after{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 70% 50% at 90% 10%,rgba(108,99,255,0.07) 0%,transparent 60%),radial-gradient(ellipse 50% 40% at 10% 90%,rgba(0,229,255,0.05) 0%,transparent 60%);pointer-events:none;z-index:0}
#topbar{position:sticky;top:0;z-index:200;background:rgba(2,8,16,0.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);height:56px;display:flex;align-items:center;gap:16px;padding:0 20px}
.logo{display:flex;align-items:center;gap:10px;text-decoration:none;flex-shrink:0}
.logo-mark{width:32px;height:32px;filter:drop-shadow(0 0 6px var(--c))}
.logo-text{font-family:var(--display);font-size:22px;letter-spacing:3px;color:var(--c);text-shadow:var(--glow);line-height:1}
.logo-sub{font-family:var(--mono);font-size:8px;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin-top:1px}
.net-pill{display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);cursor:pointer;position:relative;user-select:none;transition:border-color .15s;flex-shrink:0}
.net-pill:hover{border-color:var(--c)}
.net-pill .net-name{font-size:13px;font-weight:600;letter-spacing:.5px}
.net-pill .net-caret{font-size:9px;color:var(--dim);margin-left:2px;transition:transform .15s}
.net-pill[aria-expanded="true"] .net-caret{transform:rotate(180deg)}
.net-live{width:7px;height:7px;border-radius:50%;background:var(--c5);box-shadow:0 0 6px var(--c5);animation:blink 2s infinite}
.search-wrap{flex:1;max-width:520px;display:flex;align-items:center;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;transition:border-color .15s,box-shadow .15s}
.search-wrap:focus-within{border-color:var(--c);box-shadow:0 0 0 2px rgba(0,229,255,0.12)}
.search-ico{padding:0 12px;color:var(--dim);font-size:15px;flex-shrink:0}
#searchInput{flex:1;background:none;border:none;outline:none;color:var(--txt3);font-family:var(--mono);font-size:12px;padding:10px 0;letter-spacing:.3px}
#searchInput::placeholder{color:var(--dim)}
#searchBtn{padding:10px 16px;background:var(--c);color:var(--bg0);font-family:var(--ui);font-size:11px;font-weight:700;letter-spacing:1.5px;border:none;cursor:pointer;transition:background .15s;flex-shrink:0;white-space:nowrap}
#searchBtn:hover{background:#33eeff}
.topbar-stats{margin-left:auto;display:flex;align-items:center;gap:20px;flex-shrink:0}
.ts{display:flex;flex-direction:column;align-items:flex-end}
.ts-val{font-family:var(--mono);font-size:13px;color:var(--txt3);line-height:1}
.ts-lbl{font-size:9px;letter-spacing:1.5px;color:var(--dim);text-transform:uppercase;margin-top:2px}
.block-pill{display:flex;align-items:center;gap:8px;padding:5px 12px;background:rgba(0,229,255,0.06);border:1px solid rgba(0,229,255,0.18);border-radius:var(--r)}
.block-pill .bp-lbl{font-size:9px;letter-spacing:2px;color:var(--c);text-transform:uppercase}
.block-pill .bp-val{font-family:var(--mono);font-size:14px;color:var(--c);text-shadow:var(--glow);font-weight:700}
.dropdown{position:absolute;top:calc(100% + 8px);right:0;width:300px;max-height:420px;overflow-y:auto;background:var(--bg1);border:1px solid var(--border);border-radius:var(--r);z-index:300;display:none;box-shadow:0 16px 40px rgba(0,0,0,0.6)}
.dropdown.open{display:block}
.dd-filter{width:100%;padding:8px 14px;background:var(--bg2);border:none;border-bottom:1px solid var(--border2);color:var(--txt2);font-family:var(--mono);font-size:11px;outline:none}
.dd-filter::placeholder{color:var(--dim)}
.dd-option{display:flex;align-items:center;gap:10px;padding:9px 14px;font-size:12px;font-weight:600;cursor:pointer;transition:background .12s;border-bottom:1px solid var(--border2)}
.dd-option:last-child{border-bottom:none}
.dd-option:hover,.dd-option.active{background:rgba(0,229,255,0.06);color:var(--c)}
.dd-option.hidden{display:none}
.dd-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.dd-info{display:flex;flex-direction:column;gap:1px;min-width:0}
.dd-info span:first-child{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dd-sub{font-size:9px;font-weight:400;color:var(--dim);letter-spacing:.5px}
#app{position:relative;z-index:1;max-width:1600px;margin:0 auto;padding:20px 20px 60px}
#navTabs{display:flex;align-items:center;gap:2px;margin-bottom:20px;background:var(--bg1);border:1px solid var(--border);border-radius:var(--r);padding:4px;overflow-x:auto;scrollbar-width:none}
#navTabs::-webkit-scrollbar{display:none}
.nav-tab{padding:8px 18px;font-family:var(--ui);font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--dim);cursor:pointer;border-radius:4px;transition:all .15s;white-space:nowrap;border:1px solid transparent}
.nav-tab:hover{color:var(--txt2)}
.nav-tab.active{background:rgba(0,229,255,0.1);color:var(--c);border-color:rgba(0,229,255,0.2)}
.page{display:none}.page.active{display:block}
.metrics-strip{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin-bottom:20px}
.mc{background:var(--bg1);padding:14px 18px;transition:background .15s;cursor:default;position:relative}
.mc::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--c);transform:scaleX(0);transform-origin:left;transition:transform .25s ease}
.mc:hover{background:var(--bg2)}.mc:hover::after{transform:scaleX(1)}
.mc-lbl{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--dim);margin-bottom:6px}
.mc-val{font-family:var(--mono);font-size:18px;color:var(--txt3);line-height:1}
.mc-val.c{color:var(--c);text-shadow:var(--glow)}.mc-val.g{color:var(--c5)}.mc-val.y{color:var(--c4)}.mc-val.p{color:var(--c2)}
.mc-sub{font-size:10px;color:var(--dim);margin-top:3px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:16px}
.grid-65{display:grid;grid-template-columns:1.6fr 1fr;gap:16px;margin-bottom:16px}
.grid-56{display:grid;grid-template-columns:1fr 1.5fr;gap:16px;margin-bottom:16px}
.grid-full{margin-bottom:16px}
.panel{background:var(--bg1);border:1px solid var(--border);border-radius:var(--r);overflow:hidden}
.panel-hd{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;border-bottom:1px solid var(--border2);background:rgba(0,229,255,0.02)}
.panel-title{font-family:var(--display);font-size:14px;letter-spacing:3px;color:var(--c)}
.panel-badge{font-family:var(--mono);font-size:10px;padding:2px 8px;border:1px solid var(--border);border-radius:20px;color:var(--dim);letter-spacing:1px}
.live-tag{display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:9px;letter-spacing:1.5px;color:var(--c5)}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--c5);animation:blink 1.5s infinite}
.panel-link{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--c);cursor:pointer;text-decoration:none;transition:opacity .15s}
.panel-link:hover{opacity:.6}
.row{display:grid;padding:11px 18px;border-bottom:1px solid var(--border2);align-items:center;cursor:pointer;transition:background .12s;animation:fadeSlide .25s ease both;outline:none}
.row:last-child{border-bottom:none}
.row:hover{background:rgba(0,229,255,0.04)}
.row:focus-visible{box-shadow:0 0 0 2px rgba(0,229,255,0.25) inset}
.row-block{grid-template-columns:90px 1fr 70px 72px;gap:12px}
.bk-num{font-family:var(--mono);font-size:13px;color:var(--c);font-weight:700}
.bk-hash{font-family:var(--mono);font-size:10px;color:var(--dim)}
.bk-prop{font-size:10px;color:var(--dim);margin-top:2px}
.bk-txs{text-align:center}
.bk-time{font-family:var(--mono);font-size:10px;color:var(--dim);text-align:right}
.row-tx{grid-template-columns:140px 1fr 110px 74px;gap:12px}
.tx-hash{font-family:var(--mono);font-size:11px;color:var(--c)}
.tx-time2{font-family:var(--mono);font-size:10px;color:var(--dim);text-align:right}
.tx-amt{font-family:var(--mono);font-size:11px;text-align:right}
.badge{display:inline-block;padding:2px 8px;border-radius:3px;font-family:var(--mono);font-size:10px;font-weight:700;letter-spacing:.5px;white-space:nowrap}
.bt{background:rgba(0,229,255,0.08);color:var(--c);border:1px solid rgba(0,229,255,0.2)}
.bg{background:rgba(107,203,119,0.08);color:var(--c5);border:1px solid rgba(107,203,119,0.2)}
.bp{background:rgba(108,99,255,0.08);color:var(--c2);border:1px solid rgba(108,99,255,0.2)}
.by{background:rgba(255,217,61,0.08);color:var(--c4);border:1px solid rgba(255,217,61,0.2)}
.br{background:rgba(255,107,107,0.08);color:var(--c3);border:1px solid rgba(255,107,107,0.2)}
.bo{background:rgba(255,159,28,0.08);color:var(--c6);border:1px solid rgba(255,159,28,0.2)}
.bx{background:rgba(42,74,106,0.3);color:var(--dim);border:1px solid var(--border2)}
.row-val{grid-template-columns:28px 1fr 100px 80px 50px 80px;gap:12px}
.val-rank{font-family:var(--mono);font-size:10px;color:var(--dim);text-align:center}
.val-info{display:flex;align-items:center;gap:10px;min-width:0}
.val-av{width:30px;height:30px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:11px;font-weight:700;flex-shrink:0}
.val-nm{font-size:13px;font-weight:700;color:var(--txt3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.val-op{font-family:var(--mono);font-size:9px;color:var(--dim);margin-top:1px}
.val-vp-pct{font-family:var(--mono);font-size:12px;color:var(--txt2)}
.vp-bar{height:3px;background:var(--bg4);border-radius:2px;overflow:hidden;margin-top:4px}
.vp-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--c),var(--c2));transition:width 1s ease}
.val-comm{font-family:var(--mono);font-size:11px;color:var(--dim);text-align:center}
.sdot{width:8px;height:8px;border-radius:50%;display:inline-block}
.sdot.on{background:var(--c5);box-shadow:0 0 5px var(--c5);animation:blink 2s infinite}
.sdot.off{background:var(--c3)}
.prop-row{padding:14px 18px;border-bottom:1px solid var(--border2);cursor:pointer;transition:background .12s}
.prop-row:last-child{border-bottom:none}
.prop-row:hover{background:rgba(0,229,255,0.03)}
.prop-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.prop-id{font-family:var(--mono);font-size:10px;color:var(--dim)}
.prop-title{font-size:13px;font-weight:600;color:var(--txt3);margin-bottom:8px;line-height:1.4}
.prop-bar-wrap{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;margin-bottom:6px}
.prop-track{height:5px;border-radius:3px;background:var(--bg4);overflow:hidden;display:flex}
.prop-yes{background:var(--c5);height:100%;transition:width .8s ease}
.prop-no{background:var(--c3);height:100%;transition:width .8s ease}
.prop-veto{background:var(--c6);height:100%;transition:width .8s ease}
.prop-abs{background:var(--dim);height:100%;transition:width .8s ease}
.prop-pct{font-family:var(--mono);font-size:10px;color:var(--c5)}
.prop-meta{display:flex;gap:14px;font-family:var(--mono);font-size:10px;flex-wrap:wrap}
.params-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:16px 18px}
.param-item{display:flex;flex-direction:column;gap:4px}
.param-lbl{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim)}
.param-val{font-family:var(--mono);font-size:13px;color:var(--txt3)}
.param-val.c{color:var(--c)}
.row-ibc{grid-template-columns:1fr 80px 80px 80px;gap:12px}
.ibc-ch{font-family:var(--mono);font-size:11px;color:var(--c)}
.ibc-sub{font-family:var(--mono);font-size:10px;color:var(--dim);margin-top:1px}
.ibc-stat{font-family:var(--mono);font-size:11px;text-align:right}
.supply-vis{padding:16px 18px}
.supply-bar{height:10px;border-radius:5px;overflow:hidden;display:flex;margin:12px 0}
.sb-bonded{background:var(--c);transition:width .8s}
.sb-unbond{background:var(--c6);transition:width .8s}
.sb-liquid{background:var(--dim);transition:width .8s}
.supply-legend{display:flex;gap:20px;flex-wrap:wrap;font-family:var(--mono);font-size:11px}
.sl-item{display:flex;align-items:center;gap:6px}
.sl-dot{width:8px;height:8px;border-radius:2px;flex-shrink:0}
.bt-chart{height:40px;display:flex;align-items:flex-end;gap:2px;padding:8px 18px}
.bt-bar{flex:1;background:rgba(0,229,255,0.25);border-radius:2px;transition:height .3s,background .3s;min-height:2px}
.bt-bar.hi{background:var(--c3)}
.node-grid{display:grid;grid-template-columns:1fr 1fr;gap:0}
.node-item{padding:14px 18px;border-bottom:1px solid var(--border2);border-right:1px solid var(--border2)}
.node-item:nth-child(2n){border-right:none}
.node-item:nth-last-child(-n+2){border-bottom:none}
.node-lbl{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);margin-bottom:5px}
.node-val{font-family:var(--mono);font-size:16px;color:var(--txt3)}
.node-val.c{color:var(--c);text-shadow:var(--glow)}
.node-sub{font-size:10px;color:var(--dim);margin-top:2px}
#searchPanel{display:none;margin-bottom:16px;animation:fadeSlide .2s ease}
#searchPanel.show{display:block}
.modal-bg{position:fixed;inset:0;background:rgba(2,8,16,0.88);backdrop-filter:blur(12px);z-index:500;display:none;align-items:center;justify-content:center;padding:24px}
.modal-bg.open{display:flex}
.modal{background:var(--bg1);border:1px solid var(--border);border-radius:var(--r);width:100%;max-width:760px;max-height:82vh;overflow-y:auto;animation:popIn .18s ease;box-shadow:0 32px 80px rgba(0,0,0,0.7),var(--glow)}
.modal-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 22px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg1);z-index:1}
.modal-title{font-family:var(--display);font-size:14px;letter-spacing:3px;color:var(--c)}
.modal-x{width:30px;height:30px;display:flex;align-items:center;justify-content:center;background:var(--bg3);border:1px solid var(--border);border-radius:4px;cursor:pointer;color:var(--dim);font-size:14px;transition:all .12s}
.modal-x:hover{border-color:var(--c3);color:var(--c3)}
.modal-body{padding:22px}
.dg{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.df{display:flex;flex-direction:column;gap:4px}.df.full{grid-column:1/-1}
.df-l{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim)}
.df-v{font-family:var(--mono);font-size:12px;color:var(--txt3);word-break:break-all;line-height:1.5}
.df-v.c{color:var(--c)}.df-v.g{color:var(--c5)}.df-v.r{color:var(--c3)}
.df-sep{grid-column:1/-1;height:1px;background:var(--border2);margin:4px 0}
.msg-list{display:flex;flex-direction:column;gap:8px;margin-top:16px}
.msg-item{background:var(--bg3);border:1px solid var(--border2);border-radius:var(--r);padding:10px 14px}
.msg-type{font-family:var(--mono);font-size:10px;color:var(--c);margin-bottom:6px}
.msg-body{font-family:var(--mono);font-size:10px;color:var(--txt);line-height:1.8}
.msg-body pre{white-space:pre-wrap;word-break:break-all;font-size:10px;margin:0}
.ld{display:flex;align-items:center;justify-content:center;gap:10px;padding:32px;color:var(--dim);font-family:var(--mono);font-size:11px;letter-spacing:1.5px}
.sp{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--c);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
.err{text-align:center;padding:24px;font-family:var(--mono);font-size:11px;color:var(--dim)}
.err .ei{font-size:20px;margin-bottom:6px}
.err .em{color:var(--c3);margin-bottom:4px}
.copy-btn{display:inline-flex;align-items:center;gap:4px;font-family:var(--mono);font-size:10px;color:var(--dim);cursor:pointer;padding:2px 6px;border:1px solid var(--border2);border-radius:3px;margin-left:6px;transition:all .12s;vertical-align:middle}
.copy-btn:hover{color:var(--c);border-color:rgba(0,229,255,0.3)}
.sys-pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border2);background:rgba(0,229,255,0.03);font-family:var(--mono);font-size:10px;color:var(--dim);white-space:nowrap}
.sys-dot{width:7px;height:7px;border-radius:50%;background:var(--dim)}
.sys-dot.ok{background:var(--c5);box-shadow:0 0 6px var(--c5)}
.sys-dot.warn{background:var(--c6);box-shadow:0 0 6px var(--c6)}
.sys-dot.bad{background:var(--c3);box-shadow:0 0 6px var(--c3)}
.load-more{display:block;width:100%;padding:12px;background:none;border:1px solid var(--border);color:var(--c);font-family:var(--mono);font-size:11px;letter-spacing:1.5px;cursor:pointer;transition:all .15s;text-align:center}
.load-more:hover{background:rgba(0,229,255,0.06);border-color:var(--c)}
@media(max-width:1200px){.metrics-strip{grid-template-columns:repeat(4,1fr)}.grid-3{grid-template-columns:1fr 1fr}.params-grid{grid-template-columns:repeat(2,1fr)}}

@media(max-width:900px){.grid-2,.grid-65,.grid-56{grid-template-columns:1fr}.metrics-strip{grid-template-columns:repeat(2,1fr)}.topbar-stats{display:none}.row-val{grid-template-columns:28px 1fr 80px 50px}.dg{grid-template-columns:1fr}.params-grid{grid-template-columns:1fr}}
@media(max-width:600px){.metrics-strip{grid-template-columns:1fr 1fr}.nav-tab{padding:7px 12px;font-size:10px;letter-spacing:1px}.row-tx{grid-template-columns:100px 1fr 80px}.row-tx .tx-time2{display:none}.row-block{grid-template-columns:70px 1fr 50px}.row-block .bk-time{display:none}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeSlide{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:none}}
@keyframes popIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:var(--bg0)}
::-webkit-scrollbar-thumb{background:var(--dim);border-radius:2px}
.mono{font-family:var(--mono)}.c-c{color:var(--c)}.c-g{color:var(--c5)}.c-r{color:var(--c3)}.c-y{color:var(--c4)}.c-p{color:var(--c2)}.c-o{color:var(--c6)}.c-d{color:var(--dim)}.fw7{font-weight:700}
[data-theme="light"]{--bg0:#f0f2f5;--bg1:#ffffff;--bg2:#f7f8fa;--bg3:#edf0f4;--bg4:#e0e4ea;--border:rgba(0,70,120,0.12);--border2:rgba(0,70,120,0.06);--c:#0077b6;--c2:#5a52d5;--dim:#8899aa;--txt:#506070;--txt2:#2a3a4a;--txt3:#0d1520;--glow:0 0 12px rgba(0,119,182,0.15);--glow2:0 0 8px rgba(90,82,213,0.2)}
[data-theme="light"] body::before{background-image:none}
[data-theme="light"] body::after{background:radial-gradient(ellipse 70% 50% at 90% 10%,rgba(0,119,182,0.04),transparent 60%)}
[data-theme="light"] #topbar{background:rgba(255,255,255,0.94);border-bottom-color:rgba(0,70,120,0.1)}
[data-theme="light"] .modal{box-shadow:0 32px 80px rgba(0,0,0,0.12),0 0 0 1px rgba(0,0,0,0.04)}
[data-theme="light"] .dropdown{box-shadow:0 12px 32px rgba(0,0,0,0.1)}
[data-theme="light"] .badge{border-color:currentColor!important}
[data-theme="light"] .mc::after{background:var(--c)}
[data-theme="light"] ::-webkit-scrollbar-track{background:#f0f2f5}
[data-theme="light"] ::-webkit-scrollbar-thumb{background:#c0cad4}
.theme-btn{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:var(--bg3);border:1px solid var(--border);border-radius:4px;cursor:pointer;color:var(--dim);font-size:16px;transition:all .12s;flex-shrink:0;line-height:1}
.theme-btn:hover{border-color:var(--c);color:var(--c)}
.price-tag{font-family:var(--mono);font-size:10px;color:var(--c4);margin-top:2px}
.usd-val{font-family:var(--mono);font-size:9px;color:var(--dim);margin-left:4px}
.uptime-bar{display:inline-flex;gap:1px;height:8px;vertical-align:middle;margin-left:4px}
.ub{width:3px;height:8px;border-radius:1px}
.ub.ok{background:var(--c5)}.ub.miss{background:var(--c3)}
.acct-tx-row{display:grid;grid-template-columns:120px 1fr 100px;gap:8px;padding:6px 0;border-bottom:1px solid var(--border2);font-size:11px}
.acct-tx-row:last-child{border-bottom:none}
/* ── Starfield ───────────────────────────────────────────────────────────── */
#starCanvas{position:fixed;inset:0;z-index:0;pointer-events:none}
[data-theme="light"] #starCanvas{display:none}
/* ── Block Flash ─────────────────────────────────────────────────────────── */
@keyframes blockFlash{0%,100%{text-shadow:var(--glow)}45%{text-shadow:0 0 30px #00e5ff,0 0 70px #00e5ff,0 0 120px rgba(0,229,255,.7);color:#fff}}
@keyframes rowFlash{0%,100%{background:transparent}45%{background:rgba(0,229,255,.14)}}
.block-flash{animation:blockFlash .65s ease}
.row-flash{animation:rowFlash .65s ease}
/* ── Activity Ticker ─────────────────────────────────────────────────────── */
#activityTicker{position:relative;z-index:10;height:30px;overflow:hidden;background:rgba(2,8,16,.95);border-bottom:1px solid var(--border2);display:flex;align-items:center}
#tickerLiveBadge{position:absolute;left:0;top:0;bottom:0;width:48px;display:flex;align-items:center;justify-content:center;background:var(--c);color:var(--bg0);font-family:var(--mono);font-size:9px;font-weight:700;letter-spacing:2px;z-index:2;flex-shrink:0}
#tickerTrack{padding-left:56px;white-space:nowrap;display:inline-block;animation:tickScroll 60s linear infinite}
#tickerTrack:hover{animation-play-state:paused}
@keyframes tickScroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.tick-evt{display:inline-flex;align-items:center;gap:5px;padding:0 18px;height:30px;font-family:var(--mono);font-size:10px;color:var(--txt);border-right:1px solid var(--border2)}
.tick-evt .t-tag{font-size:9px;padding:1px 5px;border-radius:2px;font-weight:700}
.tick-evt .t-addr{color:var(--c);opacity:.65}
.tick-evt .t-amt{color:var(--c5)}
[data-theme="light"] #activityTicker{background:rgba(240,245,250,.95)}
/* ── TPS Sparkline ───────────────────────────────────────────────────────── */
#tpsCanvas{vertical-align:middle;margin-left:5px}
/* ── Price Sparkline ─────────────────────────────────────────────────────── */
#priceRow{display:flex;align-items:center;gap:5px}
#priceCanvas{vertical-align:middle}
.price-delta{font-family:var(--mono);font-size:9px;margin-top:1px}
/* ── Nakamoto card colour helpers ────────────────────────────────────────── */
.nc-good{color:var(--c5)}.nc-warn{color:var(--c4)}.nc-bad{color:var(--c3)}
/* ── Cross-Chain Strip ───────────────────────────────────────────────────── */
#ccStrip{display:grid;grid-template-columns:repeat(5,1fr);gap:1px;background:var(--border);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin-bottom:16px}
.cc-cell{background:var(--bg1);padding:12px 16px;transition:background .15s;cursor:pointer;position:relative;overflow:hidden}
.cc-cell:hover{background:var(--bg2)}
.cc-cell.cc-active{background:rgba(0,229,255,.05)}
.cc-cell::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;opacity:.4}
.cc-name{font-family:var(--display);font-size:12px;letter-spacing:2px;display:flex;align-items:center;gap:6px;margin-bottom:4px}
.cc-dot{width:6px;height:6px;border-radius:50%;animation:blink 2s infinite;flex-shrink:0}
.cc-block{font-family:var(--mono);font-size:17px;font-weight:700;line-height:1.1}
.cc-meta{display:flex;gap:8px;margin-top:3px;font-family:var(--mono);font-size:9px;color:var(--dim);flex-wrap:wrap}
.cc-err{font-family:var(--mono);font-size:10px;color:var(--dim);opacity:.4;padding:6px 0}
@media(max-width:900px){#ccStrip{grid-template-columns:repeat(3,1fr)}}
@media(max-width:560px){#ccStrip{grid-template-columns:repeat(2,1fr)}}
/* ── Metrics 8-col ───────────────────────────────────────────────────────── */
.metrics-strip-8{display:grid;grid-template-columns:repeat(8,1fr);gap:1px;background:var(--border);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin-bottom:20px}
@media(max-width:1400px){.metrics-strip-8{grid-template-columns:repeat(4,1fr)}}
@media(max-width:900px){.metrics-strip-8{grid-template-columns:repeat(2,1fr)}}
@media(max-width:480px){.metrics-strip-8{grid-template-columns:1fr 1fr}}
/* ── Footer ──────────────────────────────────────────────────────────────── */
#site-footer{position:relative;z-index:1;border-top:1px solid var(--border);background:rgba(4,13,26,.97);backdrop-filter:blur(12px);margin-top:40px}
.footer-ad-row{display:flex;align-items:center;justify-content:center;padding:20px;border-bottom:1px solid var(--border2)}
.footer-ad-slot{display:flex;align-items:center;justify-content:center;width:100%;max-width:728px;height:90px;background:linear-gradient(135deg,var(--bg3),var(--bg2));border:1px dashed rgba(0,229,255,.2);border-radius:var(--r);position:relative;overflow:hidden;cursor:pointer;transition:border-color .2s}
.footer-ad-slot:hover{border-color:rgba(0,229,255,.4)}
.footer-ad-slot::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(0,229,255,.03),transparent);animation:adShimmer 3s ease-in-out infinite}
@keyframes adShimmer{0%,100%{opacity:.4}50%{opacity:1}}
.footer-ad-label{display:flex;flex-direction:column;align-items:center;gap:6px;position:relative;z-index:1}
.footer-ad-tag{font-family:var(--mono);font-size:9px;letter-spacing:2px;color:var(--dim);text-transform:uppercase;border:1px solid var(--border2);padding:2px 8px;border-radius:3px}
.footer-ad-txt{font-family:var(--display);font-size:20px;letter-spacing:4px;color:rgba(0,229,255,.3)}
.footer-ad-sub{font-family:var(--mono);font-size:10px;color:var(--dim);letter-spacing:1px}
.footer-ad-dims{position:absolute;bottom:6px;right:10px;font-family:var(--mono);font-size:9px;color:rgba(42,74,106,.5)}
.footer-links-row{display:grid;grid-template-columns:2fr repeat(3,1fr) 2fr;max-width:1400px;margin:0 auto;padding:32px 20px 24px;width:100%}
.fl-col{display:flex;flex-direction:column;gap:10px}
.fl-brand{display:flex;align-items:center;gap:10px;margin-bottom:4px}
.fl-brand-text{font-family:var(--display);font-size:18px;letter-spacing:3px;color:var(--c);text-shadow:0 0 16px rgba(0,229,255,.3)}
.fl-tagline{font-family:var(--mono);font-size:10px;color:var(--dim);letter-spacing:.5px;line-height:1.6;max-width:240px}
.fl-social{display:flex;gap:8px;margin-top:4px}
.fl-social-btn{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:var(--bg3);border:1px solid var(--border2);border-radius:4px;color:var(--dim);font-size:13px;cursor:pointer;text-decoration:none;transition:all .15s}
.fl-social-btn:hover{border-color:var(--c);color:var(--c)}
.fl-col-title{font-family:var(--display);font-size:11px;letter-spacing:3px;color:var(--c);margin-bottom:4px;padding-bottom:6px;border-bottom:1px solid var(--border2)}
.fl-link{font-family:var(--mono);font-size:11px;color:var(--dim);text-decoration:none;letter-spacing:.3px;transition:color .12s;cursor:pointer;line-height:1}
.fl-link:hover{color:var(--c)}
.fl-link .fl-badge{display:inline-block;font-size:8px;padding:1px 5px;background:rgba(108,99,255,.15);color:var(--c2);border:1px solid rgba(108,99,255,.25);border-radius:2px;margin-left:5px;vertical-align:middle}
.fl-link .fl-new{display:inline-block;font-size:8px;padding:1px 5px;background:rgba(107,203,119,.12);color:var(--c5);border:1px solid rgba(107,203,119,.2);border-radius:2px;margin-left:5px;vertical-align:middle}
.fl-status{display:flex;align-items:center;gap:6px;font-family:var(--mono);font-size:10px;color:var(--dim)}
.fl-status-dot{width:6px;height:6px;border-radius:50%;background:var(--c5);box-shadow:0 0 5px var(--c5);animation:blink 2s infinite;flex-shrink:0}
.fl-divider{grid-column:1/-1;height:1px;background:var(--border2);margin:4px 0 16px}
.footer-bottom{max-width:1400px;margin:0 auto;padding:0 20px 20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
.footer-copy{font-family:var(--mono);font-size:10px;color:var(--dim);letter-spacing:.5px}
.footer-legal{display:flex;gap:16px}
.footer-legal a{font-family:var(--mono);font-size:10px;color:var(--dim);text-decoration:none;transition:color .12s}
.footer-legal a:hover{color:var(--c)}
.footer-chains-bar{max-width:1400px;margin:0 auto;padding:0 20px 16px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.footer-chains-lbl{font-family:var(--mono);font-size:9px;letter-spacing:1.5px;color:var(--dim);text-transform:uppercase;margin-right:4px;white-space:nowrap}
.footer-chain-chip{font-family:var(--mono);font-size:9px;padding:2px 7px;border:1px solid var(--border2);border-radius:3px;color:var(--dim);cursor:pointer;transition:all .12s}
.footer-chain-chip:hover{color:var(--c);border-color:rgba(0,229,255,.3)}
@media(max-width:1000px){.footer-links-row{grid-template-columns:1fr 1fr;row-gap:24px}.fl-col:first-child{grid-column:1/-1}}
@media(max-width:600px){.footer-links-row{grid-template-columns:1fr}.fl-col:first-child{grid-column:auto}.footer-bottom{flex-direction:column;align-items:flex-start}.footer-ad-slot{height:60px}}
/* ── Governance proposal styles ──────────────────────────────────────────── */
.prop-row{cursor:pointer}.prop-row:focus-visible{outline:2px solid rgba(0,229,255,.4);outline-offset:-2px}
.prop-tally-row{display:grid;grid-template-columns:70px 1fr 58px;gap:8px;align-items:center;margin-bottom:5px}
.prop-tally-lbl{font-family:var(--mono);font-size:10px;letter-spacing:.5px}
.prop-tally-bar{height:6px;border-radius:3px;background:var(--bg4);overflow:hidden}
.prop-tally-fill{height:100%;border-radius:3px;transition:width .5s ease}
.prop-tally-pct{font-family:var(--mono);font-size:10px;text-align:right}
.prop-desc{font-family:var(--mono);font-size:11px;color:var(--txt);line-height:1.8;white-space:pre-wrap;word-break:break-word;max-height:180px;overflow-y:auto;background:var(--bg3);border:1px solid var(--border2);border-radius:4px;padding:10px 12px;margin-top:4px}
.prop-deposit-item{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;background:rgba(0,229,255,.06);border:1px solid var(--border2);border-radius:3px;font-family:var(--mono);font-size:11px;color:var(--txt2);margin:2px}
.prop-msg-chip{display:inline-flex;align-items:center;padding:2px 8px;background:rgba(255,159,28,.08);border:1px solid rgba(255,159,28,.2);border-radius:3px;font-family:var(--mono);font-size:10px;color:var(--c6);margin:2px}

/* ── Feature 8: Validator Uptime Bars ───────────────────────────────────── */
.uptime-block-row{display:flex;gap:1px;align-items:center}
.ub{width:6px;height:10px;border-radius:1px;flex-shrink:0}
.ub.hit{background:var(--c5)}
.ub.miss{background:var(--c3)}
.ub.tomb{background:var(--dim)}
.uptime-pct{font-family:var(--mono);font-size:9px;margin-left:5px;white-space:nowrap}
.val-uptime-wrap{display:flex;align-items:center;gap:4px}
/* ── Feature 9: TX Filter Tabs ──────────────────────────────────────────── */
#txFilterBar{display:flex;gap:4px;padding:10px 14px;border-bottom:1px solid var(--border2);flex-wrap:wrap;align-items:center}
.tx-ftab{padding:4px 12px;font-family:var(--mono);font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;border:1px solid var(--border2);border-radius:3px;cursor:pointer;color:var(--dim);background:transparent;transition:all .12s}
.tx-ftab:hover{color:var(--txt2);border-color:var(--border)}
.tx-ftab.active{background:rgba(0,229,255,.1);color:var(--c);border-color:rgba(0,229,255,.3)}
#txFilterCount{font-family:var(--mono);font-size:9px;color:var(--dim);margin-left:auto;white-space:nowrap}
/* ── Feature 10: Blocks gas column ──────────────────────────────────────── */
.row-block5{grid-template-columns:90px 1fr 80px 72px 72px;gap:10px}
.bk-gas{font-family:var(--mono);font-size:9px;color:var(--dim);text-align:right}
.gas-bar{height:3px;background:var(--bg4);border-radius:2px;margin-top:3px;overflow:hidden;width:100%}
.gas-fill{height:100%;border-radius:2px;background:var(--c2)}
/* ── Feature 11: Keyboard Shortcut HUD ─────────────────────────────────── */
#kbdHud{position:fixed;inset:0;z-index:500;background:rgba(2,8,16,.9);backdrop-filter:blur(14px);display:none;align-items:center;justify-content:center}
#kbdHud.open{display:flex}
#kbdHudBox{background:var(--bg1);border:1px solid var(--border);border-radius:8px;padding:28px 36px;min-width:340px;max-width:520px;width:90vw}
#kbdHudBox h2{font-family:var(--display);font-size:18px;letter-spacing:4px;color:var(--c);margin-bottom:20px;text-align:center}
.kbd-section{margin-bottom:14px}
.kbd-section-title{font-family:var(--mono);font-size:9px;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin-bottom:8px;border-bottom:1px solid var(--border2);padding-bottom:4px}
.kbd-row{display:grid;grid-template-columns:90px 1fr;gap:12px;align-items:center;margin-bottom:6px}
.kbd-key{display:inline-flex;align-items:center;justify-content:center;background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:2px 8px;font-family:var(--mono);font-size:11px;color:var(--txt3);box-shadow:0 2px 0 rgba(0,0,0,.5)}
.kbd-desc{font-family:var(--mono);font-size:11px;color:var(--txt)}
.kbd-close-hint{text-align:center;font-family:var(--mono);font-size:10px;color:var(--dim);margin-top:16px}
.kbd-hint-btn{width:28px;height:28px;border:1px solid var(--border2);border-radius:4px;background:transparent;color:var(--dim);font-family:var(--mono);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
.kbd-hint-btn:hover{border-color:var(--c);color:var(--c)}
/* ── Feature 12: Share bar ───────────────────────────────────────────────── */
.modal-share-bar{display:flex;align-items:center;gap:8px;padding:10px 20px;border-top:1px solid var(--border2);background:rgba(0,229,255,.02);flex-wrap:wrap}
.share-btn{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border:1px solid var(--border2);border-radius:3px;font-family:var(--mono);font-size:10px;color:var(--dim);cursor:pointer;background:transparent;transition:all .12s;text-decoration:none}
.share-btn:hover{border-color:var(--c);color:var(--c)}
/* ── Feature 13: Row slide-in animation ─────────────────────────────────── */
@keyframes rowSlideIn{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:none}}
.row-new{animation:rowSlideIn .3s ease both}
/* ── Feature 14: CSV export button ──────────────────────────────────────── */
.export-btn{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border:1px solid var(--border2);border-radius:3px;font-family:var(--mono);font-size:10px;font-weight:700;letter-spacing:1px;color:var(--c5);cursor:pointer;background:transparent;transition:all .12s;white-space:nowrap}
.export-btn:hover{border-color:var(--c5);background:rgba(107,203,119,.06)}

/* ── Feature A: IBC Denom Trace ─────────────────────────────────────────── */
.denom-trace{font-family:var(--mono);font-size:9px;color:var(--dim);margin-top:2px;word-break:break-all}
.denom-tag{display:inline-flex;align-items:center;gap:4px;background:rgba(108,99,255,.12);border:1px solid rgba(108,99,255,.25);border-radius:3px;padding:1px 6px;font-family:var(--mono);font-size:9px;color:var(--c2);margin:2px 2px 2px 0}
/* ── Feature B: Node Status Panel ───────────────────────────────────────── */
#nodeStatusPanel{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin-bottom:16px}
.ns-cell{background:var(--bg1);padding:12px 16px}
.ns-lbl{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--dim);margin-bottom:5px}
.ns-val{font-family:var(--mono);font-size:13px;color:var(--txt3);line-height:1.2}
.ns-sub{font-size:9px;color:var(--dim);margin-top:2px}
.ns-good{color:var(--c5)}.ns-warn{color:var(--c4)}.ns-bad{color:var(--c3)}
@media(max-width:900px){#nodeStatusPanel{grid-template-columns:repeat(2,1fr)}}
@media(max-width:560px){#nodeStatusPanel{grid-template-columns:1fr 1fr}}
/* ── Feature C: Governance Votes List ───────────────────────────────────── */
.vote-row{display:grid;grid-template-columns:1fr 100px 80px;gap:10px;padding:7px 16px;border-bottom:1px solid var(--border2);font-family:var(--mono);font-size:10px;align-items:center}
.vote-row:last-child{border-bottom:none}
.vote-row:hover{background:rgba(0,229,255,.03)}
.vote-opt{padding:2px 8px;border-radius:3px;font-size:9px;font-weight:700;letter-spacing:1px}
.vote-yes{background:rgba(107,203,119,.15);color:var(--c5);border:1px solid rgba(107,203,119,.3)}
.vote-no{background:rgba(255,107,107,.15);color:var(--c3);border:1px solid rgba(255,107,107,.3)}
.vote-veto{background:rgba(255,159,28,.15);color:var(--c6);border:1px solid rgba(255,159,28,.3)}
.vote-abs{background:rgba(42,74,106,.3);color:var(--dim);border:1px solid var(--border)}
.vote-addr{color:var(--c);cursor:pointer}
.vote-addr:hover{text-decoration:underline}
.votes-load-more{text-align:center;padding:10px;font-family:var(--mono);font-size:10px;color:var(--dim);cursor:pointer;border-top:1px solid var(--border2)}
.votes-load-more:hover{color:var(--c)}
/* ── Feature D: CosmWasm Contract Panel ─────────────────────────────────── */
.wasm-contract-panel{padding:16px;font-family:var(--mono)}
.wasm-state-row{display:grid;grid-template-columns:180px 1fr;gap:8px;padding:5px 0;border-bottom:1px solid var(--border2);font-size:10px;align-items:start}
.wasm-state-row:last-child{border-bottom:none}
.wasm-key{color:var(--dim);word-break:break-all}
.wasm-val{color:var(--txt3);word-break:break-all}
.wasm-query-form{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.wasm-query-input{flex:1;min-width:160px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:7px 12px;color:var(--txt3);font-family:var(--mono);font-size:11px;outline:none}
.wasm-query-input:focus{border-color:var(--c)}
.wasm-query-btn{padding:7px 16px;background:var(--c);color:var(--bg0);font-family:var(--ui);font-size:10px;font-weight:700;letter-spacing:1px;border:none;border-radius:var(--r);cursor:pointer}
.wasm-query-btn:hover{background:#33eeff}
.wasm-result{margin-top:10px;background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r);padding:10px;font-size:10px;white-space:pre-wrap;word-break:break-all;max-height:200px;overflow-y:auto;color:var(--txt2)}
/* ── Feature E: Upgrade Plan Widget ─────────────────────────────────────── */
#upgradePanel{display:none}
#upgradePanel.visible{display:block}
.upgrade-banner{background:linear-gradient(135deg,rgba(108,99,255,.1),rgba(0,229,255,.05));border:1px solid rgba(108,99,255,.3);border-radius:var(--r);padding:14px 20px;margin-bottom:16px;display:flex;align-items:center;gap:16px}
.upgrade-icon{font-size:24px;flex-shrink:0}
.upgrade-info{flex:1}
.upgrade-name{font-family:var(--display);font-size:16px;letter-spacing:3px;color:var(--c2);margin-bottom:4px}
.upgrade-height{font-family:var(--mono);font-size:12px;color:var(--txt2)}
.upgrade-blocks-left{font-family:var(--mono);font-size:11px;color:var(--c4);margin-top:3px}
/* ── Feature F: Authz + Feegrant on Account ─────────────────────────────── */
.authz-row{display:grid;grid-template-columns:1fr 80px 100px;gap:8px;padding:6px 0;border-bottom:1px solid var(--border2);font-family:var(--mono);font-size:9px;align-items:center}
.authz-row:last-child{border-bottom:none}
.authz-type{color:var(--c2);font-size:9px}
.authz-exp{color:var(--dim)}
/* ── Feature G: Gas Price Estimate ──────────────────────────────────────── */
#gasEstPanel{font-family:var(--mono);font-size:11px;padding:2px 0}
.gas-est-row{display:grid;grid-template-columns:80px 1fr 1fr;gap:8px;padding:4px 0;border-bottom:1px solid var(--border2)}
.gas-est-row:last-child{border-bottom:none}
/* ── Feature H: Endpoint Latency ─────────────────────────────────────────── */
.ep-row{display:grid;grid-template-columns:1fr 70px 60px;gap:8px;padding:6px 14px;border-bottom:1px solid var(--border2);font-family:var(--mono);font-size:10px;align-items:center}
.ep-row:last-child{border-bottom:none}
.ep-lat{text-align:right}
.ep-lat.good{color:var(--c5)}.ep-lat.ok{color:var(--c4)}.ep-lat.bad{color:var(--c3)}
.ep-active-dot{width:6px;height:6px;border-radius:50%;background:var(--c5);box-shadow:0 0 5px var(--c5);display:inline-block}


/* ===============================
   Chain selector overlay
   =============================== */
.chain-overlay{
  pointer-events:none;
  position:fixed; inset:0;
  background:rgba(0,0,0,.72);
  backdrop-filter: blur(6px);
  z-index:2147483647;
  display:none;
  align-items:flex-start;
  justify-content:center;
  padding:24px 12px;
}
.chain-overlay.open{display:flex;pointer-events:auto}
.chain-overlay .panel{
  width:min(720px, 96vw);
  max-height:calc(100vh - 48px);
  overflow:auto;
  box-shadow:0 20px 60px rgba(0,0,0,.55);
}
.chain-overlay .overlay-head{
  display:flex; gap:12px; align-items:center; justify-content:space-between;
  margin-bottom:12px;
}
.chain-overlay .overlay-head h3{margin:0;font-size:16px}
.chain-overlay .overlay-close{
  background:transparent;
  border:1px solid var(--border);
  color:var(--text);
  padding:6px 10px;
  border-radius:8px;
  cursor:pointer;
}
.chain-overlay .overlay-search{
  width:100%;
  margin:10px 0 12px;
}
.chain-overlay .overlay-list{
  display:grid;
  grid-template-columns: repeat(2, minmax(0,1fr));
  gap:10px;
}
@media (max-width:560px){
  .chain-overlay .overlay-list{grid-template-columns:1fr}
}
.chain-overlay .chain-item{
  border:1px solid var(--border);
  border-radius:10px;
  padding:10px 12px;
  cursor:pointer;
  background:rgba(2,8,20,.65);
}
.chain-overlay .chain-item:hover{
  border-color:var(--accent);
}
.chain-overlay .chain-item .name{font-weight:600}
.chain-overlay .chain-item .meta{font-size:12px;color:var(--muted);margin-top:4px}


/* Chain selector overlay (moved dropdown) */
#chainOverlay{
  position:fixed; inset:0;
  display:none;
  align-items:flex-start;
  justify-content:center;
  padding:24px 12px;
  background:rgba(0,0,0,.72);
  backdrop-filter: blur(6px);
  z-index:2147483647;
}
#chainOverlay.open{display:flex}
#chainOverlay .co-panel{
  width:min(760px, 96vw);
  max-height:calc(100vh - 48px);
  overflow:auto;
  box-shadow:0 20px 60px rgba(0,0,0,.55);
}
#chainOverlay .co-head{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  margin-bottom:12px;
}
#chainOverlay .co-head .h{
  margin:0; font-size:16px;
}
#chainOverlay .co-close{
  background:transparent;
  border:1px solid var(--border);
  color:var(--text);
  padding:6px 10px;
  border-radius:8px;
  cursor:pointer;
}
#chainOverlay #netDrop{
  position:relative !important;
  inset:auto !important;
  transform:none !important;
  width:100% !important;
  max-height:none !important;
  overflow:visible !important;
  border-radius:14px;
}
#chainOverlay #netDrop.open{display:block}

</style>
</head>
<body>
<canvas id="starCanvas" aria-hidden="true"></canvas>
<div id="activityTicker" aria-live="off"><div id="tickerLiveBadge">LIVE</div><div id="tickerTrack"><span style="font-family:var(--mono);font-size:10px;color:var(--dim);padding:0 20px">Connecting…</span></div></div>
<div id="topbar">
  <a class="logo" href="#/" data-testid="logo-link">
    <svg class="logo-mark" viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="13" stroke="#00e5ff" stroke-width="1.5" opacity=".5"/><circle cx="16" cy="16" r="8" stroke="#00e5ff" stroke-width="1.2" opacity=".7"/><circle cx="16" cy="16" r="3" fill="#00e5ff"/><ellipse cx="16" cy="16" rx="13" ry="5" stroke="#6c63ff" stroke-width="1" opacity=".6" transform="rotate(-20 16 16)"/></svg>
    <div><div class="logo-text">Atom Registry</div><div class="logo-sub">The Interchain Explorer</div></div>
  </a>
  <div class="search-wrap">
    <span class="search-ico">&#9906;</span>
    <input id="searchInput" type="text" placeholder="Block, tx hash, address, valoper..." data-testid="search-input"/>
    <button id="searchBtn" data-testid="search-button">SEARCH</button>
  </div>
  <div class="topbar-stats">
    <button class="kbd-hint-btn" id="kbdBtn" title="Keyboard shortcuts (?)" aria-label="Keyboard shortcuts">?</button>
    <div class="theme-btn" id="themeBtn" role="button" tabindex="0" title="Toggle theme" data-testid="theme-toggle">&#9788;</div>
    <div class="sys-pill" title="Endpoint health" data-testid="system-status">
      <span class="sys-dot" id="sysDot"></span>
      <span id="sysStatus">INIT</span>
      <span id="sysMeta"></span>
    </div>
    <div class="block-pill"><div class="bp-lbl">BLOCK</div><div class="bp-val" id="hBlock" data-testid="header-block-height">&#8212;</div></div>
    <div class="ts"><div id="priceRow"><div class="ts-val c-y" id="hPrice" data-testid="header-price">&#8212;</div><canvas id="priceCanvas" width="46" height="18" style="margin-left:5px"></canvas></div><div class="price-delta" id="hPriceDelta"></div></div>
    <div class="ts"><div class="ts-val" id="hTps" data-testid="header-tps" style="display:flex;align-items:center;gap:4px">&#8212;<canvas id="tpsCanvas" width="46" height="18"></canvas></div><div class="ts-lbl">TX/S</div></div>
    <div class="ts"><div class="ts-val c-g" id="hBonded" data-testid="header-bonded">&#8212;</div><div class="ts-lbl">BONDED</div></div>
    <div class="ts"><div class="ts-val c-y" id="hBlockTime" data-testid="header-block-time">&#8212;</div><div class="ts-lbl">BLK TIME</div></div>
  </div>
</div>
<div id="app">
  <div class="panel" id="searchPanel" data-testid="search-panel">
    <div class="panel-hd">
      <span class="panel-title" id="searchPanelTitle">SEARCH RESULT</span>
      <span class="panel-link" id="closeSrchBtn" role="button" tabindex="0" data-testid="close-search-btn">&#10005; CLOSE</span>
    </div>
    <div id="searchPanelBody" style="padding:20px"></div>
  </div>
  <div id="navTabs" role="tablist" aria-label="Navigation" data-testid="nav-tabs">
    <div class="nav-tab active" data-page="dashboard" role="tab" aria-selected="true" tabindex="0">DASHBOARD</div>
    <div class="nav-tab" data-page="blocks" role="tab" aria-selected="false" tabindex="0">BLOCKS</div>
    <div class="nav-tab" data-page="transactions" role="tab" aria-selected="false" tabindex="0">TRANSACTIONS</div>
    <div class="nav-tab" data-page="validators" role="tab" aria-selected="false" tabindex="0">VALIDATORS</div>
    <div class="nav-tab" data-page="governance" role="tab" aria-selected="false" tabindex="0">GOVERNANCE</div>
    <div class="nav-tab" data-page="ibc" role="tab" aria-selected="false" tabindex="0">IBC</div>
    <div class="nav-tab" data-page="assets" role="tab" aria-selected="false" tabindex="0">ASSETS</div>
    <div class="nav-tab" data-page="params" role="tab" aria-selected="false" tabindex="0">PARAMETERS</div>
    <div class="net-pill" id="netBtn" aria-haspopup="true" aria-expanded="false" role="button" tabindex="0" data-testid="network-selector" style="margin-left:auto">
      <div class="net-live"></div>
      <span class="net-name" id="netName">Cosmos Hub</span>
      <span class="net-caret">&#9660;</span>
      <div class="dropdown" id="netDrop" role="menu" aria-label="Select network" data-testid="network-dropdown"></div>
    </div>
  </div>
  <!-- DASHBOARD -->
  <div class="page active" id="page-dashboard" data-testid="page-dashboard">
    <div id="upgradePanel"><div class="upgrade-banner"><div class="upgrade-icon">⚡</div><div class="upgrade-info"><div class="upgrade-name" id="upgradeName">UPGRADE PENDING</div><div class="upgrade-height" id="upgradeHeight">HEIGHT: —</div><div class="upgrade-blocks-left" id="upgradeBlocksLeft"></div></div><div style="text-align:right;font-family:var(--mono);font-size:9px;color:var(--dim)">PLANNED UPGRADE</div></div></div><div id="ccStrip" data-testid="cc-strip"></div>
    <div class="metrics-strip metrics-strip-8" data-testid="metrics-strip">
      <div class="mc"><div class="mc-lbl">Latest Block</div><div class="mc-val c" id="mBlock" data-testid="metric-block"><div class="sp"></div></div><div class="mc-sub" id="mBlockTime">calculating...</div></div>
      <div class="mc"><div class="mc-lbl">Validators</div><div class="mc-val" id="mVals" data-testid="metric-validators">&#8212;</div><div class="mc-sub" id="mValsActive">staking set</div></div>
      <div class="mc"><div class="mc-lbl">Bonded Tokens</div><div class="mc-val g" id="mBonded" data-testid="metric-bonded">&#8212;</div><div class="mc-sub" id="mBondRatio">&#8212;</div></div>
      <div class="mc"><div class="mc-lbl">Annual Inflation</div><div class="mc-val y" id="mInflation" data-testid="metric-inflation">&#8212;</div><div class="mc-sub" id="mAprSub">staking APR</div></div>
      <div class="mc"><div class="mc-lbl">Community Pool</div><div class="mc-val" id="mPool" data-testid="metric-pool">&#8212;</div><div class="mc-sub" id="mPoolDenom">&#8212;</div></div>
      <div class="mc"><div class="mc-lbl">Total Supply</div><div class="mc-val" id="mSupply" data-testid="metric-supply">&#8212;</div><div class="mc-sub" id="mSupplyDenom">&#8212;</div></div>
      <div class="mc"><div class="mc-lbl">~24h Transactions</div><div class="mc-val p" id="mTxCount" data-testid="metric-tx-count">&#8212;</div><div class="mc-sub">projection</div></div>
      <div class="mc"><div class="mc-lbl">Nakamoto Coeff</div><div class="mc-val" id="mNakamoto">&#8212;</div><div class="mc-sub" id="mNakamotoSub">decentralization</div></div>
    </div>
    <div class="grid-2">
      <div class="panel"><div class="panel-hd"><span class="panel-title">LATEST BLOCKS</span><div class="live-tag"><div class="live-dot"></div>LIVE</div></div><div id="blockList" data-testid="block-list"><div class="ld"><div class="sp"></div>FETCHING BLOCKS</div></div></div>
      <div class="panel"><div class="panel-hd"><span class="panel-title">LATEST TRANSACTIONS</span><div class="live-tag"><div class="live-dot"></div>LIVE</div></div><div id="txList" data-testid="tx-list"><div class="ld"><div class="sp"></div>FETCHING TRANSACTIONS</div></div></div>
    </div>
    <div id="nodeStatusPanel"><div class="ns-cell"><div class="ns-lbl">Node Version</div><div class="ns-val" id="nsVersion">—</div><div class="ns-sub" id="nsNetwork">—</div></div><div class="ns-cell"><div class="ns-lbl">Sync Status</div><div class="ns-val" id="nsSyncing">—</div><div class="ns-sub" id="nsSyncSub">latest block</div></div><div class="ns-cell"><div class="ns-lbl">Endpoint</div><div class="ns-val" id="nsEndpoint" style="font-size:10px;word-break:break-all">—</div><div class="ns-sub" id="nsLatency">—</div></div><div class="ns-cell"><div class="ns-lbl">Gas Price Est.</div><div class="ns-val" id="nsGasPrice">—</div><div class="ns-sub" id="nsGasSub">median recent blocks</div></div></div><div class="grid-65">
      <div class="panel"><div class="panel-hd"><span class="panel-title">TOP VALIDATORS</span><span class="panel-link" data-gotopage="validators">VIEW ALL &#8594;</span></div><div id="dashValList" data-testid="dash-val-list"><div class="ld"><div class="sp"></div>LOADING</div></div></div>
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="panel" style="flex:1"><div class="panel-hd"><span class="panel-title">GOVERNANCE</span><span class="panel-badge" id="propBadge">&#8212;</span></div><div id="dashGovList" data-testid="dash-gov-list"><div class="ld"><div class="sp"></div>LOADING</div></div></div>
        <div class="panel"><div class="panel-hd"><span class="panel-title">NETWORK HEALTH</span></div>
          <div class="node-grid" data-testid="network-health">
            <div class="node-item"><div class="node-lbl">Chain ID</div><div class="node-val c" id="nh-chainid">&#8212;</div><div class="node-sub">network</div></div>
            <div class="node-item"><div class="node-lbl">Unbonding</div><div class="node-val" id="nh-unbonding">&#8212;</div><div class="node-sub">period</div></div>
            <div class="node-item"><div class="node-lbl">Max Validators</div><div class="node-val" id="nh-maxval">&#8212;</div><div class="node-sub">active set</div></div>
            <div class="node-item"><div class="node-lbl">Min Commission</div><div class="node-val" id="nh-mincomm">&#8212;</div><div class="node-sub">floor rate</div></div>
          </div>
        </div>
      </div>
    </div>
    <div class="grid-56">
      <div class="panel"><div class="panel-hd"><span class="panel-title">SUPPLY DISTRIBUTION</span></div><div class="supply-vis" id="supplyVis" data-testid="supply-vis"><div class="ld"><div class="sp"></div>LOADING</div></div></div>
      <div class="panel"><div class="panel-hd"><span class="panel-title">BLOCK TIME HISTORY</span><div class="live-tag"><div class="live-dot"></div>LAST 20 BLOCKS</div></div><div class="bt-chart" id="btChart" data-testid="block-time-chart"></div></div>
    </div>
  </div>
  <!-- BLOCKS -->
  <div class="page" id="page-blocks" data-testid="page-blocks">
    <div class="panel grid-full"><div class="panel-hd"><span class="panel-title">BLOCK EXPLORER</span><div style="display:flex;align-items:center;gap:10px"><div class="live-tag"><div class="live-dot"></div>LIVE</div></div></div><div id="blocksPageList"><div class="ld"><div class="sp"></div>LOADING BLOCKS</div></div></div>
  </div>
  <!-- TRANSACTIONS -->
  <div class="page" id="page-transactions" data-testid="page-transactions">
    <div class="panel grid-full"><div class="panel-hd"><span class="panel-title">TRANSACTIONS</span><div class="live-tag"><div class="live-dot"></div>LIVE</div></div><div id="txFilterBar"><span class="tx-ftab active" data-txf="ALL">ALL</span><span class="tx-ftab" data-txf="SEND">SEND</span><span class="tx-ftab" data-txf="DELEGATE">DELEGATE</span><span class="tx-ftab" data-txf="IBC">IBC</span><span class="tx-ftab" data-txf="EXECUTE">CONTRACTS</span><span class="tx-ftab" data-txf="VOTE">GOVERNANCE</span><span id="txFilterCount"></span></div><div id="txPageList"><div class="ld"><div class="sp"></div>LOADING TRANSACTIONS</div></div></div>
  </div>
  <!-- VALIDATORS -->
  <div class="page" id="page-validators" data-testid="page-validators">
    <div class="panel grid-full">
      <div class="panel-hd">
        <span class="panel-title">VALIDATOR SET</span>
        <div style="display:flex;align-items:center;gap:8px"><button class="export-btn" id="valExportBtn" title="Export CSV"><svg viewBox="0 0 12 12"><path d="M6 8L2 4h3V0h2v4h3z"/><path d="M0 10h12v2H0z"/></svg>CSV</button>
          <div class="nav-tab active" data-vtab="bonded" role="button" tabindex="0">BONDED</div>
          <div class="nav-tab" data-vtab="unbonding" role="button" tabindex="0">UNBONDING</div>
          <div class="nav-tab" data-vtab="unbonded" role="button" tabindex="0">UNBONDED</div>
        </div>
      </div>
      <div id="valPageList"><div class="ld"><div class="sp"></div>LOADING VALIDATORS</div></div>
    </div>
  </div>
  <!-- GOVERNANCE -->
  <div class="page" id="page-governance" data-testid="page-governance">
    <div class="panel grid-full">
      <div class="panel-hd">
        <span class="panel-title">GOVERNANCE PROPOSALS</span>
        <div style="display:flex;gap:8px">
          <div class="nav-tab active" data-gtab="2" role="button" tabindex="0">VOTING</div>
          <div class="nav-tab" data-gtab="3" role="button" tabindex="0">PASSED</div>
          <div class="nav-tab" data-gtab="4" role="button" tabindex="0">REJECTED</div>
          <div class="nav-tab" data-gtab="1" role="button" tabindex="0">DEPOSIT</div>
        </div>
      </div>
      <div id="govPageList"><div class="ld"><div class="sp"></div>LOADING PROPOSALS</div></div>
    </div>
  </div>
  <!-- IBC -->
  <div class="page" id="page-ibc" data-testid="page-ibc">
    <div class="grid-2">
      <div class="panel"><div class="panel-hd"><span class="panel-title">IBC CHANNELS</span><span class="panel-badge" id="ibcChBadge">&#8212;</span></div><div id="ibcChList"><div class="ld"><div class="sp"></div>LOADING</div></div></div>
      <div class="panel"><div class="panel-hd"><span class="panel-title">IBC CONNECTIONS</span><span class="panel-badge" id="ibcConnBadge">&#8212;</span></div><div id="ibcConnList"><div class="ld"><div class="sp"></div>LOADING</div></div></div>
    </div>
    <div class="panel grid-full"><div class="panel-hd"><span class="panel-title">IBC CLIENTS</span><span class="panel-badge" id="ibcClientBadge">&#8212;</span></div><div id="ibcClientList"><div class="ld"><div class="sp"></div>LOADING</div></div></div>
  </div>
  <!-- ASSETS -->
  <div class="page" id="page-assets" data-testid="page-assets">
    <div class="panel grid-full"><div class="panel-hd"><span class="panel-title">ON-CHAIN ASSETS</span><span class="panel-badge" id="assetBadge">&#8212;</span></div><div id="assetList"><div class="ld"><div class="sp"></div>LOADING</div></div></div>
  </div>
  <!-- PARAMETERS -->
  <div class="page" id="page-params" data-testid="page-params">
    <div class="grid-2">
      <div class="panel"><div class="panel-hd"><span class="panel-title">STAKING PARAMS</span></div><div id="stakingParams" class="params-grid"><div class="ld"><div class="sp"></div>LOADING</div></div></div>
      <div class="panel"><div class="panel-hd"><span class="panel-title">SLASHING PARAMS</span></div><div id="slashingParams" class="params-grid"><div class="ld"><div class="sp"></div>LOADING</div></div></div>
    </div>
    <div class="grid-2">
      <div class="panel"><div class="panel-hd"><span class="panel-title">DISTRIBUTION PARAMS</span></div><div id="distParams" class="params-grid"><div class="ld"><div class="sp"></div>LOADING</div></div></div>
      <div class="panel"><div class="panel-hd"><span class="panel-title">GOVERNANCE PARAMS</span></div><div id="govParams" class="params-grid"><div class="ld"><div class="sp"></div>LOADING</div></div></div>
    </div>
    <div class="panel grid-full"><div class="panel-hd"><span class="panel-title">MINT PARAMS</span></div><div id="mintParams" class="params-grid"><div class="ld"><div class="sp"></div>LOADING</div></div></div>
  </div>

</div><center><!-- ══ ATOM REGISTRY EXCHANGE WIDGET ═══════════════════════════════════════ -->
<div style="
  background:var(--bg1);
  border:1px solid var(--border);
  border-radius:var(--r);
  overflow:hidden;
  margin-bottom:16px;
">
  <!-- Panel header — same pattern as every other panel on the page -->
  <div style="
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:12px 18px;
    border-bottom:1px solid var(--border2);
    background:rgba(0,229,255,0.02);
  ">
    <span style="
      font-family:var(--display);
      font-size:14px;
      letter-spacing:3px;
      color:var(--c);
    ">*</span>
    <div style="display:flex;align-items:center;gap:8px">
      <span style="
        font-family:var(--mono);
        font-size:14px;
        letter-spacing:1.5px;
        color:var(--c5);
        display:flex;
        align-items:center;
        gap:5px;
      ">
        <span style="
  width:6px;height:6px;border-radius:50%;
  background:var(--c5);
  box-shadow:0 0 5px var(--c5);
  animation:blink 1.5s infinite;
  display:inline-block;
"></span><a href="https://your-sponsor-link.com" target="_blank" rel="noopener" style="
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:1.5px;
  color:var(--c5);
  text-decoration:none;
">Sponsored By Your Name Here</a>
  </div>
  </div>

  <!-- Widget frame — backgroundColor=000000 matches --bg1 in dark mode -->
  <div style="background:#040d1a;padding:0">
    <iframe
      id="iframe-widget"
      src="https://changenow.io/embeds/exchange-widget/v2/widget.html?FAQ=false&amount=100&amountFiat&backgroundColor=040d1a&darkMode=true&from=atom&horizontal=true&isFiat=false&lang=en-US&link_id=22b53d0f4a61fb&locales=true&logo=false&primaryColor=00e5ff&to=osmo&toTheMoon=false"
      style="
        height:205px;
        width:100%;
        border:none;
        display:block;
      "
    ></iframe>
  </div>
</div>
<script defer type="text/javascript"
  src="https://changenow.io/embeds/exchange-widget/v2/stepper-connector.js">

  // --- Tx-by-height fetch with gateway fallbacks ---
  // Some LCD gateways (including certain cosmos.directory backends) intermittently 500 on /cosmos/tx/v1beta1/txs?events=tx.height=...
  // We try 'events' first, then fallback to legacy 'query', and if both fail with server errors we disable tx-by-height for this chain.
  


function hookChainOverlayTrigger() {
    // Always bind directly to the select; some layouts swallow parent clicks.
    const netDrop = document.getElementById("netDrop");
    if (netDrop) {
      const open = (e) => {
        try {
          e.preventDefault();
          e.stopPropagation();
          // prevent native <select> open
          netDrop.blur();
        } catch(_) {}
        openChainOverlay();
      };
      // capture phase to beat native select behavior
      netDrop.addEventListener("mousedown", open, true);
      netDrop.addEventListener("click", open, true);
      netDrop.addEventListener("touchstart", open, { capture: true, passive: false });
      // Also allow keyboard: Space/Enter on focused select opens overlay
      netDrop.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " " ) {
          e.preventDefault();
          openChainOverlay();
        }
      }, true);

      // Add an invisible button overlay to guarantee a large click target
      const wrap = netDrop.parentElement;
      if (wrap && !wrap.querySelector(".netdrop-overlay-btn")) {
        wrap.style.position = wrap.style.position || "relative";
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "netdrop-overlay-btn";
        btn.setAttribute("aria-label","Select network");
        btn.style.position = "absolute";
        btn.style.inset = "0";
        btn.style.background = "transparent";
        btn.style.border = "0";
        btn.style.padding = "0";
        btn.style.margin = "0";
        btn.style.cursor = "pointer";
        btn.style.zIndex = "5";
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          openChainOverlay();
        }, true);
        wrap.appendChild(btn);
        // keep select visible above background but below button
        netDrop.style.position = netDrop.style.position || "relative";
        netDrop.style.zIndex = "4";
      }
    }
  }
</script>
<!-- ══ END EXCHANGE WIDGET ═══════════════════════════════════════════════════ --></center>

<!-- FOOTER -->
<footer id="site-footer">
  <div class="footer-ad-row"><div class="footer-ad-slot"><div class="footer-ad-label"><span class="footer-ad-tag">Advertisement</span><span class="footer-ad-txt">YOUR BRAND HERE</span><span class="footer-ad-sub">Reach the Cosmos ecosystem — <a href="/contact.html">Advertising Inquiry</a></span></div><span class="footer-ad-dims">728&times;90</span></div></div>
  <div class="footer-links-row">
    <div class="fl-col"><div class="fl-brand"><svg width="22" height="22" viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="13" stroke="#00e5ff" stroke-width="1.5" opacity=".5"/><circle cx="16" cy="16" r="8" stroke="#00e5ff" stroke-width="1.2" opacity=".7"/><circle cx="16" cy="16" r="3" fill="#00e5ff"/><ellipse cx="16" cy="16" rx="13" ry="5" stroke="#6c63ff" stroke-width="1" opacity=".6" transform="rotate(-20 16 16)"/></svg><span class="fl-brand-text">ATOM REGISTRY</span></div><p class="fl-tagline">Production-grade Interchain explorer. 28+ Cosmos SDK chains. Real-time blocks, governance, IBC &amp; assets — all in your browser.</p><div class="fl-social"><a class="fl-social-btn" href="https://x.com/atomregistry" title="Twitter">&#120143;</a><a class="fl-social-btn" href="#" title="GitHub">&#9679;</a><a class="fl-social-btn" href="#" title="Telegram">&#9992;</a></div><div class="fl-status"><span class="fl-status-dot"></span>All systems operational</div></div>
    <div class="fl-col"><div class="fl-col-title">EXPLORER</div><a class="fl-link" href="#/page/dashboard">Dashboard</a><a class="fl-link" href="#/page/blocks">Blocks</a><a class="fl-link" href="#/page/transactions">Transactions</a><a class="fl-link" href="#/page/validators">Validators</a><a class="fl-link" href="#/page/governance">Governance<span class="fl-new">LIVE</span></a><a class="fl-link" href="#/page/ibc">IBC Channels</a><a class="fl-link" href="#/page/assets">Assets</a><a class="fl-link" href="#/page/params">Parameters</a></div>
    <div class="fl-col"><div class="fl-col-title">ECOSYSTEM</div><a class="fl-link" href="https://cosmos.network" target="_blank" rel="noopener">Cosmos Network</a><a class="fl-link" href="https://hub.cosmos.network" target="_blank" rel="noopener">Cosmos Hub</a><a class="fl-link" href="https://ibc.cosmos.network" target="_blank" rel="noopener">IBC Protocol</a><a class="fl-link" href="https://cosmwasm.com" target="_blank" rel="noopener">CosmWasm<span class="fl-badge">WASM</span></a><a class="fl-link" href="https://osmosis.zone" target="_blank" rel="noopener">Osmosis DEX</a><a class="fl-link" href="https://stargaze.zone" target="_blank" rel="noopener">Stargaze NFTs</a></div>
    <div class="fl-col"><div class="fl-col-title">RESOURCES</div><a class="fl-link" href="https://docs.cosmos.network" target="_blank" rel="noopener">Cosmos Docs</a><a class="fl-link" href="https://github.com/cosmos" target="_blank" rel="noopener">GitHub</a><a class="fl-link" href="https://forum.cosmos.network" target="_blank" rel="noopener">Forum</a><a class="fl-link" href="https://www.coingecko.com" target="_blank" rel="noopener">CoinGecko</a></div>
    <div class="fl-col"><div class="fl-col-title">ABOUT</div><a class="fl-link" href="/about.html">About Atom Registry</a><a class="fl-link" href="#">API Docs<span class="fl-badge">BETA</span></a><a class="fl-link" href="/contact.html">Advertise</a><a class="fl-link" href="/contact.html">Contact</a></div>
    <div class="fl-divider"></div>
  </div>
  <div class="footer-chains-bar"><span class="footer-chains-lbl">Supported:</span><span class="footer-chain-chip" data-chain="cosmos">ATOM</span><span class="footer-chain-chip" data-chain="osmosis">OSMO</span><span class="footer-chain-chip" data-chain="celestia">TIA</span><span class="footer-chain-chip" data-chain="injective">INJ</span><span class="footer-chain-chip" data-chain="dydx">DYDX</span><span class="footer-chain-chip" data-chain="neutron">NTRN</span><span class="footer-chain-chip" data-chain="akash">AKT</span><span class="footer-chain-chip" data-chain="sei">SEI</span><span class="footer-chain-chip" data-chain="nolus">NLS</span><span class="footer-chain-chip" data-chain="stride">STRD</span><span class="footer-chain-chip" data-chain="axelar">AXL</span><span class="footer-chain-chip" data-chain="juno">JUNO</span><span class="footer-chain-chip" data-chain="stargaze">STARS</span><span class="footer-chain-chip" data-chain="kujira">KUJI</span><span class="footer-chain-chip" data-chain="noble">USDC</span><span class="footer-chain-chip" data-chain="terra2">LUNA</span><span class="footer-chain-chip" data-chain="evmos">EVMOS</span><span class="footer-chain-chip" data-chain="coreum">CORE</span><span class="footer-chain-chip" data-chain="band">BAND</span><span class="footer-chain-chip" data-chain="regen">REGEN</span><span class="footer-chain-chip" data-chain="nibiru">NIBI</span><span class="footer-chain-chip" data-chain="saga">SAGA</span><span class="footer-chain-chip" style="color:var(--c2);border-color:rgba(108,99,255,.25)">+7 MORE</span></div>
  <div class="footer-bottom"><span class="footer-copy">&copy; 2025 Atom Registry &mdash; The Interchain Explorer</span><nav class="footer-legal"><a href="/privacy.html">Privacy</a><a href="/terms.html">Terms</a><a href="/disclaimer.html">Disclaimer</a></nav></div>
</footer>

<div class="modal-bg" id="modalBg" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal"><div class="modal-hd"><span class="modal-title" id="modalTitle">DETAIL</span><div class="modal-x" id="modalX" role="button" tabindex="0" aria-label="Close" data-testid="modal-close">&#10005;</div></div><div class="modal-body" id="modalBody"></div></div>
</div>
<script>
// ============================================================================
// ATOM REGISTRY — Production-Grade Frontend-Only Interchain Explorer
// ============================================================================

// ── Chain Configuration ─────────────────────────────────────────────────────
const CHAINS={
// Per-chain capability flags (baked in to eliminate runtime probe noise):
//   wasm:true/false = CosmWasm installed
//   authz:true/false = authz module available
//   feegrant:true/false = feegrant module available
//   govV1beta1:false = only override when v1beta1 is missing (default true)
//   noTxQuery:true = tx-by-height query always fails on this chain (skip gas queries)
//   noDistParams:true = distribution/params returns 501
//   noSupplyDenom:true = supply/by_denom returns 500
cosmos:{name:'Cosmos Hub',chainId:'cosmoshub-4',denom:'uatom',display:'ATOM',dec:6,prefix:'cosmos',color:'#00e5ff',hasInflation:true,hasCommunityPool:true,cgId:'cosmos',txQueryFormat:'query',
  wasm:false,authz:true,feegrant:true,
  endpoints:['https://cosmos-rest.publicnode.com','https://rest.cosmos.directory/cosmoshub']},
osmosis:{name:'Osmosis',chainId:'osmosis-1',denom:'uosmo',display:'OSMO',dec:6,prefix:'osmo',color:'#6c63ff',hasInflation:false,hasCommunityPool:true,cgId:'osmosis',txQueryFormat:'query',
  wasm:true,authz:true,feegrant:true,
  endpoints:['https://osmosis-rest.publicnode.com','https://rest.cosmos.directory/osmosis']},
celestia:{name:'Celestia',chainId:'celestia',denom:'utia',display:'TIA',dec:6,prefix:'celestia',color:'#7B2FBE',hasInflation:false,hasCommunityPool:true,cgId:'celestia',txQueryFormat:'events',
  wasm:false,authz:true,feegrant:true,noTxQuery:true,
  endpoints:['https://rest.cosmos.directory/celestia','https://celestia-rest.publicnode.com']},
injective:{name:'Injective',chainId:'injective-1',denom:'inj',display:'INJ',dec:18,prefix:'inj',color:'#00F2EA',hasInflation:true,hasCommunityPool:true,cgId:'injective-protocol',txQueryFormat:'query',
  wasm:false,authz:true,feegrant:false,
  endpoints:['https://rest.cosmos.directory/injective','https://injective-rest.publicnode.com']},
dydx:{name:'dYdX',chainId:'dydx-mainnet-1',denom:'adydx',display:'DYDX',dec:18,prefix:'dydx',color:'#6966FF',hasInflation:false,hasCommunityPool:true,cgId:'dydx-chain',txQueryFormat:'events',
  wasm:false,authz:false,feegrant:false,noTxQuery:true,
  endpoints:['https://rest.cosmos.directory/dydx','https://dydx-rest.publicnode.com']},
neutron:{name:'Neutron',chainId:'neutron-1',denom:'untrn',display:'NTRN',dec:6,prefix:'neutron',color:'#2E67FF',hasInflation:false,hasCommunityPool:false,cgId:'neutron-3',txQueryFormat:'events',
  wasm:true,authz:true,feegrant:true,govV1beta1:false,noTxQuery:true,noDistParams:true,
  endpoints:['https://rest.cosmos.directory/neutron','https://neutron-rest.publicnode.com']},
akash:{name:'Akash',chainId:'akashnet-2',denom:'uakt',display:'AKT',dec:6,prefix:'akash',color:'#FF414C',hasInflation:true,hasCommunityPool:true,cgId:'akash-network',txQueryFormat:'query',
  wasm:false,authz:true,feegrant:true,
  endpoints:['https://akash-rest.publicnode.com','https://rest.cosmos.directory/akash']},
sei:{name:'Sei',chainId:'pacific-1',denom:'usei',display:'SEI',dec:6,prefix:'sei',color:'#9B1C2E',hasInflation:false,hasCommunityPool:true,cgId:'sei-network',txQueryFormat:'events',
  wasm:true,authz:true,feegrant:true,govV1beta1:false,
  endpoints:['https://rest.cosmos.directory/sei','https://sei-rest.publicnode.com']},
nolus:{name:'Nolus',chainId:'pirin-1',denom:'unls',display:'NLS',dec:6,prefix:'nolus',color:'#2dd4bf',hasInflation:false,hasCommunityPool:true,cgId:'nolus',txQueryFormat:'events',  wasm:true,authz:false,feegrant:false,noTxQuery:false,
  endpoints:['https://rest.cosmos.directory/nolus','https://nolus-rest.publicnode.com']},
stride:{name:'Stride',chainId:'stride-1',denom:'ustrd',display:'STRD',dec:6,prefix:'stride',color:'#E91179',hasInflation:false,hasCommunityPool:true,cgId:'stride',txQueryFormat:'events',
  wasm:false,authz:false,feegrant:false,noTxQuery:true,
  endpoints:['https://rest.cosmos.directory/stride','https://stride-rest.publicnode.com']},
axelar:{name:'Axelar',chainId:'axelar-dojo-1',denom:'uaxl',display:'AXL',dec:6,prefix:'axelar',color:'#FFFFFF',hasInflation:true,hasCommunityPool:true,cgId:'axelar',txQueryFormat:'query',
  wasm:true,authz:false,feegrant:false,
  endpoints:['https://axelar-rest.publicnode.com','https://rest.cosmos.directory/axelar']},
juno:{name:'Juno',chainId:'juno-1',denom:'ujuno',display:'JUNO',dec:6,prefix:'juno',color:'#ff6b6b',hasInflation:true,hasCommunityPool:true,cgId:'juno-network',txQueryFormat:'query',
  wasm:true,authz:true,feegrant:true,
  endpoints:['https://juno-rest.publicnode.com','https://rest.cosmos.directory/juno']},
stargaze:{name:'Stargaze',chainId:'stargaze-1',denom:'ustars',display:'STARS',dec:6,prefix:'stars',color:'#ffd93d',hasInflation:false,hasCommunityPool:true,cgId:'stargaze',txQueryFormat:'query',
  wasm:true,authz:true,feegrant:true,
  endpoints:['https://stargaze-rest.publicnode.com','https://rest.cosmos.directory/stargaze']},
kujira:{name:'Kujira',chainId:'kaiyo-1',denom:'ukuji',display:'KUJI',dec:6,prefix:'kujira',color:'#465AE9',hasInflation:false,hasCommunityPool:true,cgId:'kujira',txQueryFormat:'events',
  wasm:true,authz:true,feegrant:false,noTxQuery:true,
  endpoints:['https://rest.cosmos.directory/kujira','https://kujira-rest.publicnode.com']},
evmos:{name:'Evmos',chainId:'evmos_9001-2',denom:'aevmos',display:'EVMOS',dec:18,prefix:'evmos',color:'#ED4E33',hasInflation:false,hasCommunityPool:true,cgId:'evmos',txQueryFormat:'events',
  wasm:false,authz:true,feegrant:false,noTxQuery:true,
  endpoints:['https://rest.cosmos.directory/evmos','https://evmos-rest.publicnode.com']},
noble:{name:'Noble',chainId:'noble-1',denom:'uusdc',display:'USDC',dec:6,prefix:'noble',color:'#2775CA',hasInflation:false,hasCommunityPool:false,cgId:'usd-coin',txQueryFormat:'query',
  wasm:false,authz:false,feegrant:false,govV1beta1:false,noDistParams:true,
  endpoints:['https://rest.cosmos.directory/noble']},
terra2:{name:'Terra',chainId:'phoenix-1',denom:'uluna',display:'LUNA',dec:6,prefix:'terra',color:'#5493F7',hasInflation:false,hasCommunityPool:true,cgId:'terra-luna-2',txQueryFormat:'query',
  wasm:true,authz:true,feegrant:true,
  endpoints:['https://terra-rest.publicnode.com','https://rest.cosmos.directory/terra2']},
persistence:{name:'Persistence',chainId:'core-1',denom:'uxprt',display:'XPRT',dec:6,prefix:'persistence',color:'#E50914',hasInflation:true,hasCommunityPool:false,cgId:'persistence',txQueryFormat:'query',
  wasm:false,authz:true,feegrant:false,
  endpoints:['https://rest.cosmos.directory/persistence','https://persistence-rest.publicnode.com']},
agoric:{name:'Agoric',chainId:'agoric-3',denom:'ubld',display:'BLD',dec:6,prefix:'agoric',color:'#BB2244',hasInflation:true,hasCommunityPool:true,cgId:'agoric',txQueryFormat:'query',
  wasm:false,authz:false,feegrant:false,
  endpoints:['https://rest.cosmos.directory/agoric']},
archway:{name:'Archway',chainId:'archway-1',denom:'aarch',display:'ARCH',dec:18,prefix:'archway',color:'#FF4D00',hasInflation:true,hasCommunityPool:true,cgId:'archway',txQueryFormat:'query',
  wasm:true,authz:false,feegrant:false,noTxQuery:true,
  endpoints:['https://rest.cosmos.directory/archway']},
coreum:{name:'Coreum',chainId:'coreum-mainnet-1',denom:'ucore',display:'CORE',dec:6,prefix:'core',color:'#25D695',hasInflation:false,hasCommunityPool:true,cgId:'coreum',txQueryFormat:'query',
  wasm:false,authz:true,feegrant:false,
  endpoints:['https://coreum-rest.publicnode.com','https://rest.cosmos.directory/coreum']},
sommelier:{name:'Sommelier',chainId:'sommelier-3',denom:'usomm',display:'SOMM',dec:6,prefix:'somm',color:'#F36D8B',hasInflation:true,hasCommunityPool:true,cgId:'sommelier',txQueryFormat:'events',
  wasm:false,authz:true,feegrant:false,noTxQuery:true,
  endpoints:['https://rest.cosmos.directory/sommelier']},
chihuahua:{name:'Chihuahua',chainId:'chihuahua-1',denom:'uhuahua',display:'HUAHUA',dec:6,prefix:'chihuahua',color:'#F5A623',hasInflation:true,hasCommunityPool:true,cgId:'chihuahua-token',txQueryFormat:'query',
  wasm:true,authz:true,feegrant:false,
  endpoints:['https://chihuahua-rest.publicnode.com','https://rest.cosmos.directory/chihuahua']},
band:{name:'Band Protocol',chainId:'laozi-mainnet',denom:'uband',display:'BAND',dec:6,prefix:'band',color:'#516AFF',hasInflation:true,hasCommunityPool:true,cgId:'band-protocol',txQueryFormat:'query',
  wasm:false,authz:true,feegrant:false,
  endpoints:['https://rest.cosmos.directory/bandchain']},
regen:{name:'Regen',chainId:'regen-1',denom:'uregen',display:'REGEN',dec:6,prefix:'regen',color:'#46B68F',hasInflation:true,hasCommunityPool:false,cgId:'regen',txQueryFormat:'query',
  wasm:false,authz:true,feegrant:false,
  endpoints:['https://rest.cosmos.directory/regen','https://regen-rest.publicnode.com']},
nibiru:{name:'Nibiru',chainId:'cataclysm-1',denom:'unibi',display:'NIBI',dec:6,prefix:'nibi',color:'#6A5ACD',hasInflation:false,hasCommunityPool:true,cgId:'nibiru',txQueryFormat:'events',
  wasm:true,authz:true,feegrant:false,noTxQuery:true,
  endpoints:['https://rest.cosmos.directory/nibiru','https://nibiru-rest.publicnode.com']},
saga:{name:'Saga',chainId:'ssc-1',denom:'usaga',display:'SAGA',dec:6,prefix:'saga',color:'#999999',hasInflation:false,hasCommunityPool:true,cgId:'saga-2',txQueryFormat:'query',
  wasm:false,authz:true,feegrant:false,
  endpoints:['https://rest.cosmos.directory/saga','https://saga-rest.publicnode.com']},
fetchai:{name:'Fetch.ai',chainId:'fetchhub-4',denom:'afet',display:'FET',dec:18,prefix:'fetch',color:'#1F2937',hasInflation:true,hasCommunityPool:true,cgId:'fetch-ai',txQueryFormat:'events',
  wasm:false,authz:false,feegrant:false,govV1beta1:false,noTxQuery:true,noSupplyDenom:true,noDistParams:true,
  endpoints:['https://rest.cosmos.directory/fetchhub']},
};

// ── State ────────────────────────────────────────────────────────────────────
let chain='cosmos', endpointIdx=0;
let latestBlock=null, prevBlock=null, prevBlockTs=null, blockTimes=[], tpsHistory=[];
let rollingBlocks=[], rollingTxs=[], lastListedHeight=0, lastTxHeight=0;
let allValidators=[];
let activePage='dashboard', activeValTab='bonded', activeGovTab='2';
let caps={govV1:true,govV1beta1:true,ibc:true,txByBlock:true};
let txByBlockCooldownUntil=0;
let polling={running:false,backoffMs:0,failStreak:0,lastTickAt:0};
let inflight=new Set();
const BD={},TD={},VD={},PD={};
const MAX_ROLLING=30;
let priceUsd=null, priceChange24h=null, priceFetchedAt=0;
let signingInfos={};
let currentTheme=localStorage.getItem('ar_theme')||'dark';
let consMap={}; // consensus addr -> moniker (feat 4)
let activityFeed=[]; // ticker (feat 1)
let communityTax=0; // APR calc (feat 7)
let crossChainCache={}; // cross-chain strip (feat 6)
let nakamotoCoeff=0;
let priceHistory=[]; // sparkline (feat 5)
var starPulse=0; // starfield pulse (feat 1)

// ── API Layer ────────────────────────────────────────────────────────────────

  // ===============================
  // REST failover (frontend-only)
  // ===============================
  function chainRestCandidates(chainObj) {
    const arr = (chainObj && Array.isArray(chainObj.rests) && chainObj.rests.length) ? chainObj.rests.slice() : [];
    if (chainObj && typeof chainObj.rest === "string" && chainObj.rest) arr.unshift(chainObj.rest);
    // de-dupe & sanitize
    const seen = new Set();
    const out = [];
    for (const u of arr) {
      const url = String(u).trim();
      if (!url) continue;
      const norm = url.replace(/\/+$/,"");
      if (seen.has(norm)) continue;
      seen.add(norm);
      out.push(norm);
    }
    return out.length ? out : [];
  }

  function setChain(chainObj) {
    setChain(chainObj);
state.rests = chainRestCandidates(chainObj);
    state.restIdx = 0;
    state.rest = state.rests[0] || (chainObj && chainObj.rest ? String(chainObj.rest).replace(/\/+$/,"") : "");
    state.caps = state.caps || {};
  }

  function currentRest() {
    return state.rest || "";
  }

  function rotateRest() {
    if (!Array.isArray(state.rests) || state.rests.length < 2) return false;
    state.restIdx = (state.restIdx + 1) % state.rests.length;
    state.rest = state.rests[state.restIdx];
    return true;
  }


function C(){return CHAINS[chain]}
function base(){return C().endpoints[endpointIdx]}
function cacheKey(n){return 'ar_'+chain+'_'+n}

function abortAll(){
  inflight.forEach(function(c){try{c.abort()}catch(_){}});
  inflight.clear();
}

function markOk(){
  polling.failStreak=0;
  polling.backoffMs=0;
  setSys('LIVE','ok','ep '+(endpointIdx+1)+'/'+C().endpoints.length);
}

function markFail(){
  polling.failStreak++;
  polling.backoffMs=Math.min(30000, 1000*Math.pow(2, Math.min(polling.failStreak,5)));
  if(polling.failStreak>=3) maybeFailover();
  setSys('DEGRADED', polling.failStreak>=3?'bad':'warn', 'retry in '+Math.round(polling.backoffMs/1000)+'s');
}

function maybeFailover(){
  var eps=C().endpoints;
  if(eps.length<=1) return;
  var next=(endpointIdx+1)%eps.length;
  if(next!==endpointIdx){
    endpointIdx=next;
    polling.failStreak=0;
    polling.backoffMs=0;
    setSys('FAILOVER','warn','switched to ep '+(endpointIdx+1));
  }
}

function get(path, opts){
  opts=opts||{};
  var timeoutMs=opts.timeoutMs||12000;
  var ac=new AbortController();
  inflight.add(ac);
  var timer=setTimeout(function(){ac.abort()}, timeoutMs);
  return fetch(base()+path, {signal:ac.signal, headers:{'Accept':'application/json'}})
    .then(function(r){
      clearTimeout(timer);
      inflight.delete(ac);
      if(!r.ok){var err=new Error('HTTP '+r.status);err.status=r.status;throw err}
      return r.json();
    })
    .then(function(data){
      markOk();
      return data;
    })
    .catch(function(e){
      clearTimeout(timer);
      inflight.delete(ac);
      if(e.name!=='AbortError') markFail();
      throw e;
    });
}


// ── Robust Tx Query Helper ──────────────────────────────────────────────────
// Some REST gateways intermittently 500 on tx-by-height queries.
// We try preferred format first, then fallback. On repeated 5xx/429 we disable txByBlock to stop console spam.
async function fetchTxsByHeight(height, limit){
  limit = limit || 50;

  // Hard cooldown to stop console spam if upstream gateway is flaky.
  if (typeof txByBlockCooldownUntil === 'number' && txByBlockCooldownUntil > Date.now()) {
    return { tx_responses: [], txs: [] };
  }

  if(!caps || caps.txByBlock===false) return { tx_responses: [], txs: [] };
  var h = String(height);
  var basePath='/cosmos/tx/v1beta1/txs';
  var eventsPath=basePath+'?events=tx.height%3D'+encodeURIComponent(h)+'&pagination.limit='+encodeURIComponent(String(limit));
  var queryPath =basePath+'?query='+encodeURIComponent('tx.height='+h)+'&pagination.limit='+encodeURIComponent(String(limit));

  // prefer chain config if present
  var prefer = (C()&&C().txQueryFormat==='query') ? 'query' : 'events';

  async function tryGet(path){
    return await get(path,{timeoutMs:7000});
  }

  try{
    if(prefer==='events') return await tryGet(eventsPath);
    return await tryGet(queryPath);
  }catch(e1){
    try{
      if(prefer==='events') return await tryGet(queryPath);
      return await tryGet(eventsPath);
    }catch(e2){
      var s1=(e1&&e1.status)||0, s2=(e2&&e2.status)||0;

      // If the gateway is returning 5xx/429, disable tx-by-height for a while.
      if(s1>=500||s2>=500||s1===429||s2===429){
        caps.txByBlock=false;
        txByBlockCooldownUntil = Date.now() + 10*60*1000; // 10 minutes
      }
      return { tx_responses: [], txs: [] };
    }
  }
}

// ── Sanitization & DOM Helpers ───────────────────────────────────────────────
var _escDiv=null;
function esc(s){
  if(s===null||s===undefined) return '';
  s=String(s);
  if(!_escDiv) _escDiv=document.createElement('div');
  _escDiv.textContent=s;
  return _escDiv.innerHTML;
}

function txt(id,val){
  var el=document.getElementById(id);
  if(el) el.textContent=String(val===null||val===undefined?'':val);
}

function setHTML(id,html){
  var el=document.getElementById(id);
  if(el) el.innerHTML=html;
}

function ld(msg){return '<div class="ld"><div class="sp"></div>'+esc(msg)+'</div>'}
function errH(msg){return '<div class="err"><div class="ei">&#9888;</div><div class="em">'+esc(msg)+'</div><div>Check network or try switching endpoints</div></div>'}
function setSys(label,level,meta){
  txt('sysStatus',label);
  txt('sysMeta',meta||'');
  var dot=document.getElementById('sysDot');
  if(dot){dot.className='sys-dot';if(level)dot.classList.add(level)}
}

// ── Formatting ───────────────────────────────────────────────────────────────
function fmt(raw,decimals){
  var n=parseFloat(raw||0);
  var d=C().dec;
  if(typeof decimals==='number') d=decimals;
  if(d>0) n=n/Math.pow(10,d);
  if(n>=1e12) return (n/1e12).toFixed(2)+'T';
  if(n>=1e9) return (n/1e9).toFixed(2)+'B';
  if(n>=1e6) return (n/1e6).toFixed(2)+'M';
  if(n>=1e3) return (n/1e3).toFixed(2)+'K';
  return n.toFixed(n<10?4:2);
}

function fmtInt(n){return parseInt(n||0).toLocaleString()}
function pctStr(v){return (parseFloat(v||0)*100).toFixed(2)+'%'}

function trim(s,l,r){
  s=String(s||'');
  if(s.length<=l+r+3) return s;
  return s.slice(0,l)+'\u2026'+s.slice(-r);
}

function ago(ts){
  if(!ts) return '\u2014';
  var d=Date.now()-new Date(ts).getTime();
  if(d<0)d=0;
  if(d<60000) return Math.floor(d/1000)+'s ago';
  if(d<3600000) return Math.floor(d/60000)+'m ago';
  if(d<86400000) return Math.floor(d/3600000)+'h ago';
  return Math.floor(d/86400000)+'d ago';
}

function looksBech32(v){
  return /^[a-z]{1,20}1[a-z0-9]{38,}$/i.test(v);
}

function copyBtn(text){
  var t=String(text||'');
  if(!t) return '';
  return '<span class="copy-btn" role="button" tabindex="0" data-copy="'+esc(t)+'">COPY</span>';
}

function dfRow(label,val,full,cls){
  return '<div class="df'+(full?' full':'')+'"><div class="df-l">'+esc(label)+'</div><div class="df-v'+(cls?' '+esc(cls):'')+'">'+val+'</div></div>';
}

// ── Transaction Type Detection ───────────────────────────────────────────────
var MSG_MAP={
  'MsgSend':['SEND','bt'],'MsgMultiSend':['MULTI-SEND','bt'],
  'MsgDelegate':['DELEGATE','bg'],'MsgUndelegate':['UNDELEGATE','br'],'MsgBeginRedelegate':['REDELEGATE','bo'],
  'MsgVote':['VOTE','bp'],'MsgDeposit':['DEPOSIT','by'],'MsgSubmitProposal':['PROPOSAL','bp'],
  'MsgTransfer':['IBC SEND','bp'],'MsgRecvPacket':['IBC RECV','bp'],'MsgAcknowledgement':['IBC ACK','bp'],'MsgUpdateClient':['IBC CLIENT','bx'],
  'MsgWithdrawDelegatorReward':['CLAIM','bg'],'MsgWithdrawValidatorCommission':['COMMISSION','bg'],
  'MsgCreateValidator':['CREATE VAL','by'],'MsgEditValidator':['EDIT VAL','by'],
  'MsgExecuteContract':['EXECUTE','bo'],'MsgInstantiateContract':['INSTANTIATE','bo'],'MsgMigrateContract':['MIGRATE','bo'],
  'MsgGrant':['AUTHZ GRANT','bx'],'MsgRevoke':['AUTHZ REVOKE','bx'],'MsgExec':['AUTHZ EXEC','bx'],
  'MsgSetWithdrawAddress':['SET WITHDRAW','bx'],'MsgFundCommunityPool':['FUND POOL','bg'],
  'MsgChannelOpenInit':['CHAN OPEN','bp'],'MsgChannelOpenTry':['CHAN TRY','bp'],
  'MsgChannelOpenAck':['CHAN ACK','bp'],'MsgChannelOpenConfirm':['CHAN CONFIRM','bp'],
  'MsgTimeout':['IBC TIMEOUT','br'],'MsgTimeoutOnClose':['IBC TIMEOUT','br'],
};

function txTag(msgs){
  if(!msgs||!msgs.length) return ['bx','UNKNOWN'];
  var t=msgs[0]['@type']||'';
  var short=t.split('.').pop();
  var m=MSG_MAP[short];
  if(m) return [m[1],m[0]];
  return ['bx',short.replace('Msg','').toUpperCase()||'UNKNOWN'];
}

function extractAmount(msgs){
  if(!msgs||!msgs.length) return '\u2014';
  var m=msgs[0];
  var amts=m.amount;
  if(amts&&Array.isArray(amts)&&amts.length>0){
    var a=amts[0];
    return fmt(a.amount)+' '+(a.denom===C().denom?C().display:String(a.denom||'').slice(0,10));
  }
  if(amts&&amts.amount){
    return fmt(amts.amount)+' '+(amts.denom===C().denom?C().display:String(amts.denom||'').slice(0,10));
  }
  if(m.token&&m.token.amount){
    return fmt(m.token.amount)+' '+(m.token.denom===C().denom?C().display:String(m.token.denom||'').slice(0,10));
  }
  return '\u2014';
}

// ── Block Rendering & Fetching ───────────────────────────────────────────────
function blockRow(d){
  BD[d.height]=d;
  var moniker=resolveProposer(d.proposer);
  return '<div class="row row-block" tabindex="0" role="button" data-bd="'+d.height+'" data-testid="block-row-'+d.height+'">'
    +'<div class="bk-num">#'+fmtInt(d.height)+'</div>'
    +'<div><div class="bk-hash">'+esc(trim(d.hash,10,6))+'</div>'
    +(moniker
      ?'<div class="bk-prop-name">'+esc(moniker)+'</div>'
      :'<div class="bk-prop">'+esc(trim(d.proposer,8,6))+'</div>')
    +'</div>'
    +'<div class="bk-txs"><span class="badge btx-num">'+esc(d.txCount)+' txs</span></div>'
    +'<div class="bk-time">'+esc(ago(d.time))+'</div></div>';
}

async function fetchBlocksTick(){
  try{
    var d=await get('/cosmos/base/tendermint/v1beta1/blocks/latest');
    var hdr=d.block.header;
    var h=parseInt(hdr.height);
    var txc=(d.block.data.txs||[]).length;
    var hash=d.block_id?d.block_id.hash:'';

    if(latestBlock&&h===latestBlock) return;
    prevBlock=latestBlock;
    latestBlock=h;
    if(prevBlock) flashNewBlock(); // Feature 2

    txt('mBlock',fmtInt(h));
    txt('hBlock',fmtInt(h));
    txt('nh-chainid',hdr.chain_id);

    var now=new Date(hdr.time).getTime();
    if(prevBlock&&prevBlockTs){
      var delta=(now-prevBlockTs)/1000;
      if(delta>0&&delta<60){
        blockTimes.push({h:h,ts:now,bt:delta,txc:txc});
        if(blockTimes.length>30) blockTimes.shift();
        tpsHistory.push(txc/delta);
        if(tpsHistory.length>30) tpsHistory.shift();
        txt('hBlockTime',delta.toFixed(1)+'s');
        txt('mBlockTime',delta.toFixed(1)+'s avg');
        var avgTps=tpsHistory.reduce(function(a,b){return a+b},0)/tpsHistory.length;
        txt('hTps',avgTps.toFixed(2));
        var est24=Math.round(avgTps*86400);
        txt('mTxCount',fmtInt(est24));
        drawTpsSparkline(); // Feature 5
      }
      renderBlockTimeChart();
    }
    prevBlockTs=now;
    // Update cross-chain active chain entry
    crossChainCache[chain]={block:h,bt:blockTimes.length?blockTimes[blockTimes.length-1].bt.toFixed(1):null,
      tps:tpsHistory.length?(tpsHistory.reduce(function(a,b){return a+b},0)/tpsHistory.length).toFixed(2):null,
      price:priceUsd,_ts:Date.now()};
    renderCCStrip();

    var entry={height:h,hash:hash,proposer:hdr.proposer_address,txCount:txc,time:hdr.time};
    if(!rollingBlocks.length||rollingBlocks[0].height<h){
      rollingBlocks.unshift(entry);
      if(rollingBlocks.length>MAX_ROLLING) rollingBlocks.pop();
    }

    if(h>lastListedHeight) lastListedHeight=h;
    var rows=rollingBlocks.map(blockRowFull).join('');
    setHTML('blockList',rows);
    setHTML('blocksPageList',rows);
    animateNewRows('blockList');
    animateNewRows('blocksPageList');
    // Lazily fetch gas for the newest block (non-blocking)
    if(rollingBlocks.length) fetchBlockGas(rollingBlocks[0].height).then(function(){
      // Re-render blocks page to show gas bars once loaded
      if(activePage==='blocks'||activePage==='dashboard'){
        var r2=rollingBlocks.map(blockRowFull).join('');
        setHTML('blockList',r2);
        if(activePage==='blocks') setHTML('blocksPageList',r2);
      }
    }).catch(function(){});

    try{
      localStorage.setItem(cacheKey('blocks'),JSON.stringify({blocks:rollingBlocks.slice(0,20),last:lastListedHeight}));
    }catch(_){}
  }catch(e){
    if(!rollingBlocks.length){
      setHTML('blockList',errH('Failed to load blocks'));
      setHTML('blocksPageList',errH('Failed to load blocks'));
    }
  }
}

// ── SHA-256 helper for tx hash computation ───────────────────────────────────
async function sha256hex(b64str){
  try{
    var raw=Uint8Array.from(atob(b64str),function(c){return c.charCodeAt(0)});
    var hash=await crypto.subtle.digest('SHA-256',raw);
    return Array.from(new Uint8Array(hash)).map(function(b){return b.toString(16).padStart(2,'0')}).join('').toUpperCase();
  }catch(_){return ''}
}

// ── Transaction Fetching ─────────────────────────────────────────────────────
async function fetchTransactionsTick(){
  if(!latestBlock) return;
  // Collect txs from blocks that have transactions
  var blocksToCheck=rollingBlocks.filter(function(b){return b.txCount>0}).slice(0,5);
  if(!blocksToCheck.length){
    if(!rollingTxs.length){
      setHTML('txList','<div class="ld" style="font-size:11px">No transactions in recent blocks</div>');
      setHTML('txPageList','<div class="ld" style="font-size:11px">No transactions in recent blocks</div>');
    }
    return;
  }

  try{
    for(var bi=0;bi<blocksToCheck.length;bi++){
      var blk=blocksToCheck[bi];
      if(blk._txFetched) continue;
      if(caps && caps.txByBlock===false){ blk._txFetched=true; continue; }
      try{
        var data=await fetchTxsByHeight(blk.height,50);
        var decodedTxs=data.txs||[];
        var encodedTxs=(data.block&&data.block.data?data.block.data.txs:null)||[];
        var txResponses=data.tx_responses||[];

        // If we got tx_responses (full data), use those
        if(txResponses.length){
          for(var i=0;i<txResponses.length;i++){
            var r=txResponses[i];
            var tx=decodedTxs[i]||(r.tx||{});
            var msgs=(tx.body?tx.body.messages:null)||[];
            var tagged=txTag(msgs);
            var entry={
              hash:r.txhash,ok:r.code===0,height:parseInt(r.height),
              tagClass:tagged[0],typeLabel:tagged[1],
              amount:extractAmount(msgs),ts:r.timestamp||blk.time,msgs:msgs
            };
            if(!TD[entry.hash]){
              rollingTxs.unshift(entry);
              TD[entry.hash]=entry;
            }
          }
        }
        // Otherwise, build from decoded txs + compute hashes
        else if(decodedTxs.length){
          for(var i=0;i<decodedTxs.length;i++){
            var tx2=decodedTxs[i];
            var msgs2=(tx2.body?tx2.body.messages:null)||[];
            var tagged2=txTag(msgs2);
            var txHash='';
            if(encodedTxs[i]){
              txHash=await sha256hex(encodedTxs[i]);
            }
            if(!txHash) txHash='BLOCK_'+blk.height+'_TX_'+i;
            var entry2={
              hash:txHash,ok:true,height:blk.height,
              tagClass:tagged2[0],typeLabel:tagged2[1],
              amount:extractAmount(msgs2),ts:blk.time,msgs:msgs2
            };
            if(!TD[entry2.hash]){
              rollingTxs.unshift(entry2);
              TD[entry2.hash]=entry2;
            }
          }
        }
        blk._txFetched=true;
      }catch(_){
        // Mark done even on failure — stops same height retrying every 6s tick
        blk._txFetched=true;
      }
    }

    // Keep rolling txs within limit and sorted by height desc
    rollingTxs.sort(function(a,b){return b.height-a.height});
    rollingTxs=rollingTxs.slice(0,MAX_ROLLING);

    var rows=rollingTxs.slice(0,20).map(function(d){
      return '<div class="row row-tx" tabindex="0" role="button" data-td="'+esc(d.hash)+'" data-testid="tx-row">'+
        '<div class="tx-hash">'+esc(trim(d.hash,9,6))+'</div>'+
        '<div><span class="badge '+esc(d.tagClass)+'">'+esc(d.typeLabel)+'</span>'+(d.ok?'':'<span class="badge br" style="margin-left:4px">FAILED</span>')+'</div>'+
        '<div class="tx-amt '+(d.ok?'c-g':'c-r')+'">'+esc(d.amount)+'</div>'+
        '<div class="tx-time2">'+esc(ago(d.ts))+'</div></div>';
    }).join('');
    setHTML('txList',rows||'<div class="ld" style="font-size:11px">Waiting for transactions...</div>');
    feedTicker(rollingTxs.slice(0,12)); // Feature 1b — Activity ticker
    applyTxFilter(); // Feature 9 — re-render filtered tx page
    animateNewRows('txList'); // Feature 13

    try{
      localStorage.setItem(cacheKey('txs'),JSON.stringify({txs:rollingTxs.slice(0,20)}));
    }catch(_){}
  }catch(e){
    if(!rollingTxs.length){
      setHTML('txList',errH('Failed to load transactions'));
      setHTML('txPageList',errH('Failed to load transactions'));
    }
  }
}

// ── Validators ───────────────────────────────────────────────────────────────
async function fetchValidators(){
  try{
    var statusMap={bonded:'BOND_STATUS_BONDED',unbonding:'BOND_STATUS_UNBONDING',unbonded:'BOND_STATUS_UNBONDED'};
    var st=statusMap[activeValTab]||statusMap.bonded;
    var data=await get('/cosmos/staking/v1beta1/validators?status='+st+'&pagination.limit=150');
    var vals=data.validators||[];
    allValidators=vals;
    computeAndRenderNakamoto(vals); // Feature 3
    fetchValidatorSet().catch(function(){}); // Feature 4 - build proposer name map
    var totalTokens=vals.reduce(function(s,v){return s+parseFloat(v.tokens||0)},0);

    var sorted=vals.slice().sort(function(a,b){return parseFloat(b.tokens||0)-parseFloat(a.tokens||0)});
    txt('mVals',sorted.length);
    txt('mValsActive',activeValTab+' set');

    function valRow(v,i){
      var desc=v.description||{};
      var name=desc.moniker||'Unknown';
      var tokens=parseFloat(v.tokens||0);
      var vp=totalTokens>0?(tokens/totalTokens*100):0;
      var comm=pctStr(v.commission?v.commission.commission_rates?v.commission.commission_rates.rate:0:0);
      var jailed=v.jailed;
      var initial=name.charAt(0).toUpperCase();
      var hue=(name.charCodeAt(0)*37)%360;
      var key=v.operator_address;
      VD[key]={v:v,name:name,addr:key,vp:vp.toFixed(2),tokens:tokens,commission:comm,desc:desc};

      return '<div class="row row-val" tabindex="0" role="button" data-vd="'+esc(key)+'" data-testid="val-row-'+i+'">'+
        '<div class="val-rank">'+(i+1)+'</div>'+
        '<div class="val-info">'+
          '<div class="val-av" style="background:hsl('+hue+',60%,20%);color:hsl('+hue+',80%,70%)">'+esc(initial)+'</div>'+
          '<div style="min-width:0"><div class="val-nm">'+esc(name)+'</div><div class="val-op">'+esc(trim(key,12,6))+'</div></div>'+
        '</div>'+
        '<div><div class="val-vp-pct">'+vp.toFixed(2)+'%</div><div class="vp-bar"><div class="vp-fill" style="width:'+Math.min(vp*2,100)+'%"></div></div></div>'+
        '<div class="val-comm">'+esc(comm)+'</div>'+
        '<div style="text-align:center">'+(jailed?'<span class="sdot off"></span>':'<span class="sdot on"></span>')+'</div>'+
        '<div style="font-family:var(--mono);font-size:10px;text-align:right;color:var(--txt)">'+esc(fmt(tokens))+'</div></div>';
    }

    var rows=sorted.map(valRow).join('');
    if(!rows) rows='<div class="ld" style="font-size:11px">No '+activeValTab+' validators found</div>';
    setHTML('valPageList',rows);
    setHTML('dashValList',sorted.slice(0,8).map(valRow).join(''));
  }catch(e){
    setHTML('valPageList',errH('Failed to load validators'));
    if(!document.getElementById('dashValList').children.length||document.getElementById('dashValList').querySelector('.ld')){
      setHTML('dashValList',errH('Failed to load validators'));
    }
  }
}

// ── Chain Info (stats) ───────────────────────────────────────────────────────
async function fetchChainInfo(){
  var results=await Promise.allSettled([
    get('/cosmos/staking/v1beta1/params'),
    get('/cosmos/staking/v1beta1/pool'),
    C().hasInflation?get('/cosmos/mint/v1beta1/inflation'):Promise.resolve(null),
    caps.supplyByDenom!==false?get('/cosmos/bank/v1beta1/supply/by_denom?denom='+encodeURIComponent(C().denom)):Promise.resolve(null),
    C().hasCommunityPool!==false?get('/cosmos/distribution/v1beta1/community_pool'):Promise.resolve(null),
  ]);

  var stkR=results[0],poolR=results[1],inflR=results[2],supR=results[3],comR=results[4];

  if(stkR.status==='fulfilled'){
    var p=stkR.value.params||{};
    var ub=p.unbonding_time?Math.round(parseInt(p.unbonding_time)/86400)+' days':'\u2014';
    txt('nh-unbonding',ub);
    txt('nh-maxval',p.max_validators||'\u2014');
    txt('nh-mincomm',p.min_commission_rate?(parseFloat(p.min_commission_rate)*100).toFixed(0)+'%':'0%');
  }

  var totalSupply=0;
  if(supR.status==='fulfilled'&&supR.value){
    var supData=supR.value;
    var s=supData.amount||(supData.supply||[]).find(function(x){return x.denom===C().denom});
    if(s){
      totalSupply=parseFloat(s.amount||0);
      txt('mSupply',fmt(s.amount));
      txt('mSupplyDenom',C().display+' total');
    }else{
      txt('mSupply','N/A');
      txt('mSupplyDenom','supply');
    }
  }else{
    if(supR.status==='rejected') caps.supplyByDenom=false; // stop retrying this endpoint
    txt('mSupply','N/A');
    txt('mSupplyDenom','supply');
  }

  if(poolR.status==='fulfilled'){
    var pool=poolR.value.pool||{};
    var bonded=parseFloat(pool.bonded_tokens||0);
    var notBonded=parseFloat(pool.not_bonded_tokens||0);
    var useTotal=totalSupply>0?totalSupply:bonded+notBonded;
    var ratio=useTotal>0?((bonded/useTotal)*100).toFixed(1)+'%':'\u2014';
    txt('mBonded',fmt(bonded)+' '+C().display);
    txt('mBondRatio',ratio+' bonded');
    txt('hBonded',ratio);
    renderSupplyVis(bonded,notBonded,useTotal);
  }

  if(inflR.status==='fulfilled'&&inflR.value&&inflR.value.inflation!==undefined){
    var inflVal=parseFloat(inflR.value.inflation);
    txt('mInflation',(inflVal*100).toFixed(2)+'%');
    // Feature 7 — compute APR once we also have bonded ratio
    if(poolR.status==='fulfilled'){
      var _pool=poolR.value.pool||{};
      var _bonded=parseFloat(_pool.bonded_tokens||0);
      var _supply=totalSupply>0?totalSupply:_bonded+parseFloat(_pool.not_bonded_tokens||0);
      if(_supply>0) renderAPR(inflVal, _bonded/_supply);
    }
  }else{
    txt('mInflation','N/A');
  }


  if(comR.status==='fulfilled'&&comR.value){
    var cd=C().denom;
    var cp2=(comR.value.pool||[]).find(function(x){return x.denom===cd});
    if(cp2){txt('mPool',fmt(parseFloat(cp2.amount||0)));txt('mPoolDenom',C().display+' pool')}
    else{txt('mPool','N/A');txt('mPoolDenom','pool')}
  }else{
    txt('mPool','N/A');txt('mPoolDenom','pool');
  }

  try{
    var snapshot={ts:Date.now(),top:{}};
    ['nh-unbonding','nh-maxval','nh-mincomm','nh-chainid','mBonded','mBondRatio','mInflation','mSupply','mSupplyDenom','mPool','mPoolDenom','hBonded'].forEach(function(id){
      var el=document.getElementById(id);
      if(el) snapshot.top[id]=el.textContent;
    });
    localStorage.setItem(cacheKey('chainInfo'),JSON.stringify(snapshot));
  }catch(_){}
}

// ── Supply Vis ───────────────────────────────────────────────────────────────
function renderSupplyVis(bonded,notBonded,total){
  if(!total) return;
  var bPct=(bonded/total*100).toFixed(1);
  var uPct=(notBonded/total*100).toFixed(1);
  var lPct=(100-parseFloat(bPct)-parseFloat(uPct)).toFixed(1);
  setHTML('supplyVis',
    '<div style="font-family:var(--mono);font-size:12px;color:var(--txt2);margin-bottom:8px">Total: '+esc(fmt(total))+' '+esc(C().display)+'</div>'+
    '<div class="supply-bar"><div class="sb-bonded" style="width:'+bPct+'%"></div><div class="sb-unbond" style="width:'+uPct+'%"></div><div class="sb-liquid" style="width:'+lPct+'%"></div></div>'+
    '<div class="supply-legend">'+
      '<div class="sl-item"><div class="sl-dot" style="background:var(--c)"></div>Bonded '+esc(bPct)+'%</div>'+
      '<div class="sl-item"><div class="sl-dot" style="background:var(--c6)"></div>Unbonding '+esc(uPct)+'%</div>'+
      '<div class="sl-item"><div class="sl-dot" style="background:var(--dim)"></div>Liquid '+esc(lPct)+'%</div>'+
    '</div>');
}

// ── Block Time Chart ─────────────────────────────────────────────────────────
function renderBlockTimeChart(){
  if(blockTimes.length<2) return;
  var max=Math.max.apply(null,blockTimes.map(function(b){return b.bt}));
  var avg=blockTimes.reduce(function(s,b){return s+b.bt},0)/blockTimes.length;
  var bars=blockTimes.map(function(b){
    var h=max>0?Math.max(4, (b.bt/max)*36):4;
    var hi=b.bt>avg*1.5?'hi':'';
    return '<div class="bt-bar '+hi+'" style="height:'+h+'px" title="Block '+b.h+': '+b.bt.toFixed(1)+'s"></div>';
  }).join('');
  setHTML('btChart',bars);
}

// ── Governance ───────────────────────────────────────────────────────────────
async function fetchGovernance(status){
  var st=status||activeGovTab;
  if(!caps.govV1&&!caps.govV1beta1){
    setHTML('dashGovList',errH('Governance unsupported'));
    setHTML('govPageList',errH('Governance unsupported'));
    txt('propBadge','N/A'); return;
  }
  var proposals=[];
  if(caps.govV1){
    try{var d=await get('/cosmos/gov/v1/proposals?proposal_status='+encodeURIComponent(st)+'&pagination.limit=50');proposals=d.proposals||[]}
    catch(_){caps.govV1=false}
  }
  if(!proposals.length&&caps.govV1beta1){
    try{var d2=await get('/cosmos/gov/v1beta1/proposals?proposal_status='+encodeURIComponent(st)+'&pagination.limit=50');proposals=d2.proposals||[]}
    catch(_){caps.govV1beta1=false}
  }
  var dashProps=proposals;
  if(!status){
    var p2=[];
    try{
      if(caps.govV1){try{var dd=await get('/cosmos/gov/v1/proposals?proposal_status=3&pagination.limit=5');p2=dd.proposals||[]}catch(_){}}
      if(!p2.length&&caps.govV1beta1){try{var dd2=await get('/cosmos/gov/v1beta1/proposals?proposal_status=3&pagination.limit=5');p2=dd2.proposals||[]}catch(_){}}
    }catch(_){}
    // Merge + dedupe + sort newest first + take top 6
    var seen={};
    dashProps=sortProps([].concat(proposals,p2).filter(function(p){
      var id=String(p.id||p.proposal_id||'');
      return seen[id]?false:(seen[id]=true);
    })).slice(0,6);
  }
  txt('propBadge',dashProps.length+' PROPS');
  setHTML('dashGovList',renderProps(dashProps));
  if(!status||status===activeGovTab) setHTML('govPageList',renderProps(proposals));
}

// ── IBC ──────────────────────────────────────────────────────────────────────
async function fetchIBC(){
  if(!caps.ibc){setHTML('ibcChList',errH('IBC unsupported'));return}
  var results=await Promise.allSettled([
    get('/ibc/core/channel/v1/channels?pagination.limit=50'),
    get('/ibc/core/connection/v1/connections?pagination.limit=50'),
    get('/ibc/core/client/v1/client_states?pagination.limit=50'),
  ]);
  var chR=results[0],connR=results[1],clientR=results[2];

  if(chR.status==='fulfilled'){
    var chs=chR.value.channels||[];
    txt('ibcChBadge',chs.length+' CH');
    setHTML('ibcChList',chs.slice(0,30).map(function(ch){
      var open=ch.state==='STATE_OPEN';
      return '<div class="row row-ibc" tabindex="0" role="group">'+
        '<div><div class="ibc-ch">'+esc(ch.channel_id)+' \u2194 '+esc((ch.counterparty||{}).channel_id||'?')+'</div><div class="ibc-sub">'+esc(ch.port_id)+' / '+esc((ch.counterparty||{}).port_id||'?')+'</div></div>'+
        '<div class="ibc-stat" style="color:'+(open?'var(--c5)':'var(--c3)')+'">'+(open?'OPEN':'CLOSED')+'</div>'+
        '<div class="ibc-stat c-d">'+esc(((ch.ordering||'').replace('ORDER_',''))||'?')+'</div>'+
        '<div class="ibc-stat c-d">'+esc((ch.connection_hops||[])[0]||'?')+'</div></div>';
    }).join('')||'<div class="ld" style="font-size:11px">No channels</div>');
  }else{caps.ibc=false;setHTML('ibcChList',errH('IBC channels unavailable'))}

  if(connR.status==='fulfilled'){
    var conns=connR.value.connections||[];
    txt('ibcConnBadge',conns.length+' CONN');
    setHTML('ibcConnList',conns.slice(0,20).map(function(c){
      var open=c.state==='STATE_OPEN';
      return '<div class="row" tabindex="0" role="group" style="grid-template-columns:1fr 80px;gap:12px">'+
        '<div><div class="ibc-ch">'+esc(c.id)+'</div><div class="ibc-sub">'+esc(c.client_id)+' \u2194 '+esc((c.counterparty||{}).client_id||'?')+'</div></div>'+
        '<div class="ibc-stat" style="color:'+(open?'var(--c5)':'var(--c3)')+'">'+(open?'OPEN':'?')+'</div></div>';
    }).join('')||'<div class="ld" style="font-size:11px">No connections</div>');
  }else setHTML('ibcConnList',errH('IBC connections unavailable'));

  if(clientR.status==='fulfilled'){
    var clients=clientR.value.client_states||[];
    txt('ibcClientBadge',clients.length+' CL');
    setHTML('ibcClientList',clients.slice(0,30).map(function(c){
      var cs=c.client_state||{};
      var frozen=((cs.frozen_height||{}).revision_height||0)>0;
      return '<div class="row" tabindex="0" role="group" style="grid-template-columns:100px 1fr 1fr 80px;gap:12px">'+
        '<div class="ibc-ch">'+esc(c.client_id)+'</div>'+
        '<div style="font-size:11px;color:var(--txt2)">'+esc(((cs['@type']||'').split('.').pop()||'?'))+'</div>'+
        '<div class="ibc-sub">'+esc(cs.chain_id||'?')+'</div>'+
        '<div style="font-family:var(--mono);font-size:10px;text-align:right">'+(frozen?'<span style="color:var(--c3)">FROZEN</span>':'<span style="color:var(--c5)">ACTIVE</span>')+'</div></div>';
    }).join('')||'<div class="ld" style="font-size:11px">No clients</div>');
  }else setHTML('ibcClientList',errH('IBC clients unavailable'));
}

// ── Assets ───────────────────────────────────────────────────────────────────
async function fetchAssets(){
  try{
    var data=await get('/cosmos/bank/v1beta1/supply?pagination.limit=200');
    var supply=data.supply||[];
    txt('assetBadge',supply.length+' DENOMS');
    setHTML('assetList',supply.slice(0,80).map(function(s){
      var denom=String(s.denom||'');
      var isN=denom===C().denom, isI=denom.startsWith('ibc/'), isF=denom.startsWith('factory/');
      var tag='bx',label='OTHER';
      if(isN){tag='bt';label='NATIVE'}
      else if(isI){tag='bp';label='IBC'}
      else if(isF){tag='bo';label='FACTORY'}
      else if(denom.startsWith('u')||denom.startsWith('a')){tag='bg';label='COIN'}
      return '<div class="row" tabindex="0" role="group" style="grid-template-columns:1fr 140px 80px;gap:12px">'+
        '<div><div style="font-family:var(--mono);font-size:11px;color:'+(isN?'var(--c)':'var(--txt2)')+'">'+esc(denom.slice(0,60))+'</div>'+
        (isI?'<div style="font-family:var(--mono);font-size:9px;color:var(--dim)">hash: '+esc(denom.slice(4,20))+'\u2026</div>':'')+
        '</div>'+
        '<div style="font-family:var(--mono);font-size:12px;text-align:right;color:var(--txt2)">'+esc(fmt(s.amount,isN?C().dec:6))+'</div>'+
        '<div style="text-align:right"><span class="badge '+esc(tag)+'">'+esc(label)+'</span></div></div>';
    }).join('')||'<div class="ld" style="font-size:11px">No assets</div>');
  }catch(e){setHTML('assetList',errH('Failed to load assets'))}
}

// ── CoinGecko Price Integration ──────────────────────────────────────────────
var priceCache={};
var priceCacheTs=0;

async function fetchPrice(){
  var cgId=C().cgId;
  if(!cgId){txt('hPrice','N/A');return}
  // Check memory cache (2 min per chain)
  if(priceCache[cgId]&&Date.now()-priceCache[cgId].ts<120000){
    priceUsd=priceCache[cgId].usd;
    priceChange24h=priceCache[cgId].chg;
    updatePriceDisplay();
    return;
  }
  // Check localStorage (10 min global cache)
  try{
    var cached=JSON.parse(localStorage.getItem('ar_prices')||'null');
    if(cached&&cached[cgId]&&Date.now()-cached._ts<600000){
      priceUsd=cached[cgId].usd;
      priceChange24h=cached[cgId].chg;
      priceCache[cgId]={usd:priceUsd,chg:priceChange24h,ts:Date.now()};
      updatePriceDisplay();
      if(Date.now()-cached._ts<300000) return; // skip API if <5 min old
    }
  }catch(_){}
  // Batch fetch all chain prices in ONE request to conserve rate limit
  try{
    var allIds=Object.values(CHAINS).map(function(c){return c.cgId}).filter(Boolean);
    var uniqueIds=[...new Set(allIds)].join(',');
    var r=await fetch('https://api.coingecko.com/api/v3/simple/price?ids='+encodeURIComponent(uniqueIds)+'&vs_currencies=usd&include_24hr_change=true',{signal:AbortSignal.timeout(10000)});
    if(r.status===429){
      if(priceUsd===null) tryLoadPriceFromLS(cgId);
      return;
    }
    if(!r.ok) return;
    var d=await r.json();
    var lsObj={_ts:Date.now()};
    Object.keys(d).forEach(function(id){
      var coin=d[id];
      priceCache[id]={usd:coin.usd||null,chg:coin.usd_24h_change||null,ts:Date.now()};
      lsObj[id]={usd:coin.usd,chg:coin.usd_24h_change};
    });
    try{localStorage.setItem('ar_prices',JSON.stringify(lsObj))}catch(_){}
    if(priceCache[cgId]){
      priceUsd=priceCache[cgId].usd;
      priceChange24h=priceCache[cgId].chg;
      priceFetchedAt=Date.now();
      updatePriceDisplay();
    }
  }catch(_){
    if(priceUsd===null) tryLoadPriceFromLS(cgId);
  }
}

function tryLoadPriceFromLS(cgId){
  try{
    var cached=JSON.parse(localStorage.getItem('ar_prices')||'null');
    if(cached&&cached[cgId]){
      priceUsd=cached[cgId].usd;
      priceChange24h=cached[cgId].chg;
      updatePriceDisplay();
    }
  }catch(_){}
}

function updatePriceDisplay(){
  if(priceUsd===null) return;
  txt('hPrice','$'+priceUsd.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:priceUsd<1?6:priceUsd<100?4:2}));
  var el=document.getElementById('hPrice');
  if(el&&priceChange24h!==null){
    el.title=C().display+' 24h: '+(priceChange24h>=0?'+':'')+priceChange24h.toFixed(2)+'%';
    el.style.color=priceChange24h>=0?'var(--c5)':'var(--c3)';
  }
  drawPriceSparkline(); // Feature 6 — redraw when price refreshes
}

function usdValue(rawAmt){
  if(!priceUsd||!rawAmt) return '';
  var n=parseFloat(rawAmt)/Math.pow(10,C().dec);
  if(isNaN(n)||n<=0) return '';
  var usd=n*priceUsd;
  if(usd<0.01) return '';
  return '<span class="usd-val">($'+usd.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})+')</span>';
}

// ── Theme Toggle ─────────────────────────────────────────────────────────────
function applyTheme(t){
  currentTheme=t;
  document.documentElement.setAttribute('data-theme',t);
  var btn=document.getElementById('themeBtn');
  if(btn) btn.innerHTML=t==='light'?'&#9790;':'&#9788;';
  try{localStorage.setItem('ar_theme',t)}catch(_){}
}
function toggleTheme(){applyTheme(currentTheme==='dark'?'light':'dark')}

// ── Validator Signing Info (Uptime) ──────────────────────────────────────────
async function fetchSigningInfos(){
  try{
    var data=await get('/cosmos/slashing/v1beta1/signing_infos?pagination.limit=200');
    var infos=data.info||[];
    signingInfos={};
    infos.forEach(function(si){
      var addr=si.address||'';
      signingInfos[addr]={
        missed:parseInt(si.missed_blocks_counter||0),
        tombstoned:si.tombstoned||false,
        jailedUntil:si.jailed_until||''
      };
    });
  }catch(_){}
}

// ── Account Transaction History ──────────────────────────────────────────────
async function fetchAccountTxs(address){
  try{
    // Try GetBlockWithTxs approach - search for sender events
    var data=await get('/cosmos/tx/v1beta1/txs?events='+encodeURIComponent("message.sender='"+address+"'")+'&pagination.limit=10&order_by=ORDER_BY_DESC',{timeoutMs:10000});
    var txResp=data.tx_responses||[];
    var txs=data.txs||[];
    if(!txResp.length) return '<div style="color:var(--dim);font-size:11px">No transaction history available for this endpoint</div>';
    return txResp.map(function(r,i){
      var tx=txs[i]||r.tx||{};
      var msgs=(tx.body?tx.body.messages:null)||[];
      var tagged=txTag(msgs);
      var ok=r.code===0;
      return '<div class="acct-tx-row">'+
        '<div class="mono c-c" style="font-size:10px;cursor:pointer" data-copy="'+esc(r.txhash)+'">'+esc(trim(r.txhash,8,6))+'</div>'+
        '<div><span class="badge '+esc(tagged[0])+'" style="font-size:9px">'+esc(tagged[1])+'</span>'+(ok?'':'<span class="badge br" style="margin-left:3px;font-size:9px">FAIL</span>')+'</div>'+
        '<div style="font-size:10px;text-align:right;color:var(--dim)">'+esc(ago(r.timestamp))+'</div></div>';
    }).join('');
  }catch(_){
    return '<div style="color:var(--dim);font-size:11px">Transaction indexing unavailable on this endpoint</div>';
  }
}

// ── Parameters ───────────────────────────────────────────────────────────────
async function fetchParams(){
  var results=await Promise.allSettled([
    get('/cosmos/staking/v1beta1/params'),
    get('/cosmos/slashing/v1beta1/params'),
    caps.distParams!==false?get('/cosmos/distribution/v1beta1/params'):Promise.resolve(null),
    caps.govParams!==false?(
      caps.govV1?get('/cosmos/gov/v1/params/tallying').catch(function(){return get('/cosmos/gov/v1beta1/params/tallying')}):
      caps.govV1beta1?get('/cosmos/gov/v1beta1/params/tallying'):Promise.resolve(null)
    ):Promise.resolve(null),
    C().hasInflation?get('/cosmos/mint/v1beta1/params'):Promise.resolve(null),
  ]);

  function paramHTML(obj){
    if(!obj) return '<div class="ld" style="font-size:11px">Unavailable</div>';
    var entries=Object.entries(obj);
    return entries.map(function(kv){
      var k=kv[0],v=kv[1];
      var label=k.replace(/_/g,' ').toUpperCase();
      var val=typeof v==='object'?JSON.stringify(v):String(v);
      if(/rate|ratio|threshold|fraction|percentage/.test(k)&&parseFloat(val)<=1) val=pctStr(val);
      if(/time$/.test(k)&&parseInt(val)>86400) val=Math.round(parseInt(val)/86400)+' days';
      return '<div class="param-item"><div class="param-lbl">'+esc(label)+'</div><div class="param-val">'+esc(val)+'</div></div>';
    }).join('');
  }

  if(results[0].status==='fulfilled'){
    setHTML('stakingParams',paramHTML(results[0].value.params||{}));
  }else setHTML('stakingParams',errH('Failed to load'));

  if(results[1].status==='fulfilled'){
    setHTML('slashingParams',paramHTML(results[1].value.params||{}));
  }else setHTML('slashingParams',errH('Failed to load'));

  if(results[2].status==='fulfilled'&&results[2].value){
    setHTML('distParams',paramHTML(results[2].value.params||{}));
  }else{
    if(results[2].status==='rejected') caps.distParams=false;
    setHTML('distParams',errH('Failed to load'));
  }

  if(results[3].status==='fulfilled'&&results[3].value){
    var gp=results[3].value.tally_params||results[3].value.params||{};
    setHTML('govParams',paramHTML(gp));
  }else{
    if(results[3].status==='rejected') caps.govParams=false;
    setHTML('govParams',errH('Failed to load'));
  }

  if(results[4].status==='fulfilled'&&results[4].value){
    setHTML('mintParams',paramHTML(results[4].value.params||{}));
  }else setHTML('mintParams','<div class="ld" style="font-size:11px">'+(C().hasInflation?'Failed to load':'Not applicable for this chain')+'</div>');
}

// ── Search ───────────────────────────────────────────────────────────────────
function closeSearch(){
  var p=document.getElementById('searchPanel');
  if(p) p.classList.remove('show');
}

function showSearchPanel(title,html){
  var panel=document.getElementById('searchPanel');
  panel.classList.add('show');
  txt('searchPanelTitle',title);
  setHTML('searchPanelBody',html);
  panel.scrollIntoView({behavior:'smooth',block:'nearest'});
}

async function doSearchValue(val){
  val=String(val||'').trim();
  if(!val) return;
  showSearchPanel('SEARCHING\u2026',ld('SEARCHING'));

  try{
    if(/^\d+$/.test(val)){
      var d=await get('/cosmos/base/tendermint/v1beta1/blocks/'+encodeURIComponent(val));
      var bh=d.block.header;
      var txc=(d.block.data.txs||[]).length;
      showSearchPanel('BLOCK #'+val,
        '<div class="dg">'+
        dfRow('Height','<span class="c-c">#'+esc(fmtInt(bh.height))+'</span>')+
        dfRow('Transactions','<span class="c-g">'+esc(txc)+'</span>')+
        dfRow('Timestamp',esc(new Date(bh.time).toUTCString()),true)+
        dfRow('Block Hash',esc((d.block_id||{}).hash||'\u2014')+copyBtn((d.block_id||{}).hash),true)+
        dfRow('Proposer',esc(bh.proposer_address)+copyBtn(bh.proposer_address),true)+
        dfRow('Parent Hash',esc((bh.last_block_id||{}).hash||'\u2014'),true)+
        dfRow('Chain ID',esc(bh.chain_id))+
        '</div>');
      return;
    }

    if(/^[A-Fa-f0-9]{64}$/.test(val)){
      var d2=await get('/cosmos/tx/v1beta1/txs/'+encodeURIComponent(val.toUpperCase()));
      var resp=d2.tx_response,tx=d2.tx;
      var msgs=tx&&tx.body?tx.body.messages||[]:[];
      var tagged=txTag(msgs);
      var ok=resp.code===0;
      var msgCards=msgs.map(function(m,i){
        var typeName=esc((m['@type']||'').split('.').pop()||'Unknown');
        var jsonStr=JSON.stringify(m,null,2);
        var clean=esc(jsonStr.slice(0,1200))+(jsonStr.length>1200?'\u2026':'');
        return '<div class="msg-item"><div class="msg-type">MSG '+(i+1)+': '+typeName+'</div><div class="msg-body"><pre>'+clean+'</pre></div></div>';
      }).join('');

      showSearchPanel('TRANSACTION',
        '<div class="dg">'+
        dfRow('Hash',esc(val)+copyBtn(val),true)+
        dfRow('Status',ok?'<span class="c-g">&#10003; SUCCESS</span>':'<span class="c-r">&#10007; FAILED (code '+esc(resp.code)+')</span>')+
        dfRow('Type','<span class="badge bt">'+esc(tagged[1])+'</span>')+
        dfRow('Block','<span class="c-c">#'+esc(fmtInt(resp.height))+'</span>')+
        dfRow('Timestamp',resp.timestamp?esc(new Date(resp.timestamp).toUTCString()):'\u2014',true)+
        dfRow('Gas Used / Wanted',esc(fmtInt(resp.gas_used)+' / '+fmtInt(resp.gas_wanted)))+
        dfRow('Messages',esc(msgs.length+' message(s)'))+
        dfRow('Memo',esc((tx&&tx.body?tx.body.memo:'')||'(none)'),true)+
        '<div class="df-sep"></div></div>'+
        '<div class="msg-list">'+msgCards+'</div>');
      return;
    }

    if(val.includes('valoper')){
      var d3=await get('/cosmos/staking/v1beta1/validators/'+encodeURIComponent(val));
      var v=d3.validator,desc=v.description||{};
      showSearchPanel('VALIDATOR',
        '<div class="dg">'+
        dfRow('Moniker','<span class="c-c fw7">'+esc(desc.moniker||'\u2014')+'</span>',true)+
        dfRow('Operator',esc(val)+copyBtn(val),true)+
        dfRow('Status','<span class="c-g">'+esc((v.status||'').replace('BOND_STATUS_',''))+'</span>')+
        dfRow('Jailed',v.jailed?'<span class="c-r">YES</span>':'<span class="c-g">NO</span>')+
        dfRow('Voting Power',esc(fmt(v.tokens||0)+' '+C().display))+
        dfRow('Commission',esc(pctStr(v.commission?v.commission.commission_rates?v.commission.commission_rates.rate:0:0)))+
        dfRow('Max Commission',esc(pctStr(v.commission?v.commission.commission_rates?v.commission.commission_rates.max_rate:0:0)))+
        dfRow('Website',esc(desc.website||'\u2014'),true)+
        dfRow('Details',esc(String(desc.details||'\u2014').slice(0,400)),true)+
        '</div>');
      return;
    }

    if(looksBech32(val)){
      var results2=await Promise.allSettled([
        get('/cosmos/bank/v1beta1/balances/'+encodeURIComponent(val)+'?pagination.limit=50'),
        get('/cosmos/staking/v1beta1/delegations/'+encodeURIComponent(val)+'?pagination.limit=20'),
        get('/cosmos/staking/v1beta1/delegators/'+encodeURIComponent(val)+'/unbonding_delegations?pagination.limit=10'),
        get('/cosmos/distribution/v1beta1/delegators/'+encodeURIComponent(val)+'/rewards'),
        // Check if this is a CosmWasm contract
        caps.wasm?get('/cosmwasm/wasm/v1/contract/'+encodeURIComponent(val),{timeoutMs:5000}):Promise.reject('no wasm'),
      ]);
      var balR=results2[0],delR=results2[1],unbR=results2[2],rewR=results2[3],wasmR=results2[4];

      // If it's a contract, route to CosmWasm explorer
      if(wasmR.status==='fulfilled'&&wasmR.value&&wasmR.value.contract_info){
        await doSearchWasm(val);
        return;
      }

      var balH=ld('RESOLVING DENOMS');
      var balances=[];
      if(balR.status==='fulfilled'){
        balances=balR.value.balances||[];
      }

      var delH='\u2014',delN=0;
      if(delR.status==='fulfilled'){
        var dels=delR.value.delegation_responses||[];
        delN=dels.length;
        delH=dels.map(function(x){
          return '<div style="margin-bottom:4px"><div class="c-c mono" style="font-size:11px">'+esc(trim(x.delegation?x.delegation.validator_address:'',14,8))+'</div><div style="font-size:11px">'+esc(fmt((x.balance||{}).amount||0)+' '+((x.balance||{}).denom===C().denom?C().display:(x.balance||{}).denom||''))+'</div></div>';
        }).join('')||'(none)';
      }

      var unbH='\u2014';
      if(unbR.status==='fulfilled'){
        var unbs=unbR.value.unbonding_responses||[];
        unbH=unbs.length?unbs.map(function(x){
          var entries2=(x.entries||[]).map(function(e){
            return esc(fmt(e.balance||0))+' (completes: '+esc(new Date(e.completion_time).toLocaleDateString())+')';
          }).join('<br>');
          return '<div style="margin-bottom:4px"><div class="c-o mono" style="font-size:11px">'+esc(trim(x.validator_address||'',14,8))+'</div><div style="font-size:10px">'+entries2+'</div></div>';
        }).join(''):'None';
      }

      var rewH='\u2014';
      if(rewR.status==='fulfilled'){
        var r=(rewR.value.total||[]).find(function(x){return x.denom===C().denom});
        rewH=r?esc(fmt(parseFloat(r.amount))+' '+C().display+' pending'):'No pending rewards';
      }

      var shareURL2=location.origin+location.pathname+'#/address/'+encodeURIComponent(val);
      showSearchPanel('ADDRESS',
        '<div class="dg">'+
        dfRow('Address',esc(val)+copyBtn(val),true)+
        (priceUsd?dfRow(C().display+' Price','<span class="c-y">$'+priceUsd.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:4})+'</span>'+(priceChange24h!==null?' <span style="color:'+(priceChange24h>=0?'var(--c5)':'var(--c3)')+'">('+(priceChange24h>=0?'+':'')+priceChange24h.toFixed(2)+'%)</span>':'')):'')+ 
        dfRow('Balances','<div id="acctBalances">'+ld('RESOLVING')+'</div>',true)+
        dfRow('Pending Rewards',rewH,true)+
        dfRow('Delegations',esc(delN+' validators'))+
        '<div class="df-sep"></div>'+
        dfRow('Delegation Detail',delH,true)+
        '<div class="df-sep"></div>'+
        dfRow('Unbonding Delegations',unbH,true)+
        '<div class="df-sep"></div>'+
        dfRow('Recent Transactions','<div id="acctTxLoading"><div class="sp" style="width:12px;height:12px;display:inline-block"></div> Loading...</div>',true)+
        '</div>'
        +'<div id="acctModules"></div>'+
        shareBar(shareURL2,'address:'+trim(val,10,6))
      );

      // Async: resolve IBC denoms
      renderBalancesWithTrace(balances,val).then(function(html){
        var el=document.getElementById('acctBalances');
        if(el) el.innerHTML=html||'<span style="color:var(--dim)">0 tokens</span>';
      });
      // Async: load tx history
      fetchAccountTxs(val).then(function(txHTML){
        var el=document.getElementById('acctTxLoading');
        if(el) el.parentElement.innerHTML=txHTML;
      });
      // Async: load authz + feegrant
      fetchAccountModules(val,'acctModules');
      return;
    }

    showSearchPanel('NOT FOUND',
      '<div class="err"><div class="ei">&#8981;</div><div class="em">No results for \u201c'+esc(val.slice(0,40))+'\u201d</div><div>Try block height, 64-char hex hash, bech32 address, or valoper</div></div>');
  }catch(e){
    showSearchPanel('ERROR',
      '<div class="err"><div class="ei">&#9888;</div><div class="em">'+esc(e.message||'Search failed')+'</div><div>The query may not exist on this chain or endpoint</div></div>');
  }
}

function doSearch(){
  var val=document.getElementById('searchInput').value.trim();
  if(!val) return;
  if(/^\d+$/.test(val)) location.hash='#/block/'+encodeURIComponent(val);
  else if(/^[A-Fa-f0-9]{64}$/.test(val)) location.hash='#/tx/'+encodeURIComponent(val);
  else if(val.includes('valoper')) location.hash='#/validator/'+encodeURIComponent(val);
  else if(looksBech32(val)) location.hash='#/address/'+encodeURIComponent(val);
  else location.hash='#/search/'+encodeURIComponent(val);
}

function applyRoute(){
  var h=(location.hash||'#/').replace(/^#/,'');
  var parts=h.split('/').filter(Boolean);
  if(!parts.length) return;
  var kind=parts[0],value=parts[1];
  if(!kind) return;
  if(kind==='block'||kind==='tx'||kind==='address'||kind==='validator'||kind==='search'||kind==='contract'){
    var q=decodeURIComponent(value||'');
    document.getElementById('searchInput').value=q;
    doSearchValue(q);
  }else if(kind==='proposal'){
    var pid=decodeURIComponent(value||'');
    if(PD[pid]){showPropModal(PD[pid])}
    else{goPage('governance')}
  }else if(kind==='page'){
    goPage(decodeURIComponent(value||'dashboard'));
  }
}

// ── Modal System ─────────────────────────────────────────────────────────────
var lastFocusEl=null;
function openModal(title,html){
  lastFocusEl=document.activeElement;
  txt('modalTitle',title);
  setHTML('modalBody',html);
  document.getElementById('modalBg').classList.add('open');
  setTimeout(function(){var x=document.getElementById('modalX');if(x)x.focus()},50);
}
function closeModal(){
  document.getElementById('modalBg').classList.remove('open');
  if(lastFocusEl&&lastFocusEl.focus) setTimeout(function(){lastFocusEl.focus()},50);
}

function showBlockModal(d){
  openModal('BLOCK #'+fmtInt(d.height),
    '<div class="dg">'+
    dfRow('Height','<span class="c-c">#'+esc(fmtInt(d.height))+'</span>')+
    dfRow('Transactions','<span class="c-g">'+esc(d.txCount)+'</span>')+
    dfRow('Timestamp',esc(new Date(d.time).toUTCString()),true)+
    dfRow('Block Hash',esc(d.hash||'\u2014')+copyBtn(d.hash),true)+
    dfRow('Proposer',esc(d.proposer)+copyBtn(d.proposer),true)+
    '</div>');
}

function showTxModal(d){
  openModal('TRANSACTION',
    '<div class="dg">'+
    dfRow('Hash',esc(d.hash)+copyBtn(d.hash),true,'c')+
    dfRow('Type','<span class="badge bt">'+esc(d.typeLabel)+'</span>')+
    dfRow('Amount',esc(d.amount),'','g')+
    dfRow('Timestamp',d.ts?esc(new Date(d.ts).toUTCString()):'\u2014',true)+
    '</div>'+ld('LOADING FULL DETAIL'));

  if(d.hash){
    get('/cosmos/tx/v1beta1/txs/'+encodeURIComponent(d.hash)).then(function(data){
      var resp=data.tx_response,tx=data.tx;
      var msgs=tx&&tx.body?tx.body.messages||[]:[];
      var msgCards=msgs.map(function(m,i){
        var typeName=esc((m['@type']||'').split('.').pop()||'Unknown');
        var jsonStr=JSON.stringify(m,null,2);
        var clean=esc(jsonStr.slice(0,1200))+(jsonStr.length>1200?'\u2026':'');
        return '<div class="msg-item"><div class="msg-type">MSG '+(i+1)+': '+typeName+'</div><div class="msg-body"><pre>'+clean+'</pre></div></div>';
      }).join('');

      setHTML('modalBody',
        '<div class="dg">'+
        dfRow('Hash',esc(d.hash)+copyBtn(d.hash),true,'c')+
        dfRow('Status',resp.code===0?'<span class="c-g">&#10003; SUCCESS</span>':'<span class="c-r">&#10007; FAILED (code '+esc(resp.code)+')</span>')+
        dfRow('Block','<span class="c-c">#'+esc(fmtInt(resp.height))+'</span>')+
        dfRow('Gas',esc(fmtInt(resp.gas_used)+' / '+fmtInt(resp.gas_wanted)))+
        dfRow('Messages',esc(msgs.length))+
        dfRow('Timestamp',resp.timestamp?esc(new Date(resp.timestamp).toUTCString()):'\u2014',true)+
        dfRow('Memo',esc((tx&&tx.body?tx.body.memo:'')||'(none)'),true)+
        '<div class="df-sep"></div></div>'+
        '<div class="msg-list">'+msgCards+'</div>');
    }).catch(function(){});
  }
}

// Override showValModal with share bar
function showValModal(d){ showValModalFull(d); }

// ── Capability Detection ─────────────────────────────────────────────────────
async function detectCapabilities(){
  var ch=C();
  // Seed caps from baked-in chain config (eliminates most probe requests)
  caps={
    govV1:true,
    govV1beta1: ch.govV1beta1!==false,  // default true unless chain says false
    ibc:true,
    txByBlock: !ch.noTxQuery,
    supplyByDenom: !ch.noSupplyDenom,
    distParams: !ch.noDistParams,
    govParams: true,
    wasm: !!ch.wasm,
    authz: !!ch.authz,
    feegrant: !!ch.feegrant,
    upgrade: false,  // will probe below (cheap, rarely causes noise)
  };
  // txByBlock probe disabled (some gateways 500 on height queries). We'll disable at runtime on first failure.
  var results=await Promise.allSettled([
    get('/cosmos/gov/v1/proposals?proposal_status=3&pagination.limit=1',{timeoutMs:8000}),
    get('/cosmos/gov/v1beta1/proposals?proposal_status=3&pagination.limit=1',{timeoutMs:8000}),
    get('/ibc/core/channel/v1/channels?pagination.limit=1',{timeoutMs:8000}),
  ]);
  if(results[0].status==='rejected') caps.govV1=false;
  if(results[1].status==='rejected') caps.govV1beta1=false;
  if(results[2].status==='rejected') caps.ibc=false;
}

// ── Page Navigation ──────────────────────────────────────────────────────────
function goPage(page){
  activePage=page;
  document.querySelectorAll('.page').forEach(function(p){p.classList.remove('active')});
  document.querySelectorAll('.nav-tab[data-page]').forEach(function(t){
    t.classList.toggle('active',t.dataset.page===page);
    t.setAttribute('aria-selected',t.dataset.page===page?'true':'false');
  });
  var el=document.getElementById('page-'+page);
  if(el) el.classList.add('active');

  if(page==='ibc'){setHTML('ibcChList',ld('LOADING'));fetchIBC()}
  if(page==='assets'){setHTML('assetList',ld('LOADING'));fetchAssets()}
  if(page==='governance'){setHTML('govPageList',ld('LOADING'));fetchGovernance(activeGovTab)}
  if(page==='validators'){setHTML('valPageList',ld('LOADING'));fetchValidators()}
  if(page==='params'){fetchParams()}

  location.hash='#/page/'+encodeURIComponent(page);
}

// ── Chain Dropdown Builder ───────────────────────────────────────────────────
function buildChainDropdown(){
  var container=document.getElementById('netDrop');
  var html='<input class="dd-filter" type="text" placeholder="Filter chains..." data-testid="chain-filter"/>';
  Object.keys(CHAINS).forEach(function(key){
    var ch=CHAINS[key];
    var active=key===chain?'active':'';
    html+='<div class="dd-option '+active+'" data-chain="'+esc(key)+'" data-name="'+esc(ch.name)+'" role="menuitem" tabindex="0" data-testid="chain-option-'+esc(key)+'">'+
      '<div class="dd-dot" style="background:'+esc(ch.color)+';box-shadow:0 0 5px '+esc(ch.color)+'"></div>'+
      '<div class="dd-info"><span>'+esc(ch.name)+'</span><span class="dd-sub">'+esc(ch.chainId)+' &bull; '+esc(ch.display)+'</span></div></div>';
  });
  container.innerHTML=html;

  container.querySelector('.dd-filter').addEventListener('input',function(e){
    var q=e.target.value.toLowerCase();
    container.querySelectorAll('.dd-option').forEach(function(opt){
      var name=(opt.dataset.name||'').toLowerCase();
      var chn=(opt.dataset.chain||'').toLowerCase();
      opt.classList.toggle('hidden',q&&!name.includes(q)&&!chn.includes(q));
    });
  });
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE 1 — Animated Starfield Canvas
// ════════════════════════════════════════════════════════════════════════════
var starCtx=null, starStars=[], starShooters=[];
function initStarfield(){
  var cv=document.getElementById('starCanvas');
  if(!cv||starCtx) return;
  starCtx=cv.getContext('2d');
  function resize(){cv.width=window.innerWidth;cv.height=window.innerHeight}
  resize();
  window.addEventListener('resize',resize,{passive:true});
  starStars=[];
  for(var i=0;i<200;i++){
    starStars.push({
      x:Math.random()*cv.width, y:Math.random()*cv.height,
      r:Math.random()*1.3+0.15,
      vx:(Math.random()-.5)*0.07, vy:(Math.random()-.5)*0.07,
      base:Math.random()*0.55+0.08, phase:Math.random()*Math.PI*2
    });
  }
  function frame(){
    var W=cv.width, H=cv.height;
    starCtx.clearRect(0,0,W,H);
    var t=Date.now()/1000;
    var pulse=starPulse>0?(starPulse=Math.max(0,starPulse-1),starPulse/18):0;
    // Stars
    starStars.forEach(function(s){
      s.phase+=0.011; s.x+=s.vx; s.y+=s.vy;
      if(s.x<0)s.x=W; if(s.x>W)s.x=0;
      if(s.y<0)s.y=H; if(s.y>H)s.y=0;
      var a=s.base*(0.65+0.35*Math.sin(s.phase))*(1+pulse*2);
      var r=s.r*(1+pulse*0.6);
      starCtx.beginPath();
      starCtx.arc(s.x,s.y,Math.min(r,2.5),0,Math.PI*2);
      starCtx.fillStyle='rgba(190,220,255,'+Math.min(a,1)+')';
      starCtx.fill();
    });
    // Shooting stars — spawn occasionally
    if(Math.random()<0.004&&starShooters.length<4){
      starShooters.push({
        x:Math.random()*W, y:Math.random()*H*0.6,
        vx:Math.random()*7+5, vy:Math.random()*2.5+0.8,
        life:1, len:Math.random()*90+50
      });
    }
    starShooters=starShooters.filter(function(sh){
      sh.x+=sh.vx; sh.y+=sh.vy; sh.life-=0.018;
      if(sh.life<=0||sh.x>W+100) return false;
      var g=starCtx.createLinearGradient(sh.x-sh.len,sh.y,sh.x,sh.y);
      g.addColorStop(0,'rgba(0,229,255,0)');
      g.addColorStop(1,'rgba(0,229,255,'+(sh.life*0.9)+')');
      starCtx.beginPath();starCtx.moveTo(sh.x-sh.len,sh.y);starCtx.lineTo(sh.x,sh.y);
      starCtx.strokeStyle=g;starCtx.lineWidth=1.6;starCtx.stroke();
      return true;
    });
    requestAnimationFrame(frame);
  }
  frame();
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE 2 — New Block Flash
// ════════════════════════════════════════════════════════════════════════════
function flashNewBlock(){
  starPulse=22; // boost starfield brightness
  var el=document.getElementById('hBlock');
  if(el){el.classList.remove('block-flash');void el.offsetWidth;el.classList.add('block-flash');
    setTimeout(function(){el.classList.remove('block-flash')},700)}
  var row=document.querySelector('#blockList .row');
  if(row){row.classList.remove('row-flash');void row.offsetWidth;row.classList.add('row-flash');
    setTimeout(function(){row.classList.remove('row-flash')},700)}
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE 1b — Activity Ticker
// ════════════════════════════════════════════════════════════════════════════
var TICK_ICONS={
  'SEND':'↗','DELEGATE':'⚡','UNDELEGATE':'↙','REDELEGATE':'↔',
  'VOTE':'✓','CLAIM':'💎','IBC SEND':'🌐','IBC RECV':'📥',
  'EXECUTE':'⚙','INSTANTIATE':'🚀','PROPOSAL':'📜','DEPOSIT':'💰',
  'COMMISSION':'🏆','FUND POOL':'🌊','UNKNOWN':'◆','MULTI-SEND':'↗↗'
};
function rebuildTicker(){
  if(!activityFeed.length) return;
  var items=activityFeed.slice(0,36);
  // duplicate for seamless loop
  var html=items.concat(items).map(function(e){
    var icon=TICK_ICONS[e.type]||'◆';
    return '<span class="tick-evt"><span class="t-tag badge '+esc(e.cls)+'">'+icon+' '+esc(e.type)+'</span>'
      +'<span class="t-addr">'+esc(e.addr)+'</span>'
      +(e.amt?'<span class="t-amt">'+esc(e.amt)+'</span>':'')
      +'</span>';
  }).join('');
  var track=document.getElementById('tickerTrack');
  if(track) track.innerHTML=html;
}
function feedTicker(txArr){
  txArr.slice(0,10).forEach(function(tx){
    if(!tx.hash) return;
    activityFeed.unshift({
      type:tx.typeLabel||'UNKNOWN', cls:tx.tagClass||'bx',
      addr:tx.hash.slice(0,8)+'…',
      amt:tx.amount&&tx.amount!=='—'?tx.amount:''
    });
  });
  if(activityFeed.length>60) activityFeed=activityFeed.slice(0,60);
  rebuildTicker();
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE 3 — Nakamoto Coefficient
// ════════════════════════════════════════════════════════════════════════════
function computeAndRenderNakamoto(validators){
  if(!validators||!validators.length) return;
  var sorted=validators.slice().sort(function(a,b){
    return parseFloat(b.tokens||0)-parseFloat(a.tokens||0);
  });
  var total=sorted.reduce(function(s,v){return s+parseFloat(v.tokens||0)},0);
  var threshold=total*0.3334;
  var acc=0, nc=0;
  for(var i=0;i<sorted.length;i++){
    acc+=parseFloat(sorted[i].tokens||0); nc=i+1;
    if(acc>=threshold) break;
  }
  nakamotoCoeff=nc;
  var el=document.getElementById('mNakamoto');
  var sub=document.getElementById('mNakamotoSub');
  if(!el) return;
  var cls=nc>=10?'nc-good':nc>=5?'nc-warn':'nc-bad';
  var label=nc>=10?'✓ healthy':nc>=5?'moderate':'⚠ low';
  el.innerHTML='<span class="'+cls+'">'+nc+'</span>';
  if(sub) sub.textContent=label+' (33% BFT)';
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE 4 — Proposer Identity Resolution
// ════════════════════════════════════════════════════════════════════════════
async function fetchValidatorSet(){
  try{
    var d=await get('/cosmos/base/tendermint/v1beta1/validatorsets/latest?pagination.limit=200');
    var vals=d.validators||[];
    // Build pub_key -> moniker map from staking validators
    var pkMap={};
    allValidators.forEach(function(v){
      var pk=(v.consensus_pubkey||{}).key||'';
      if(pk) pkMap[pk]=(v.description||{}).moniker||'';
    });
    // Map tendermint address -> moniker
    vals.forEach(function(v){
      var addr=(v.address||'').toUpperCase();
      var pk=(v.pub_key||{}).key||'';
      if(addr&&pk&&pkMap[pk]) consMap[addr]=pkMap[pk];
    });
  }catch(_){}
}

function resolveProposer(hexAddr){
  if(!hexAddr) return '';
  var key=hexAddr.toUpperCase();
  if(consMap[key]) return consMap[key];
  // prefix match fallback (first 8 chars)
  var pre=key.slice(0,8);
  var ks=Object.keys(consMap);
  for(var i=0;i<ks.length;i++){if(ks[i].startsWith(pre)) return consMap[ks[i]]||''}
  return '';
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE 5 — TPS Sparkline Canvas
// ════════════════════════════════════════════════════════════════════════════
function drawTpsSparkline(){
  var cv=document.getElementById('tpsCanvas');
  if(!cv||tpsHistory.length<2) return;
  var ctx=cv.getContext('2d'), W=cv.width, H=cv.height;
  ctx.clearRect(0,0,W,H);
  var data=tpsHistory.slice(-20);
  var max=Math.max.apply(null,data)||1;
  ctx.beginPath();
  data.forEach(function(v,i){
    var x=(i/(data.length-1))*W;
    var y=H-(v/max)*(H-3)-1;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.strokeStyle='rgba(0,229,255,.85)';ctx.lineWidth=1.5;ctx.stroke();
  ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();
  ctx.fillStyle='rgba(0,229,255,.08)';ctx.fill();
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE 6 — Price Sparkline + 7-day history
// ════════════════════════════════════════════════════════════════════════════
async function fetchPriceHistory(){
  var id=C().cgId; if(!id) return;
  var ck='ar_ph_'+id;
  try{
    var cached=JSON.parse(localStorage.getItem(ck)||'null');
    if(cached&&Date.now()-cached.t<3600000){priceHistory=cached.d;drawPriceSparkline();return}
  }catch(_){}
  try{
    var r=await fetch('https://api.coingecko.com/api/v3/coins/'+encodeURIComponent(id)+'/market_chart?vs_currency=usd&days=7&interval=daily',
      {signal:AbortSignal.timeout(12000)});
    if(!r.ok) return;
    var json=await r.json();
    priceHistory=(json.prices||[]).map(function(p){return p[1]});
    if(priceHistory.length>1){
      var chg=((priceHistory[priceHistory.length-1]-priceHistory[0])/priceHistory[0]*100).toFixed(1);
      var sign=chg>=0?'+':'';
      var el=document.getElementById('hPriceDelta');
      if(el){el.textContent=sign+chg+'%';el.style.color=chg>=0?'var(--c5)':'var(--c3)'}
    }
    try{localStorage.setItem(ck,JSON.stringify({t:Date.now(),d:priceHistory}))}catch(_){}
    drawPriceSparkline();
  }catch(_){}
}

function drawPriceSparkline(){
  var cv=document.getElementById('priceCanvas');
  if(!cv||priceHistory.length<2) return;
  var ctx=cv.getContext('2d'), W=cv.width, H=cv.height;
  ctx.clearRect(0,0,W,H);
  var mn=Math.min.apply(null,priceHistory), mx=Math.max.apply(null,priceHistory);
  var range=mx-mn||1;
  var rising=priceHistory[priceHistory.length-1]>=priceHistory[0];
  var stroke=rising?'rgba(107,203,119,.9)':'rgba(255,107,107,.9)';
  var fill=rising?'rgba(107,203,119,.1)':'rgba(255,107,107,.08)';
  ctx.beginPath();
  priceHistory.forEach(function(v,i){
    var x=(i/(priceHistory.length-1))*W;
    var y=H-((v-mn)/range)*(H-3)-1;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.strokeStyle=stroke;ctx.lineWidth=1.5;ctx.stroke();
  ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();
  ctx.fillStyle=fill;ctx.fill();
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE 7 — Real Staking APR
// ════════════════════════════════════════════════════════════════════════════
function renderAPR(inflationDecimal, bondedRatioDecimal){
  if(!inflationDecimal||!bondedRatioDecimal||bondedRatioDecimal<=0) return;
  var apr=(inflationDecimal/bondedRatioDecimal)*(1-communityTax);
  var el=document.getElementById('mAprSub');
  if(el) el.textContent='APR ~'+(apr*100).toFixed(1)+'%';
}

async function fetchCommunityTax(){
  if(caps.distParams===false){communityTax=0;return}
  try{
    var d=await get('/cosmos/distribution/v1beta1/params');
    communityTax=parseFloat((d.params||{}).community_tax||0);
  }catch(_){communityTax=0;caps.distParams=false}
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE 6 — Cross-Chain Comparison Strip
// ════════════════════════════════════════════════════════════════════════════
var CC_KEYS=['cosmos','osmosis','celestia','injective','dydx'];
var CC_NAMES={cosmos:'COSMOS HUB',osmosis:'OSMOSIS',celestia:'CELESTIA',injective:'INJECTIVE',dydx:'dYdX'};

function renderCCStrip(){
  var el=document.getElementById('ccStrip');
  if(!el) return;
  el.innerHTML=CC_KEYS.map(function(k){
    var ch=CHAINS[k];
    var d=crossChainCache[k]||{};
    var isActive=k===chain;
    var col=ch?ch.color:'var(--c)';
    var blockTxt=d.block?'#'+fmtInt(d.block):'<span style="opacity:.3">—</span>';
    var meta='';
    if(d.bt) meta+='<span>'+d.bt+'s/blk</span>';
    if(d.tps) meta+='<span>'+d.tps+' tps</span>';
    if(d.price) meta+='<span style="color:var(--c4)">$'+parseFloat(d.price).toLocaleString(undefined,{maximumFractionDigits:d.price<10?3:2})+'</span>';
    return '<div class="cc-cell'+(isActive?' cc-active':'')+'" data-ccchain="'+k+'">'
      +'<div class="cc-name" style="color:'+col+'"><div class="cc-dot" style="background:'+col+'"></div>'
      +esc(CC_NAMES[k]||k.toUpperCase())+(isActive?' <span style="font-size:8px;opacity:.5">●</span>':'')+'</div>'
      +'<div class="cc-block" style="color:'+col+';text-shadow:0 0 12px '+col+'55">'+blockTxt+'</div>'
      +'<div class="cc-meta">'+meta+'</div>'
      +'</div>';
  }).join('');
}

async function fetchCrossChainStrip(){
  // Seed active chain from live data
  if(latestBlock){
    var bt=blockTimes.length?blockTimes[blockTimes.length-1].bt.toFixed(1):null;
    var tps=tpsHistory.length?(tpsHistory.reduce(function(a,b){return a+b},0)/tpsHistory.length).toFixed(2):null;
    crossChainCache[chain]={block:latestBlock,bt:bt,tps:tps,price:priceUsd,_ts:Date.now()};
  }
  renderCCStrip(); // show immediately with what we have
  // Fetch other chains in background — only ones different from active
  var others=CC_KEYS.filter(function(k){return k!==chain});
  await Promise.allSettled(others.map(async function(k){
    var ch=CHAINS[k]; if(!ch) return;
    var prev=crossChainCache[k]||{};
    try{
      var ep=ch.endpoints[0];
      var ac=new AbortController();
      var t=setTimeout(function(){ac.abort()},7000);
      var r=await fetch(ep+'/cosmos/base/tendermint/v1beta1/blocks/latest',
        {signal:ac.signal,headers:{Accept:'application/json'}});
      clearTimeout(t);
      if(!r.ok) throw new Error('bad');
      var json=await r.json();
      var h=parseInt(json.block.header.height);
      var txc=(json.block.data.txs||[]).length;
      var bt=null,tps=null;
      if(prev.block&&prev.block!==h&&prev._ts){
        var dt=(Date.now()-prev._ts)/1000;
        if(dt>0&&dt<90){bt=dt.toFixed(1);tps=(txc/dt).toFixed(2)}
      }
      crossChainCache[k]={block:h,bt:bt,tps:tps,price:prev.price||null,_ts:Date.now()};
    }catch(_){
      if(!crossChainCache[k]) crossChainCache[k]={block:null};
    }
  }));
  renderCCStrip();
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE 8 — Validator Uptime Bars
// Renders a 30-block "heartbeat" strip using missed_blocks_counter from
// signingInfos, keyed by consensus address prefix matching.
// ════════════════════════════════════════════════════════════════════════════
function uptimeBarHTML(operatorAddr){
  // Try to find signing info by address prefix
  var info=null;
  var keys=Object.keys(signingInfos);
  // signingInfos is keyed by valcons bech32 — match by anything we can
  for(var i=0;i<keys.length;i++){
    if(keys[i]){info=signingInfos[keys[i]];break} // first pass: grab any for now
  }
  // Better: store by index order and correlate with sorted validator list
  // Since we can't reliably match valcons->operator without extra API,
  // we use the index-order correlation: allValidators[i] <-> signingInfos sorted
  var idx=allValidators.findIndex(function(v){return v.operator_address===operatorAddr});
  var sortedKeys=Object.keys(signingInfos);
  if(idx>=0&&idx<sortedKeys.length) info=signingInfos[sortedKeys[idx]];
  if(!info) return '';

  var missed=info.missed||0;
  var tombstoned=info.tombstoned||false;
  var WINDOW=30; // display window
  // missed is cumulative counter, not per-window — estimate recent
  // Show as: last 30 blocks, where missed are distributed at end
  var recent=Math.min(missed,WINDOW);
  var pct=((WINDOW-recent)/WINDOW*100).toFixed(0);
  var cls=missed===0?'nc-good':missed<10?'nc-warn':'nc-bad';

  var bars='';
  for(var j=0;j<WINDOW;j++){
    var isMiss=j>=(WINDOW-recent);
    var isTomb=tombstoned&&isMiss;
    bars+='<div class="ub '+(isTomb?'tomb':isMiss?'miss':'hit')+'" title="'+(isMiss?'Missed':'Signed')+'"></div>';
  }
  return '<div class="val-uptime-wrap">'
    +'<div class="uptime-block-row">'+bars+'</div>'
    +'<span class="uptime-pct '+cls+'">'+pct+'%</span>'
    +'</div>';
}

// Enhanced showValModal with uptime bars
function showValModalFull(d){
  var v=d.v||{},desc=v.description||d.desc||{};
  var uptimeSection='';
  if(Object.keys(signingInfos).length>0){
    var uHTML=uptimeBarHTML(d.addr);
    if(uHTML) uptimeSection='<div class="df-sep"></div><div class="df full"><div class="df-l">UPTIME (30 BLOCKS)</div><div style="margin-top:8px">'+uHTML+'</div></div>';
  }
  var tokensUSD='';
  if(priceUsd&&d.tokens){
    var usdVal=(d.tokens/Math.pow(10,C().dec))*priceUsd;
    tokensUSD=' <span class="usd-val">($'+usdVal.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})+')</span>';
  }
  var shareURL=location.origin+location.pathname+'#/validator/'+encodeURIComponent(d.addr);
  openModal('VALIDATOR',
    '<div class="dg">'+
    dfRow('Moniker','<span class="c-c fw7">'+esc(desc.moniker||d.name)+'</span>',true)+
    dfRow('Operator',esc(d.addr)+copyBtn(d.addr),true,'c')+
    dfRow('Status',esc(v.status?(v.status).replace('BOND_STATUS_',''):'BONDED'))+
    dfRow('Jailed',v.jailed?'<span class="c-r">YES</span>':'<span class="c-g">NO</span>')+
    dfRow('Voting Power',esc(d.vp+'%'))+
    dfRow('Tokens',esc(fmt(d.tokens||0)+' '+C().display)+tokensUSD)+
    dfRow('Commission',esc(d.commission))+
    dfRow('Max Commission',v.commission&&v.commission.commission_rates?esc(pctStr(v.commission.commission_rates.max_rate)):'\u2014')+
    dfRow('Max Change Rate',v.commission&&v.commission.commission_rates?esc(pctStr(v.commission.commission_rates.max_change_rate)):'\u2014')+
    dfRow('Self-Delegation','<div id="valSelfDel">'+ld('LOADING')+'</div>',true)+
    dfRow('Website',desc.website?'<a href="'+esc(desc.website)+'" target="_blank" rel="noopener" style="color:var(--c)">'+esc(desc.website)+'</a>':'\u2014',true)+
    dfRow('Details',esc(String(desc.details||'\u2014').slice(0,400)),true)+
    dfRow('Security Contact',esc(desc.security_contact||'\u2014'),true)+
    uptimeSection+
    '</div>'+
    shareBar(shareURL,'validator:'+d.addr)
  );
  // Async: fetch self-delegation
  fetchSelfDelegation(d.addr).then(function(sd){
    var el=document.getElementById('valSelfDel');
    if(!el) return;
    if(!sd){el.innerHTML='<span style="color:var(--dim)">—</span>';return}
    var sdAmt=fmt(sd.amount)+' '+C().display;
    var sdPct=sd.totalTokens>0?(sd.amount/sd.totalTokens*100).toFixed(2)+'% of stake':'';
    el.innerHTML='<span class="c-g">'+esc(sdAmt)+'</span>'+(sdPct?' <span style="color:var(--dim);font-size:10px">('+esc(sdPct)+')</span>':'')
      +(sd.totalDelegators?' <span style="color:var(--dim);font-size:10px">· '+sd.totalDelegators+' delegators</span>':'');
  }).catch(function(){
    var el=document.getElementById('valSelfDel');
    if(el) el.innerHTML='<span style="color:var(--dim)">—</span>';
  });
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE 9 — TX Type Filter Tabs
// Pure client-side filter of rollingTxs[], zero new API calls.
// ════════════════════════════════════════════════════════════════════════════
var activeTxFilter='ALL';
var TX_FILTER_MAP={
  'SEND':['SEND','MULTI-SEND'],
  'DELEGATE':['DELEGATE','UNDELEGATE','REDELEGATE','CLAIM','COMMISSION','FUND POOL'],
  'IBC':['IBC SEND','IBC RECV'],
  'EXECUTE':['EXECUTE','INSTANTIATE'],
  'VOTE':['VOTE','PROPOSAL','DEPOSIT']
};

function applyTxFilter(){
  var filtered=rollingTxs;
  if(activeTxFilter!=='ALL'){
    var allowed=TX_FILTER_MAP[activeTxFilter]||[activeTxFilter];
    filtered=rollingTxs.filter(function(tx){
      return allowed.indexOf(tx.typeLabel||'UNKNOWN')>=0;
    });
  }
  var count=document.getElementById('txFilterCount');
  if(count) count.textContent=filtered.length+' / '+rollingTxs.length+' txs';

  var rows=filtered.slice(0,30).map(function(d){
    TD[d.hash]=d;
    return '<div class="row row-tx" tabindex="0" role="button" data-td="'+esc(d.hash)+'">'
      +'<div class="tx-hash">'+esc(trim(d.hash,9,6))+'</div>'
      +'<div><span class="badge '+esc(d.tagClass||'bx')+'">'+esc(d.typeLabel||'UNKNOWN')+'</span>'
      +(d.ok?'':'<span class="badge br" style="margin-left:4px">FAILED</span>')+'</div>'
      +'<div class="tx-amt '+(d.ok?'c-g':'c-r')+'">'+esc(d.amount||'\u2014')+'</div>'
      +'<div class="tx-time2">'+esc(ago(d.ts))+'</div></div>';
  }).join('');
  setHTML('txPageList', rows||'<div class="ld" style="font-size:11px">No '+(activeTxFilter==='ALL'?'':'matching ')+'transactions</div>');
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE 10 — Blocks Page: Gas Ratio Column + Enhanced Block Row
// ════════════════════════════════════════════════════════════════════════════
// Gas data fetching: we fetch block detail for top-of-list block to get
// gas stats. Stored per height in BD. Row renderer picks it up.
var gasCache={}; // height -> {gasUsed, gasWanted}
var gasQueryDisabled=false; // set true after first 400 — stops all future gas queries

async function fetchBlockGas(height){
  if(gasCache[height]||!height||gasQueryDisabled) return;
  // Mark cached immediately so parallel calls don't double-fetch
  gasCache[height]={gasUsed:0,gasWanted:0};
  try{
    // Use the chain's preferred tx query format (already detected in caps)
    var txPath=C().txQueryFormat==='events'
      ?'/cosmos/tx/v1beta1/txs?events=tx.height%3D'+height+'&pagination.limit=50'
      :'/cosmos/tx/v1beta1/txs?query=tx.height%3D'+height+'&pagination.limit=50';
    var txD=await fetchTxsByHeight(height,50);
    var responses=txD.tx_responses||[];
    var gasUsed=responses.reduce(function(s,r){return s+parseInt(r.gas_used||0)},0);
    var gasWanted=responses.reduce(function(s,r){return s+parseInt(r.gas_wanted||0)},0);
    gasCache[height]={gasUsed:gasUsed,gasWanted:gasWanted};
  }catch(e){
    // 400 = this endpoint doesn't support this query format at all — stop trying
    var status=(e&&e.status)||0;
    if(status===400||status===405||status===501){
      gasQueryDisabled=true;
    }
    // gasCache[height] already set to {0,0} above — no retry
  }
}

function blockRowFull(d){
  BD[d.height]=d;
  var moniker=resolveProposer(d.proposer);
  var gas=gasCache[d.height];
  var gasHTML='';
  if(gas&&gas.gasWanted>0){
    var ratio=Math.min((gas.gasUsed/gas.gasWanted)*100,100);
    gasHTML='<div class="bk-gas">'
      +fmtInt(gas.gasUsed)+'<div class="gas-bar"><div class="gas-fill" style="width:'+ratio.toFixed(0)+'%"></div></div>'
      +'</div>';
  } else {
    gasHTML='<div class="bk-gas" style="opacity:.3">—</div>';
  }
  return '<div class="row row-block row-block5" tabindex="0" role="button" data-bd="'+d.height+'" data-testid="block-row-'+d.height+'">'
    +'<div class="bk-num">#'+fmtInt(d.height)+'</div>'
    +'<div><div class="bk-hash">'+esc(trim(d.hash,10,6))+'</div>'
    +(moniker?'<div class="bk-prop-name">'+esc(moniker)+'</div>':'<div class="bk-prop">'+esc(trim(d.proposer,8,6))+'</div>')
    +'</div>'
    +'<div class="bk-txs"><span class="badge btx-num">'+esc(d.txCount)+' txs</span></div>'
    +gasHTML
    +'<div class="bk-time">'+esc(ago(d.time))+'</div></div>';
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE 12 — Share / Deep-Link bar for all modals
// ════════════════════════════════════════════════════════════════════════════
function shareBar(url, label){
  var encoded=encodeURIComponent(url);
  var twitterUrl='https://twitter.com/intent/tweet?text='+encodeURIComponent('Explore '+label+' on Atom Registry Interchain Explorer')+'&url='+encoded;
  return '<div class="modal-share-bar">'
    +'<span style="font-family:var(--mono);font-size:9px;letter-spacing:1px;color:var(--dim);text-transform:uppercase">SHARE</span>'
    +'<a class="share-btn" href="'+esc(twitterUrl)+'" target="_blank" rel="noopener" title="Share on Twitter">'
    +'<svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.744l7.737-8.835L1.254 2.25H8.08l4.253 5.622zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>'
    +'X / Twitter</a>'
    +'<button class="share-btn" data-copy="'+esc(url)+'" title="Copy link">'
    +'<svg viewBox="0 0 24 24"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>'
    +'Copy Link</button>'
    +'</div>';
}

// Override showBlockModal with share bar
function showBlockModal(d){
  var shareURL=location.origin+location.pathname+'#/block/'+encodeURIComponent(d.height);
  var moniker=resolveProposer(d.proposer);
  openModal('BLOCK #'+fmtInt(d.height),
    '<div class="dg">'+
    dfRow('Height','<span class="c-c">#'+esc(fmtInt(d.height))+'</span>')+
    dfRow('Transactions','<span class="c-g">'+esc(d.txCount)+'</span>')+
    dfRow('Timestamp',esc(new Date(d.time).toUTCString()),true)+
    dfRow('Block Hash',esc(d.hash||'\u2014')+copyBtn(d.hash),true)+
    dfRow('Proposer',(moniker?'<span class="c-p">'+esc(moniker)+'</span> ':'')+esc(trim(d.proposer,12,8))+copyBtn(d.proposer),true)+
    '</div>'+
    shareBar(shareURL,'block #'+d.height)
  );
}

// Override showTxModal with share bar
function showTxModal(d){
  var shareURL=location.origin+location.pathname+'#/tx/'+encodeURIComponent(d.hash);
  openModal('TRANSACTION',
    '<div class="dg">'+
    dfRow('Hash',esc(d.hash)+copyBtn(d.hash),true,'c')+
    dfRow('Type','<span class="badge bt">'+esc(d.typeLabel)+'</span>')+
    dfRow('Amount',esc(d.amount),'','g')+
    dfRow('Timestamp',d.ts?esc(new Date(d.ts).toUTCString()):'\u2014',true)+
    '</div>'+ld('LOADING FULL DETAIL')+
    shareBar(shareURL,'tx:'+trim(d.hash,8,6)));

  if(d.hash){
    get('/cosmos/tx/v1beta1/txs/'+encodeURIComponent(d.hash)).then(function(data){
      var resp=data.tx_response,tx=data.tx;
      var msgs=tx&&tx.body?tx.body.messages||[]:[];
      var msgCards=msgs.map(function(m,i){
        var typeName=esc((m['@type']||'').split('.').pop()||'Unknown');
        var jsonStr=JSON.stringify(m,null,2);
        var clean=esc(jsonStr.slice(0,1200))+(jsonStr.length>1200?'\u2026':'');
        return '<div class="msg-item"><div class="msg-type">MSG '+(i+1)+': '+typeName+'</div><div class="msg-body"><pre>'+clean+'</pre></div></div>';
      }).join('');
      setHTML('modalBody',
        '<div class="dg">'+
        dfRow('Hash',esc(d.hash)+copyBtn(d.hash),true,'c')+
        dfRow('Status',resp.code===0?'<span class="c-g">&#10003; SUCCESS</span>':'<span class="c-r">&#10007; FAILED (code '+esc(resp.code)+')</span>')+
        dfRow('Block','<span class="c-c">#'+esc(fmtInt(resp.height))+'</span>')+
        dfRow('Gas Used / Wanted',esc(fmtInt(resp.gas_used)+' / '+fmtInt(resp.gas_wanted)))+
        dfRow('Messages',esc(msgs.length))+
        dfRow('Timestamp',resp.timestamp?esc(new Date(resp.timestamp).toUTCString()):'\u2014',true)+
        dfRow('Memo',esc((tx&&tx.body?tx.body.memo:'')||'(none)'),true)+
        '<div class="df-sep"></div></div>'+
        '<div class="msg-list">'+msgCards+'</div>'+
        shareBar(shareURL,'tx:'+trim(d.hash,8,6)));
    }).catch(function(){});
  }
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE 14 — CSV Export for Validators
// ════════════════════════════════════════════════════════════════════════════
function exportValidatorsCSV(){
  if(!allValidators.length){alert('No validator data loaded yet.');return}
  var totalTokens=allValidators.reduce(function(s,v){return s+parseFloat(v.tokens||0)},0);
  var sorted=allValidators.slice().sort(function(a,b){return parseFloat(b.tokens||0)-parseFloat(a.tokens||0)});
  var lines=['Rank,Moniker,Operator Address,Status,Jailed,Voting Power %,Tokens ('+C().display+'),Commission %,Max Commission %,Website'];
  sorted.forEach(function(v,i){
    var desc=v.description||{};
    var tokens=parseFloat(v.tokens||0);
    var vp=totalTokens>0?(tokens/totalTokens*100).toFixed(4):'0';
    var comm=(parseFloat((v.commission&&v.commission.commission_rates?v.commission.commission_rates.rate:0))*100).toFixed(2);
    var maxComm=(parseFloat((v.commission&&v.commission.commission_rates?v.commission.commission_rates.max_rate:0))*100).toFixed(2);
    var row=[
      i+1,
      '"'+(desc.moniker||'Unknown').replace(/"/g,'""')+'"',
      v.operator_address||'',
      (v.status||'').replace('BOND_STATUS_',''),
      v.jailed?'YES':'NO',
      vp,
      (tokens/Math.pow(10,C().dec)).toFixed(2),
      comm,
      maxComm,
      '"'+(desc.website||'').replace(/"/g,'""')+'"'
    ];
    lines.push(row.join(','));
  });
  var csv=lines.join('\n');
  var blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');
  a.href=url;a.download=chain+'_validators_'+new Date().toISOString().slice(0,10)+'.csv';
  document.body.appendChild(a);a.click();
  setTimeout(function(){document.body.removeChild(a);URL.revokeObjectURL(url)},200);
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE 11 — Keyboard Shortcuts
// ════════════════════════════════════════════════════════════════════════════
var PAGE_KEYS=['dashboard','blocks','transactions','validators','governance','ibc','assets','params'];
var kbdHudOpen=false;

function toggleKbdHud(force){
  kbdHudOpen=force!==undefined?force:!kbdHudOpen;
  var hud=document.getElementById('kbdHud');
  if(hud) hud.classList.toggle('open',kbdHudOpen);
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE 13 — Row entrance animation helper
// ════════════════════════════════════════════════════════════════════════════
function animateNewRows(containerId){
  var container=document.getElementById(containerId);
  if(!container) return;
  var rows=container.querySelectorAll('.row');
  if(!rows.length) return;
  // Only animate the first row (newest)
  var first=rows[0];
  first.classList.remove('row-new');
  void first.offsetWidth;
  first.classList.add('row-new');
}

// ════════════════════════════════════════════════════════════════════════════
// GOVERNANCE — Sort + PD cache + showPropModal
// ════════════════════════════════════════════════════════════════════════════
function sortProps(arr){
  return arr.slice().sort(function(a,b){
    return parseInt(b.id||b.proposal_id||0)-parseInt(a.id||a.proposal_id||0);
  });
}
function propGetTitle(p){
  var pid=p.id||p.proposal_id;
  var t=p.title||((p.content||{}).title)||'';
  if(!t&&p.messages&&p.messages[0]) t=p.messages[0].title||(p.messages[0].content||{}).title||'';
  return t||'Proposal #'+pid;
}
function propBadge(st){
  if(st==='PROPOSAL_STATUS_VOTING_PERIOD'||st===2||st==='2') return ['bp','VOTING'];
  if(st==='PROPOSAL_STATUS_PASSED'||st===3||st==='3')        return ['bg','PASSED'];
  if(st==='PROPOSAL_STATUS_DEPOSIT_PERIOD'||st===1||st==='1')return ['by','DEPOSIT'];
  if(st==='PROPOSAL_STATUS_FAILED'||st===5||st==='5')        return ['br','FAILED'];
  return ['br','REJECTED'];
}
function propTallyBar(tally, full){
  var yes=parseFloat(tally.yes_count||tally.yes||0);
  var no=parseFloat(tally.no_count||tally.no||0);
  var veto=parseFloat(tally.no_with_veto_count||tally.no_with_veto||0);
  var abs=parseFloat(tally.abstain_count||tally.abstain||0);
  var tot=yes+no+veto+abs;
  if(!tot) return '<div class="prop-meta"><span style="color:var(--dim)">Tally not yet available</span></div>';
  var yp=(yes/tot*100).toFixed(1),np=(no/tot*100).toFixed(1),vp2=(veto/tot*100).toFixed(1),ap=(abs/tot*100).toFixed(1);
  if(!full) return '<div class="prop-bar-wrap"><div class="prop-track">'
    +'<div class="prop-yes" style="width:'+yp+'%"></div><div class="prop-no" style="width:'+np+'%"></div>'
    +'<div class="prop-veto" style="width:'+vp2+'%"></div><div class="prop-abs" style="width:'+ap+'%"></div>'
    +'</div><span class="prop-pct">'+yp+'%</span></div>'
    +'<div class="prop-meta"><span style="color:var(--c5)">YES '+yp+'%</span>'
    +'<span style="color:var(--c3)">NO '+np+'%</span>'
    +'<span style="color:var(--c6)">VETO '+vp2+'%</span>'
    +'<span style="color:var(--dim)">ABS '+ap+'%</span></div>';
  return [
    {l:'YES',p:yp,c:'var(--c5)'},{l:'NO',p:np,c:'var(--c3)'},
    {l:'VETO',p:vp2,c:'var(--c6)'},{l:'ABSTAIN',p:ap,c:'var(--dim)'}
  ].map(function(r){
    return '<div class="prop-tally-row"><div class="prop-tally-lbl" style="color:'+r.c+'">'+r.l+'</div>'
      +'<div class="prop-tally-bar"><div class="prop-tally-fill" style="width:'+r.p+'%;background:'+r.c+'"></div></div>'
      +'<div class="prop-tally-pct" style="color:'+r.c+'">'+r.p+'%</div></div>';
  }).join('');
}
function renderProps(props){
  if(!props||!props.length) return '<div class="ld" style="font-size:11px">No proposals found</div>';
  return sortProps(props).map(function(p){
    var pid=String(p.id||p.proposal_id||'');
    var b=propBadge(p.status);
    PD[pid]=p;
    return '<div class="prop-row" tabindex="0" role="button" data-pd="'+pid+'">'
      +'<div class="prop-top"><span class="prop-id">PROP #'+esc(pid)+'</span>'
      +'<span class="badge '+b[0]+'">'+b[1]+'</span></div>'
      +'<div class="prop-title">'+esc(propGetTitle(p)).slice(0,90)+'</div>'
      +propTallyBar(p.final_tally_result||{},false)
      +(p.voting_end_time||p.submit_time?
        '<div style="font-family:var(--mono);font-size:9px;color:var(--dim);margin-top:5px">'
        +(p.voting_end_time?'VOTE END: ':'SUBMITTED: ')+esc(new Date(p.voting_end_time||p.submit_time).toUTCString())
        +'</div>':'')
      +'</div>';
  }).join('');
}
function showPropModal(p){
  var pid=String(p.id||p.proposal_id||'');
  var b=propBadge(p.status);
  var desc=p.summary||(p.content||{}).description||'';
  if(!desc&&p.messages&&p.messages[0]) desc=(p.messages[0].content||{}).description||'';
  if(desc.length>2000) desc=desc.slice(0,2000)+'…';
  var msgChips='';
  if(p.messages&&p.messages.length){
    msgChips=p.messages.map(function(m){
      return '<span class="prop-msg-chip">'+esc((m['@type']||m.type_url||'').split('.').pop()||'?')+'</span>';
    }).join('');
  } else if(p.content&&p.content['@type']){
    msgChips='<span class="prop-msg-chip">'+esc(p.content['@type'].split('.').pop())+'</span>';
  }
  var depositH=(p.total_deposit||[]).map(function(d){
    var isN=d.denom===C().denom;
    return '<span class="prop-deposit-item">'+esc(isN?fmt(d.amount)+' '+C().display:d.amount.slice(0,12)+' '+d.denom.slice(0,14))+'</span>';
  }).join('');
  var shareURL=location.origin+location.pathname+'#/proposal/'+encodeURIComponent(pid);
  var html='<div class="dg">'
    +dfRow('Proposal','<span class="mono" style="font-size:11px">PROP #'+esc(pid)+'</span> <span class="badge '+b[0]+'" style="margin-left:8px">'+b[1]+'</span>',true)
    +dfRow('Title','<span style="font-size:14px;font-weight:700;color:var(--txt3)">'+esc(propGetTitle(p))+'</span>',true);
  if(p.proposer) html+=dfRow('Proposer',esc(trim(p.proposer,18,8))+copyBtn(p.proposer),true);
  if(p.submit_time) html+=dfRow('Submitted',esc(new Date(p.submit_time).toUTCString()),true);
  if(p.deposit_end_time) html+=dfRow('Deposit End',esc(new Date(p.deposit_end_time).toUTCString()),true);
  if(p.voting_start_time) html+=dfRow('Voting Start',esc(new Date(p.voting_start_time).toUTCString()),true);
  if(p.voting_end_time) html+=dfRow('Voting End',esc(new Date(p.voting_end_time).toUTCString()),true);
  if(depositH) html+=dfRow('Total Deposit',depositH,true);
  if(msgChips) html+=dfRow('Type',msgChips,true);
  html+='<div class="df-sep"></div>';
  html+='<div class="df full"><div class="df-l">VOTE TALLY</div><div style="margin-top:8px">'+propTallyBar(p.final_tally_result||{},true)+'</div></div>';
  if(desc) html+='<div class="df-sep"></div><div class="df full"><div class="df-l">DESCRIPTION</div><div class="prop-desc">'+esc(desc)+'</div></div>';
  // Votes section — loads asynchronously
  html+='<div class="df-sep"></div>';
  html+='<div class="df full"><div class="df-l">VOTES</div><div id="propVotesList" style="width:100%;margin-top:6px">'+ld('LOADING')+'</div></div>';
  html+='</div>';
  html+=shareBar(shareURL,'proposal #'+pid);
  openModal('PROPOSAL #'+pid, html);
  // Async: load votes
  showPropVotesSection(pid,'propVotesList');
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE A — IBC Denom Trace Resolution
// Resolves ibc/HASH balances to their base denom + path for display.
// Cache: ibcDenomCache[hash] = {base_denom, path}
// ════════════════════════════════════════════════════════════════════════════
var ibcDenomCache={};

async function resolveIbcDenom(hash){
  if(ibcDenomCache[hash]) return ibcDenomCache[hash];
  try{
    var d=await get('/ibc/apps/transfer/v1/denom_traces/'+encodeURIComponent(hash),{timeoutMs:6000});
    var dt=d.denom_trace||{};
    ibcDenomCache[hash]={base_denom:dt.base_denom||hash,path:dt.path||''};
    return ibcDenomCache[hash];
  }catch(_){
    ibcDenomCache[hash]={base_denom:hash.slice(0,12)+'…',path:''};
    return ibcDenomCache[hash];
  }
}

// Resolve all IBC denoms in a balances array, return enriched HTML
async function renderBalancesWithTrace(balances,addr){
  var html='';
  for(var i=0;i<balances.length;i++){
    var x=balances[i];
    var dn=String(x.denom||'');
    var isNative=dn===C().denom;
    var isIBC=dn.startsWith('ibc/');
    var displayAmt=fmt(x.amount,isNative?C().dec:isIBC?6:0);
    var displayDenom=isNative?C().display:dn.slice(0,24);
    var traceHTML='';
    if(isIBC){
      var hash=dn.slice(4);
      var tr=await resolveIbcDenom(hash);
      displayDenom=tr.base_denom.toUpperCase().slice(0,16);
      traceHTML='<div class="denom-trace">PATH: '+esc(tr.path||'unknown')+'</div>';
    }
    var usdHTML='';
    if(isNative&&priceUsd){
      var usdAmt=parseFloat(x.amount)/Math.pow(10,C().dec)*priceUsd;
      usdHTML=' <span class="usd-val">($'+usdAmt.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})+')</span>';
    }
    html+='<div style="margin-bottom:6px">'
      +(isIBC?'<span class="denom-tag">IBC</span>':'')
      +'<span style="font-family:var(--mono);font-size:12px;color:var(--txt3)">'+esc(displayAmt)+' '+esc(displayDenom)+'</span>'
      +usdHTML+traceHTML+'</div>';
  }
  return html||'<span style="color:var(--dim)">0 tokens</span>';
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE B — Node Status Panel
// Fetches /status from CometBFT RPC (or LCD equivalent), shows version,
// sync status, catching_up, and computes endpoint latency.
// Also fetches upgrade plan.
// ════════════════════════════════════════════════════════════════════════════
var endpointLatencies={}; // endpoint url -> ms

async function fetchNodeStatus(){
  var t0=Date.now();
  try{
    // Try LCD node info first
    var d=await get('/cosmos/base/node/v1beta1/config',{timeoutMs:8000});
    var lat=Date.now()-t0;
    var conf=d.minimum_gas_prices||'';
    var ep=currentEndpoint();
    endpointLatencies[ep]=(endpointLatencies[ep]?Math.round((endpointLatencies[ep]+lat)/2):lat);
    // Update gas price from node config
    if(conf){
      var gasMatch=conf.match(/([\d.]+)\s*(\w+)/);
      if(gasMatch){
        txt('nsGasPrice',gasMatch[1]+' '+gasMatch[2]);
        txt('nsGasSub','node min gas price');
      }
    }
  }catch(_){}

  try{
    // CometBFT /status endpoint
    var rpcBase=C().rpc||(currentEndpoint().replace(/\/$/,''));
    var sd=await get('/cosmos/base/tendermint/v1beta1/node_info',{timeoutMs:6000});
    var ni=sd.default_node_info||sd.node_info||{};
    var vi=sd.application_version||{};
    var ver=vi.version||ni.version||ni.app_version||'—';
    var moniker=ni.moniker||'';
    var netw=ni.network||C().chainId||'—';
    txt('nsVersion',ver);
    txt('nsNetwork',moniker?moniker+' · '+netw:netw);
  }catch(_){
    txt('nsVersion','—');
    txt('nsNetwork',C().chainId||'—');
  }

  try{
    // Sync status via block latency proxy — if latest block is recent, synced
    var now=Date.now();
    var blockAgeMs=latestBlock&&prevBlockTs?(now-prevBlockTs):null;
    var synced=blockAgeMs!==null&&blockAgeMs<120000;
    var syncEl=document.getElementById('nsSyncing');
    if(syncEl){
      syncEl.className='ns-val '+(synced?'ns-good':'ns-warn');
      syncEl.textContent=synced?'SYNCED':'SLOW';
    }
    if(blockAgeMs!==null){
      txt('nsSyncSub','last block '+(blockAgeMs<60000?Math.round(blockAgeMs/1000)+'s ago':Math.round(blockAgeMs/60000)+'m ago'));
    }
  }catch(_){}

  // Show endpoint + latency
  var ep2=currentEndpoint();
  var lat2=endpointLatencies[ep2];
  var epShort=ep2.replace('https://','').replace('http://','').split('/')[0];
  txt('nsEndpoint',epShort);
  if(lat2){
    var latEl=document.getElementById('nsLatency');
    if(latEl){
      latEl.textContent=lat2+'ms';
      latEl.className='ns-sub '+(lat2<300?'ns-good':lat2<800?'ns-warn':'ns-bad');
    }
  }
}

function currentEndpoint(){
  var eps=C().endpoints||[];
  return eps[Math.min(endpointIdx||0,eps.length-1)]||'';
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE B2 — Upgrade Plan
// Checks /cosmos/upgrade/v1beta1/current_plan once per session.
// Shows a top-of-page banner if a plan exists.
// ════════════════════════════════════════════════════════════════════════════
async function fetchUpgradePlan(){
  try{
    var d=await get('/cosmos/upgrade/v1beta1/current_plan',{timeoutMs:8000});
    var plan=d.plan;
    if(!plan||!plan.name) return;
    var panel=document.getElementById('upgradePanel');
    if(!panel) return;
    panel.classList.add('visible');
    txt('upgradeName',plan.name.toUpperCase()+' UPGRADE');
    var h=parseInt(plan.height||0);
    txt('upgradeHeight','TARGET HEIGHT: '+fmtInt(h));
    if(latestBlock&&h>latestBlock){
      var left=h-latestBlock;
      txt('upgradeBlocksLeft',fmtInt(left)+' blocks remaining (~'+Math.round(left*6/3600)+'h at 6s/block)');
    }
    if(caps) caps.upgrade=true;
  }catch(_){
    if(caps) caps.upgrade=false;
  }
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE C — Governance Votes List in Proposal Modal
// Lazy-loads /proposals/{id}/votes after modal opens.
// Paginates up to 50 voters with "load more".
// ════════════════════════════════════════════════════════════════════════════
var votePageKey=null; // pagination key for load-more

function voteOptClass(opt){
  if(!opt) return 'vote-abs';
  var o=String(opt).toUpperCase();
  if(o.includes('YES')&&!o.includes('VETO')) return 'vote-yes';
  if(o.includes('VETO')) return 'vote-veto';
  if(o.includes('NO')) return 'vote-no';
  return 'vote-abs';
}
function voteOptLabel(opt){
  if(!opt) return 'ABSTAIN';
  var o=String(opt).toUpperCase();
  if(o==='VOTE_OPTION_YES'||o==='1') return 'YES';
  if(o==='VOTE_OPTION_ABSTAIN'||o==='3') return 'ABSTAIN';
  if(o==='VOTE_OPTION_NO'||o==='4') return 'NO';
  if(o==='VOTE_OPTION_NO_WITH_VETO'||o==='2') return 'VETO';
  return o.replace('VOTE_OPTION_','').replace(/_/g,' ')||'?';
}

function renderVoteRows(votes){
  if(!votes||!votes.length) return '<div style="color:var(--dim);font-size:11px;padding:12px 16px">No votes recorded</div>';
  return votes.map(function(v){
    var voter=v.voter||v.address||'?';
    var opts=v.options||[{option:v.option,weight:'1'}];
    var optHTML=opts.map(function(o){
      return '<span class="vote-opt '+voteOptClass(o.option)+'">'+voteOptLabel(o.option)+'</span>';
    }).join(' ');
    return '<div class="vote-row">'
      +'<div class="vote-addr" data-copy="'+esc(voter)+'">'+esc(trim(voter,14,8))+'</div>'
      +optHTML
      +'<div style="color:var(--dim)">'+esc(ago(v.metadata||''))+'</div>'
      +'</div>';
  }).join('');
}

async function loadPropVotes(pid,key){
  var base=caps.govV1
    ?'/cosmos/gov/v1/proposals/'+pid+'/votes?pagination.limit=30'
    :'/cosmos/gov/v1beta1/proposals/'+pid+'/votes?pagination.limit=30';
  var url=key?base+'&pagination.key='+encodeURIComponent(key):base;
  try{
    var d=await get(url,{timeoutMs:10000});
    var votes=d.votes||[];
    var nextKey=(d.pagination||{}).next_key||null;
    return {votes:votes,nextKey:nextKey};
  }catch(_){return {votes:[],nextKey:null}}
}

async function showPropVotesSection(pid,containerId){
  var el=document.getElementById(containerId);
  if(!el) return;
  el.innerHTML=ld('LOADING VOTES');
  var res=await loadPropVotes(pid,null);
  var html=renderVoteRows(res.votes);
  if(res.nextKey){
    html+='<div class="votes-load-more" id="voteLoadMore" data-pid="'+esc(pid)+'" data-key="'+esc(res.nextKey)+'">LOAD MORE VOTES ↓</div>';
  }
  el.innerHTML=html;
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE D — CosmWasm Contract Explorer
// Triggered when search finds a bech32 address that resolves as a contract.
// Shows metadata + state + interactive query tool.
// ════════════════════════════════════════════════════════════════════════════
async function doSearchWasm(addr){
  showSearchPanel('WASM CONTRACT', ld('LOADING CONTRACT'));
  try{
    var results=await Promise.allSettled([
      get('/cosmwasm/wasm/v1/contract/'+encodeURIComponent(addr),{timeoutMs:8000}),
      get('/cosmwasm/wasm/v1/contract/'+encodeURIComponent(addr)+'/smart/'+btoa(JSON.stringify({contract_info:{}})),{timeoutMs:6000}).catch(function(){return null}),
    ]);
    var cR=results[0];
    if(cR.status!=='fulfilled') throw new Error('Not a CosmWasm contract');
    var ci=cR.value.contract_info||{};
    var shareURL=location.origin+location.pathname+'#/contract/'+encodeURIComponent(addr);

    var html='<div class="dg">'
      +dfRow('Address',esc(addr)+copyBtn(addr),true,'c')
      +dfRow('Label','<span class="c-c">'+esc(ci.label||'—')+'</span>',true)
      +dfRow('Code ID',esc(ci.code_id||'—'))
      +dfRow('Creator',esc(trim(ci.creator||'—',14,8))+copyBtn(ci.creator||''),true)
      +dfRow('Admin',ci.admin?esc(trim(ci.admin,14,8))+copyBtn(ci.admin):'<span style="color:var(--dim)">None (immutable)</span>',true)
      +(ci.extension?dfRow('Extension',esc(JSON.stringify(ci.extension).slice(0,200)),true):'')
      +'</div>';

    // Interactive query tool
    html+='<div class="df-sep"></div>'
      +'<div style="padding:12px 20px">'
      +'<div style="font-family:var(--mono);font-size:9px;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin-bottom:8px">CONTRACT QUERY</div>'
      +'<div class="wasm-query-form">'
      +'<input class="wasm-query-input" id="wasmQueryIn" placeholder=\'{"get_config":{}}\' />'
      +'<button class="wasm-query-btn" id="wasmQueryBtn" data-addr="'+esc(addr)+'">QUERY</button>'
      +'</div>'
      +'<div class="wasm-result" id="wasmQueryResult" style="display:none"></div>'
      +'</div>';

    html+=shareBar(shareURL,'contract:'+trim(addr,10,6));
    showSearchPanel('WASM CONTRACT', html);

    // Wire query button
    setTimeout(function(){
      var btn=document.getElementById('wasmQueryBtn');
      if(btn) btn.addEventListener('click',function(){
        var inp=document.getElementById('wasmQueryIn');
        var res=document.getElementById('wasmQueryResult');
        if(!inp||!res) return;
        var q=inp.value.trim();
        try{ JSON.parse(q) }catch(e){ res.style.display='block';res.textContent='Invalid JSON: '+e.message;return }
        res.style.display='block';
        res.textContent='Querying…';
        get('/cosmwasm/wasm/v1/contract/'+encodeURIComponent(addr)+'/smart/'+btoa(q),{timeoutMs:8000})
          .then(function(d){res.textContent=JSON.stringify(d,null,2)})
          .catch(function(e){res.textContent='Error: '+e.message});
      });
    },100);

  }catch(e){
    showSearchPanel('NOT A CONTRACT',
      '<div class="err"><div class="ei">⊘</div><div class="em">'+esc(addr)+'</div>'
      +'<div>Not a CosmWasm contract on this chain, or CosmWasm is not enabled</div></div>');
  }
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE E — Capability Detection Extended (caps.wasm, authz, upgrade)
// ════════════════════════════════════════════════════════════════════════════
async function detectCapabilitiesExtended(){
  // For known chains, caps.wasm/authz/feegrant are already baked in from CHAINS config.
  // Only run probes when the chain config doesn't define them (future/unknown chains).
  var ch=C();
  var needsProbe = ch.wasm===undefined || ch.authz===undefined || ch.feegrant===undefined;
  if(!needsProbe){
    // Also probe for upgrade plan (cheap, harmless 404 on most chains)
    try{
      var d=await get('/cosmos/upgrade/v1beta1/current_plan',{timeoutMs:5000});
      caps.upgrade=!!(d&&d.plan&&d.plan.name);
    }catch(_){caps.upgrade=false}
    gasQueryDisabled=!caps.txByBlock;
    return;
  }
  // Unknown chain — run full probes
  var pfx=ch.prefix||'cosmos';
  var dummyAddr=pfx+'1qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq';
  var probes=await Promise.allSettled([
    get('/cosmwasm/wasm/v1/codes?pagination.limit=1',{timeoutMs:6000}),
    get('/cosmos/authz/v1beta1/grants?granter='+encodeURIComponent(dummyAddr)+'&pagination.limit=1',{timeoutMs:6000}),
    get('/cosmos/upgrade/v1beta1/current_plan',{timeoutMs:6000}),
    get('/cosmos/feegrant/v1beta1/allowances/'+encodeURIComponent(dummyAddr)+'?pagination.limit=1',{timeoutMs:6000}),
  ]);
  caps.wasm    = probes[0].status==='fulfilled';
  caps.authz   = probes[1].status==='fulfilled'||(probes[1].reason&&probes[1].reason.status===400);
  caps.upgrade = probes[2].status==='fulfilled';
  caps.feegrant= probes[3].status==='fulfilled'||(probes[3].reason&&probes[3].reason.status===400);
  gasQueryDisabled=!caps.txByBlock;
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE F — Authz + Feegrant on Account Page
// Added to the account search panel asynchronously.
// ════════════════════════════════════════════════════════════════════════════
async function fetchAccountModules(addr,containerId){
  var el=document.getElementById(containerId);
  if(!el) return;

  var results=await Promise.allSettled([
    caps.authz?get('/cosmos/authz/v1beta1/grants?granter='+encodeURIComponent(addr)+'&pagination.limit=10',{timeoutMs:8000}):Promise.reject('disabled'),
    caps.authz?get('/cosmos/authz/v1beta1/grants?grantee='+encodeURIComponent(addr)+'&pagination.limit=10',{timeoutMs:8000}):Promise.reject('disabled'),
    caps.feegrant?get('/cosmos/feegrant/v1beta1/allowances/'+encodeURIComponent(addr)+'?pagination.limit=10',{timeoutMs:8000}):Promise.reject('disabled'),
  ]);

  var html='';

  // Authz grants given
  if(results[0].status==='fulfilled'){
    var given=results[0].value.grants||[];
    if(given.length){
      html+='<div class="df-sep"></div><div class="df full"><div class="df-l">AUTHZ GRANTS GIVEN ('+given.length+')</div><div>';
      html+=given.map(function(g){
        var atype=(g.authorization&&g.authorization['@type']||'').split('.').pop()||'Unknown';
        var exp=g.expiration?new Date(g.expiration).toLocaleDateString():'No expiry';
        return '<div class="authz-row">'
          +'<div class="authz-type">'+esc(atype.replace('Authorization',''))+'</div>'
          +'<div class="c-c" style="font-size:9px">'+esc(trim(g.grantee||'',10,6))+'</div>'
          +'<div class="authz-exp">'+esc(exp)+'</div>'
          +'</div>';
      }).join('');
      html+='</div></div>';
    }
  }

  // Authz grants received
  if(results[1].status==='fulfilled'){
    var recv=results[1].value.grants||[];
    if(recv.length){
      html+='<div class="df-sep"></div><div class="df full"><div class="df-l">AUTHZ GRANTS RECEIVED ('+recv.length+')</div><div>';
      html+=recv.map(function(g){
        var atype=(g.authorization&&g.authorization['@type']||'').split('.').pop()||'Unknown';
        var exp=g.expiration?new Date(g.expiration).toLocaleDateString():'No expiry';
        return '<div class="authz-row">'
          +'<div class="authz-type">'+esc(atype.replace('Authorization',''))+'</div>'
          +'<div class="c-c" style="font-size:9px">'+esc(trim(g.granter||'',10,6))+'</div>'
          +'<div class="authz-exp">'+esc(exp)+'</div>'
          +'</div>';
      }).join('');
      html+='</div></div>';
    }
  }

  // Feegrant allowances
  if(results[2].status==='fulfilled'){
    var allowances=results[2].value.allowances||[];
    if(allowances.length){
      html+='<div class="df-sep"></div><div class="df full"><div class="df-l">FEE GRANTS ('+allowances.length+')</div><div>';
      html+=allowances.map(function(a){
        var atype=(a.allowance&&a.allowance['@type']||'').split('.').pop()||'Allowance';
        var exp=(a.allowance&&a.allowance.expiration)?new Date(a.allowance.expiration).toLocaleDateString():'No expiry';
        return '<div class="authz-row">'
          +'<div class="authz-type">'+esc(atype.replace('Allowance',''))+'</div>'
          +'<div class="c-c" style="font-size:9px">'+esc(trim(a.granter||'',10,6))+'</div>'
          +'<div class="authz-exp">'+esc(exp)+'</div>'
          +'</div>';
      }).join('');
      html+='</div></div>';
    }
  }

  if(html) el.insertAdjacentHTML('beforeend',html);
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE G — Gas Price Median Estimate
// Derived from transactions already in rollingTxs (no new API calls).
// Shown in node status panel.
// ════════════════════════════════════════════════════════════════════════════
function updateGasPriceEstimate(){
  // Extract gas price from gasCache (gas_used, gas_wanted per block)
  // Use: median(gas_used/gas_wanted) as proxy for utilization
  // Better: derive from tx fees in rollingTxs if fee data present
  var samples=[];
  Object.values(gasCache).forEach(function(g){
    if(g.gasWanted>0) samples.push(g.gasUsed/g.gasWanted);
  });
  if(!samples.length) return;
  samples.sort(function(a,b){return a-b});
  var median=samples[Math.floor(samples.length/2)];
  var utilPct=(median*100).toFixed(0);
  var gasEl=document.getElementById('nsGasPrice');
  if(gasEl&&gasEl.textContent==='—'){
    gasEl.textContent=utilPct+'% util';
    txt('nsGasSub','block gas utilization');
  }
}

// ════════════════════════════════════════════════════════════════════════════
// FEATURE H — Self-Delegation in Validator Modal
// Fetches /cosmos/staking/v1beta1/validators/{valoper}/delegations to find
// the operator's own delegation (self-delegation).
// ════════════════════════════════════════════════════════════════════════════
async function fetchSelfDelegation(valoperAddr){
  try{
    // Self-delegation is when delegator == operator's own address
    // We can fetch delegations and look for the top delegator OR
    // use the dedicated endpoint if available
    var d=await get('/cosmos/staking/v1beta1/validators/'+encodeURIComponent(valoperAddr)+'/delegations?pagination.limit=20',{timeoutMs:8000});
    var dels=d.delegation_responses||[];
    // Self-delegation: operator bech32 converted to delegator prefix
    // Usually the first delegator matches the valoper prefix pattern
    var total=dels.reduce(function(s,x){return s+parseFloat((x.balance||{}).amount||0)},0);
    var selfDel=dels.find(function(x){
      // Rough heuristic: self-delegation delegator starts same prefix
      var delAddr=x.delegation?x.delegation.delegator_address:'';
      return delAddr.startsWith(C().prefix);
    });
    if(!selfDel&&dels.length) selfDel=dels[0];
    if(!selfDel) return null;
    return {
      amount:parseFloat((selfDel.balance||{}).amount||0),
      denom:(selfDel.balance||{}).denom||C().denom,
      delegator:selfDel.delegation?selfDel.delegation.delegator_address:'',
      totalDelegators:dels.length,
      totalTokens:total
    };
  }catch(_){return null}
}

// ── Clear & Cache ────────────────────────────────────────────────────────────
function clearAll(){
  abortAll();
  latestBlock=null;prevBlock=null;prevBlockTs=null;blockTimes=[];tpsHistory=[];priceHistory=[];activityFeed=[];consMap={};
  rollingBlocks=[];rollingTxs=[];lastListedHeight=0;lastTxHeight=0;
  allValidators=[];priceUsd=null;priceChange24h=null;priceFetchedAt=0;signingInfos={};
  Object.keys(BD).forEach(function(k){delete BD[k]});
  Object.keys(TD).forEach(function(k){delete TD[k]});
  Object.keys(VD).forEach(function(k){delete VD[k]});
  Object.keys(PD).forEach(function(k){delete PD[k]});
  crossChainCache={};
  // Reset per-chain capability flags so each chain probes fresh
  caps.supplyByDenom=true;
  caps.distParams=true;
  caps.govParams=true;
  // Apply chain-level static overrides immediately
  if(C().noSupplyDenom) caps.supplyByDenom=false;
  if(C().noDistParams)  caps.distParams=false;
  gasQueryDisabled=!!(C().noTxQuery);
  ibcDenomCache={};

  setHTML('mBlock','<div class="sp"></div>');
  ['mVals','mBonded','mInflation','mPool','mSupply','mTxCount','hBlock','hTps','hBonded','hBlockTime','hPrice'].forEach(function(id){txt(id,'\u2014')});
  ['blockList','txList','dashValList','dashGovList','valPageList','govPageList','blocksPageList','txPageList','supplyVis'].forEach(function(id){setHTML(id,ld('LOADING'))});
  setHTML('btChart','');
}

function hydrateFromCache(){
  try{
    var ci=JSON.parse(localStorage.getItem(cacheKey('chainInfo'))||'null');
    if(ci&&ci.top){
      Object.keys(ci.top).forEach(function(id){
        if(ci.top[id]) txt(id,ci.top[id]);
      });
      setSys('CACHED','warn','hydrated');
    }
  }catch(_){}

  try{
    var b=JSON.parse(localStorage.getItem(cacheKey('blocks'))||'null');
    if(b&&b.blocks&&b.blocks.length){
      rollingBlocks=b.blocks;
      lastListedHeight=b.last||0;
      var rows=rollingBlocks.map(blockRowFull).join('');
      setHTML('blockList',rows);
      setHTML('blocksPageList',rows);
    }
  }catch(_){}

  try{
    var t=JSON.parse(localStorage.getItem(cacheKey('txs'))||'null');
    if(t&&t.txs&&t.txs.length){
      rollingTxs=t.txs;
      var trows=rollingTxs.slice(0,20).map(function(d){
        TD[d.hash]=d;
        return '<div class="row row-tx" tabindex="0" role="button" data-td="'+esc(d.hash)+'">'+
          '<div class="tx-hash">'+esc(trim(d.hash,9,6))+'</div>'+
          '<div><span class="badge '+esc(d.tagClass||'bx')+'">'+esc(d.typeLabel||'UNKNOWN')+'</span>'+(d.ok?'':'<span class="badge br" style="margin-left:4px">FAILED</span>')+'</div>'+
          '<div class="tx-amt '+(d.ok?'c-g':'c-r')+'">'+esc(d.amount||'\u2014')+'</div>'+
          '<div class="tx-time2">'+esc(ago(d.ts))+'</div></div>';
      }).join('');
      setHTML('txList',trows);
      setHTML('txPageList',trows);
    }
  }catch(_){}
}

// ── Chain Switch ─────────────────────────────────────────────────────────────
function switchChain(newChain,name){
  chain=newChain;
  endpointIdx=0;
  txt('netName',name);
  document.querySelectorAll('.dd-option').forEach(function(o){
    o.classList.toggle('active',o.dataset.chain===newChain);
  });
  document.getElementById('netDrop').classList.remove('open');
  document.getElementById('netBtn').setAttribute('aria-expanded','false');
  clearAll();
  hydrateFromCache();
  priceHistory=[]; // clear old sparkline data
  crossChainCache={};
  ibcDenomCache={};  // Feature A — clear denom trace cache on chain switch
  start();
}

// ── Polling Loop ─────────────────────────────────────────────────────────────
var loopTimer=null;

function desiredInterval(){
  var hidden=document.visibilityState==='hidden';
  if(activePage!=='dashboard') return hidden?45000:15000;
  return hidden?30000:6500;
}

async function tick(){
  if(!polling.running) return;
  polling.lastTickAt=Date.now();

  try{
    await fetchBlocksTick();
    if(Date.now()-priceFetchedAt>120000) fetchPrice(); // price every 2 min max
    if(activePage==='dashboard'){
      await Promise.allSettled([fetchChainInfo(),fetchValidators(),fetchGovernance(),fetchSigningInfos()]);
      await fetchTransactionsTick();
    }else if(activePage==='transactions'){
      await fetchTransactionsTick();
    }else if(activePage==='validators'){
      await Promise.allSettled([fetchValidators(),fetchSigningInfos()]);
    }else if(activePage==='governance'){
      await fetchGovernance(activeGovTab);
    }else if(activePage==='ibc'){
      await fetchIBC();
    }else if(activePage==='assets'){
      await fetchAssets();
    }else if(activePage==='params'){
      await fetchParams();
    }
  }catch(_){}

  var wait=Math.max(desiredInterval(),polling.backoffMs||0);
  loopTimer=setTimeout(tick,wait);
}

async function start(){
  stop();
  polling.running=true;
  polling.failStreak=0;
  polling.backoffMs=0;
  setSys('INIT','warn','connecting...');

  try{await detectCapabilities()}catch(_){}
  try{await detectCapabilitiesExtended()}catch(_){}  // Feature E

  fetchPrice(); // fire immediately
  fetchPriceHistory(); // Feature 6 — 7-day sparkline
  fetchCommunityTax(); // Feature 7 — APR calc
  fetchCrossChainStrip(); // Feature 6b — cross-chain strip
  fetchUpgradePlan(); // Feature B2 — upgrade banner
  fetchNodeStatus(); // Feature B — node status panel
  Promise.allSettled([fetchBlocksTick(),fetchChainInfo(),fetchValidators(),fetchGovernance(),fetchSigningInfos(),fetchIBC(),fetchAssets(),fetchParams()])
    .then(function(){return fetchTransactionsTick()})
    .then(function(){updateGasPriceEstimate()}) // Feature G — after blocks loaded
    .catch(function(){});

  loopTimer=setTimeout(tick,1500);
}

function stop(){
  polling.running=false;
  if(loopTimer) clearTimeout(loopTimer);
  loopTimer=null;
}


// ── Chain Overlay (reuses existing dropdown DOM) ─────────────────────────────
var __netDropMount = null;

function ensureChainOverlay(){
  if(document.getElementById('chainOverlay')) return;
  var ov=document.createElement('div');
  ov.id='chainOverlay';
  ov.innerHTML='<div class="co-panel"><div class="co-head"><h3 class="h">Select Network</h3><button type="button" class="co-close" id="coClose">Close</button></div><div id="coBody"></div></div>';
  document.body.appendChild(ov);
  ov.addEventListener('click',function(e){ if(e.target===ov) closeChainOverlay(); });
  document.getElementById('coClose').addEventListener('click',closeChainOverlay);
  document.addEventListener('keydown',function(e){ if(e.key==='Escape') closeChainOverlay(); });
}

function openChainOverlay(){
  ensureChainOverlay();
  var ov=document.getElementById('chainOverlay');
  var body=document.getElementById('coBody');
  var dd=document.getElementById('netDrop');
  if(!dd) return;

  if(!__netDropMount){
    __netDropMount={ parent: dd.parentNode, next: dd.nextSibling };
  }
  // move dropdown into overlay
  body.appendChild(dd);
  dd.classList.add('open');
  ov.classList.add('open');

  // reset & focus filter
  var f=dd.querySelector('.dd-filter');
  if(f){ f.value=''; setTimeout(function(){ f.focus(); f.dispatchEvent(new Event('input')); }, 20); }
  // aria
  var netBtn=document.getElementById('netBtn');
  if(netBtn) netBtn.setAttribute('aria-expanded','true');

    // Auto-close when a chain is selected inside the dropdown (mouse or keyboard)
    try {
      const dd = document.getElementById("netDrop");
      if (dd && !dd.__overlayAutoCloseBound) {
        const handler = (e) => {
          const t = e.target;
          // Chain options in this explorer use .dd-option (and sometimes buttons/anchors inside)
          if (t && (t.closest && t.closest(".dd-option"))) {
            // Let the existing selection handler run first, then close overlay.
            setTimeout(() => { try { closeChainOverlay(); } catch(_) {} }, 0);
          }
        };
        dd.addEventListener("click", handler, true);
        dd.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            const a = document.activeElement;
            if (a && a.closest && a.closest(".dd-option")) {
              setTimeout(() => { try { closeChainOverlay(); } catch(_) {} }, 0);
            }
          }
        }, true);
        dd.__overlayAutoCloseBound = true;
      }
    } catch(_) {}

}

function closeChainOverlay(){
  var ov=document.getElementById('chainOverlay');
  var dd=document.getElementById('netDrop');
  if(dd && __netDropMount && __netDropMount.parent){
    dd.classList.remove('open');
    // move back
    if(__netDropMount.next && __netDropMount.next.parentNode===__netDropMount.parent){
      __netDropMount.parent.insertBefore(dd, __netDropMount.next);
    }else{
      __netDropMount.parent.appendChild(dd);
    }
  }
  if(ov) ov.classList.remove('open');
  var netBtn=document.getElementById('netBtn');
  if(netBtn) netBtn.setAttribute('aria-expanded','false');
}


// ── DOM Wiring ───────────────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded',function(){
  applyTheme(currentTheme);
  buildChainDropdown();
  initStarfield(); // Feature 1 — animated starfield

  document.getElementById('themeBtn').addEventListener('click',toggleTheme);
  document.getElementById('themeBtn').addEventListener('keydown',function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();toggleTheme()}});

  var netBtn=document.getElementById('netBtn');
  netBtn.addEventListener('click',function(e){ e.preventDefault(); e.stopPropagation(); openChainOverlay(); });
  netBtn.addEventListener('keydown',function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();netBtn.click()}});
  document.addEventListener('click',function(){ closeChainOverlay(); });
  document.getElementById('netDrop').addEventListener('click',function(e){
    var opt=e.target.closest('.dd-option');
    if(!opt) return;
    e.stopPropagation();
    switchChain(opt.dataset.chain,opt.dataset.name);
  });

  document.getElementById('searchBtn').addEventListener('click',doSearch);
  document.getElementById('searchInput').addEventListener('keydown',function(e){if(e.key==='Enter')doSearch()});
  document.getElementById('closeSrchBtn').addEventListener('click',closeSearch);
  document.getElementById('closeSrchBtn').addEventListener('keydown',function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();closeSearch()}});

  document.getElementById('navTabs').addEventListener('click',function(e){var tab=e.target.closest('[data-page]');if(tab)goPage(tab.dataset.page)});
  document.getElementById('navTabs').addEventListener('keydown',function(e){var tab=e.target.closest('[data-page]');if(tab&&(e.key==='Enter'||e.key===' ')){e.preventDefault();goPage(tab.dataset.page)}});

  document.addEventListener('click',function(e){
    var gp=e.target.closest('[data-gotopage]');
    if(gp) goPage(gp.dataset.gotopage);
    var cp=e.target.closest('[data-copy]');
    if(cp){var cv=cp.dataset.copy;if(cv&&navigator.clipboard){navigator.clipboard.writeText(cv).then(function(){var orig=cp.textContent;cp.textContent='COPIED!';setTimeout(function(){cp.textContent=orig},1200)})}}
    var bd=e.target.closest('[data-bd]');
    if(bd&&BD[bd.dataset.bd]) showBlockModal(BD[bd.dataset.bd]);
    var td=e.target.closest('[data-td]');
    if(td&&TD[td.dataset.td]) showTxModal(TD[td.dataset.td]);
    var vd=e.target.closest('[data-vd]');
    if(vd&&VD[vd.dataset.vd]) showValModal(VD[vd.dataset.vd]);
    var pd=e.target.closest('[data-pd]');
    if(pd&&PD[pd.dataset.pd]) showPropModal(PD[pd.dataset.pd]);
    var cc=e.target.closest('[data-ccchain]');
    if(cc&&CHAINS[cc.dataset.ccchain]){switchChain(cc.dataset.ccchain,CHAINS[cc.dataset.ccchain].name);goPage('dashboard')}
    var fc=e.target.closest('.footer-chain-chip[data-chain]');
    if(fc&&CHAINS[fc.dataset.chain]){switchChain(fc.dataset.chain,CHAINS[fc.dataset.chain].name);goPage('dashboard')}
  });

  // keydown handled by Feature 11 keyboard shortcuts system above

  document.getElementById('page-validators').addEventListener('click',function(e){
    var tab=e.target.closest('[data-vtab]');
    if(!tab) return;
    activeValTab=tab.dataset.vtab;
    document.querySelectorAll('[data-vtab]').forEach(function(t){t.classList.toggle('active',t.dataset.vtab===activeValTab)});
    setHTML('valPageList',ld('LOADING'));
    fetchValidators();
  });

  document.getElementById('page-governance').addEventListener('click',function(e){
    var tab=e.target.closest('[data-gtab]');
    if(!tab) return;
    activeGovTab=tab.dataset.gtab;
    document.querySelectorAll('[data-gtab]').forEach(function(t){t.classList.toggle('active',t.dataset.gtab===activeGovTab)});
    setHTML('govPageList',ld('LOADING'));
    fetchGovernance(activeGovTab);
  });

  document.getElementById('modalX').addEventListener('click',closeModal);
  document.getElementById('modalX').addEventListener('keydown',function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();closeModal()}});
  document.getElementById('modalBg').addEventListener('click',function(e){if(e.target===this)closeModal()});

    document.addEventListener('visibilitychange',function(){
    if(!polling.running) return;
    if(document.visibilityState==='visible'){
      if(loopTimer){clearTimeout(loopTimer);loopTimer=setTimeout(tick,500)}
    }
  });

  // ── Feature 9: TX Filter Tabs ─────────────────────────────────────────────
  document.getElementById('page-transactions').addEventListener('click',function(e){
    var tab=e.target.closest('[data-txf]');
    if(!tab) return;
    activeTxFilter=tab.dataset.txf;
    document.querySelectorAll('[data-txf]').forEach(function(t){
      t.classList.toggle('active',t.dataset.txf===activeTxFilter);
    });
    applyTxFilter();
  });

  // ── Feature 11: ? button ──────────────────────────────────────────────────
  document.getElementById('kbdBtn').addEventListener('click',function(){toggleKbdHud()});
  document.getElementById('kbdHud').addEventListener('click',function(e){
    if(e.target===this) toggleKbdHud(false);
  });

  // ── Feature 11: Keyboard shortcuts (separate handler, runs before other keydown) ─
  document.addEventListener('keydown',function(e){
    var tag=(e.target.tagName||'').toLowerCase();
    var inInput=tag==='input'||tag==='textarea'||e.target.isContentEditable;
    if(e.key==='?'&&!inInput){e.preventDefault();toggleKbdHud();return}
    if(e.key==='Escape'){
      if(kbdHudOpen){e.preventDefault();toggleKbdHud(false);return}
      closeModal();return;
    }
    if(inInput) return;
    if(e.key==='/'){e.preventDefault();var si=document.getElementById('searchInput');if(si){si.focus();si.select()}return}
    var pageIdx=parseInt(e.key)-1;
    if(!isNaN(pageIdx)&&pageIdx>=0&&pageIdx<PAGE_KEYS.length){e.preventDefault();goPage(PAGE_KEYS[pageIdx]);return}
    if(e.key==='c'||e.key==='C'){
      var f2=document.activeElement;
      if(f2&&f2.dataset&&f2.dataset.copy){
        e.preventDefault();
        navigator.clipboard&&navigator.clipboard.writeText(f2.dataset.copy).then(function(){
          var orig=f2.textContent;f2.textContent='COPIED!';
          setTimeout(function(){f2.textContent=orig},1200);
        });
      }
    }
    if(e.key==='Enter'){
      var bd2=e.target.closest('[data-bd]');
      if(bd2&&BD[bd2.dataset.bd]){e.preventDefault();showBlockModal(BD[bd2.dataset.bd]);return}
      var td2=e.target.closest('[data-td]');
      if(td2&&TD[td2.dataset.td]){e.preventDefault();showTxModal(TD[td2.dataset.td]);return}
      var vd2=e.target.closest('[data-vd]');
      if(vd2&&VD[vd2.dataset.vd]){e.preventDefault();showValModal(VD[vd2.dataset.vd]);return}
      var pd2=e.target.closest('[data-pd]');
      if(pd2&&PD[pd2.dataset.pd]){e.preventDefault();showPropModal(PD[pd2.dataset.pd]);return}
      var cp2=e.target.closest('[data-copy]');
      if(cp2){e.preventDefault();cp2.click()}
    }
  });

  // ── Feature 14: CSV Export ────────────────────────────────────────────────
  var exportBtn=document.getElementById('valExportBtn');
  if(exportBtn) exportBtn.addEventListener('click',exportValidatorsCSV);

  // ── Feature C: Vote load-more ─────────────────────────────────────────────
  document.addEventListener('click',function(e){
    var lm=e.target.closest('#voteLoadMore');
    if(lm){
      var pid2=lm.dataset.pid;
      var key=lm.dataset.key;
      if(!pid2) return;
      lm.textContent='LOADING…';
      loadPropVotes(pid2,key).then(function(res){
        var container=document.getElementById('propVotesList');
        if(!container) return;
        lm.remove();
        var frag=document.createElement('div');
        frag.innerHTML=renderVoteRows(res.votes);
        container.appendChild(frag);
        if(res.nextKey){
          var more=document.createElement('div');
          more.className='votes-load-more';
          more.id='voteLoadMore';
          more.dataset.pid=pid2;
          more.dataset.key=res.nextKey;
          more.textContent='LOAD MORE VOTES ↓';
          container.appendChild(more);
        }
      });
    }
  });

  window.addEventListener('hashchange',applyRoute);

  hydrateFromCache();
  applyRoute();
  start();
});
</script>

<div id="kbdHud" role="dialog" aria-modal="true" aria-label="Keyboard shortcuts">
  <div id="kbdHudBox">
    <h2>KEYBOARD SHORTCUTS</h2>
    <div class="kbd-section"><div class="kbd-section-title">Navigation</div>
      <div class="kbd-row"><span class="kbd-key">1</span><span class="kbd-desc">Dashboard</span></div>
      <div class="kbd-row"><span class="kbd-key">2</span><span class="kbd-desc">Blocks</span></div>
      <div class="kbd-row"><span class="kbd-key">3</span><span class="kbd-desc">Transactions</span></div>
      <div class="kbd-row"><span class="kbd-key">4</span><span class="kbd-desc">Validators</span></div>
      <div class="kbd-row"><span class="kbd-key">5</span><span class="kbd-desc">Governance</span></div>
      <div class="kbd-row"><span class="kbd-key">6</span><span class="kbd-desc">IBC</span></div>
      <div class="kbd-row"><span class="kbd-key">7</span><span class="kbd-desc">Assets</span></div>
      <div class="kbd-row"><span class="kbd-key">8</span><span class="kbd-desc">Parameters</span></div>
    </div>
    <div class="kbd-section"><div class="kbd-section-title">Actions</div>
      <div class="kbd-row"><span class="kbd-key">/</span><span class="kbd-desc">Focus search bar</span></div>
      <div class="kbd-row"><span class="kbd-key">?</span><span class="kbd-desc">Toggle this panel</span></div>
      <div class="kbd-row"><span class="kbd-key">Esc</span><span class="kbd-desc">Close modal / panel</span></div>
      <div class="kbd-row"><span class="kbd-key">C</span><span class="kbd-desc">Copy focused hash</span></div>
      <div class="kbd-row"><span class="kbd-key">Enter</span><span class="kbd-desc">Open focused row</span></div>
    </div>
    <p class="kbd-close-hint">Press <span class="kbd-key">Esc</span> or <span class="kbd-key">?</span> to close</p>
  </div>
</div>
</body>
</html>